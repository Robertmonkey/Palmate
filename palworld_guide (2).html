<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Palworld Interactive Guide</title>
    <!-- Import Google Fonts for a modern, friendly typeface -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <!-- Include Chart.js for visualisations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Removed PapaParse since data is loaded from a local JSON file -->
    <style>
        /* Global reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: #0b132b;
            color: #edf2f4;
            line-height: 1.5;
        }
        a {
            color: inherit;
            text-decoration: none;
        }
        h1, h2, h3 {
            font-weight: 600;
        }
        /* Header section */
        header {
            background: linear-gradient(to right, rgba(20, 33, 61, 0.9), rgba(4, 58, 75, 0.9)), url('https://www.siliconera.com/wp-content/uploads/2024/01/palworld-full-map-2.jpg');
            background-size: cover;
            background-position: center;
            color: #fff;
            padding: 80px 20px;
            text-align: center;
            position: relative;
        }
        header::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.55);
        }
        header > .content {
            position: relative;
            z-index: 1;
            max-width: 800px;
            margin: 0 auto;
        }
        header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        header p {
            font-size: 1.1rem;
            opacity: 0.85;
        }
        /* Navigation bar */
        nav {
            background: #1c2541;
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        nav .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00a896;
        }
        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
        }
        nav ul li a {
            font-weight: 500;
            transition: color 0.2s;
        }
        nav ul li a:hover {
            color: #00a896;
        }
        /* Section base styling */
        section {
            padding: 60px 20px;
        }
        .section-title {
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            color: #e0fbfc;
        }
        /* Search/filter styles */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .filters input,
        .filters select {
            padding: 8px 10px;
            border: none;
            border-radius: 4px;
            background: #274156;
            color: #edf2f4;
            font-size: 0.9rem;
        }
        .filters input::placeholder {
            color: #a3bde3;
        }
        /* Pal card grid */
        #pal-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .pal-card {
            background: #1c2541;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }
        .pal-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .pal-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            background: #274156;
        }
        .pal-card .pal-info {
            padding: 10px;
        }
        .pal-card .pal-info h4 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        .pal-card .pal-info .types {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .type-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: capitalize;
            color: #fff;
        }
        /* Modal styles */
        #pal-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #pal-modal .modal-content {
            background: #1c2541;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #pal-modal .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #edf2f4;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
        }
        .modal-header img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            background: #274156;
            border-radius: 8px;
        }
        .modal-header .meta {
            flex: 1;
        }
        .modal-header .meta h2 {
            margin-bottom: 6px;
        }
        .stats-table,
        .skills-table,
        .drops-list {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        .stats-table th, .stats-table td,
        .skills-table th, .skills-table td {
            padding: 6px;
            text-align: left;
        }
        .stats-table th {
            color: #00b8d9;
        }
        .skills-table th {
            color: #e6b800;
        }
        .drops-list {
            list-style: none;
            padding-left: 0;
        }
        .drops-list li {
            padding: 4px 0;
        }
        .work-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        .work-item {
            background: #274156;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        /* Breeding calculator */
        #breeding {
            background: #1c2541;
            border-radius: 8px;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #breeding select {
            padding: 8px 10px;
            border: none;
            border-radius: 4px;
            background: #274156;
            color: #edf2f4;
            margin-bottom: 10px;
            width: 100%;
        }
        #breeding-result {
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        #breeding-result .child-card {
            background: #274156;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            width: 200px;
        }
        #breeding-result .child-card img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            background: #1c2541;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        /* Environment map section */
        #map-section {
            text-align: center;
        }
        #map-container {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
        }
        #map-container img {
            width: 100%;
            border-radius: 8px;
        }
        .env-marker {
            position: absolute;
            width: 28px;
            height: 28px;
            background: #00a896;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1c2541;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .env-marker:hover {
            transform: scale(1.2);
        }
        .environment-list {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .environment-item {
            background: #274156;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .environment-item.active,
        .environment-item:hover {
            background: #00a896;
            color: #1c2541;
        }
        .environment-details {
            margin-top: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            background: #1c2541;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }
        .environment-details h3 {
            margin-bottom: 10px;
        }
        .environment-details ul {
            list-style: none;
            padding-left: 0;
            columns: 2;
        }
        .environment-details ul li {
            padding: 4px 0;
        }

        /* Items list styles */
        #item-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .item-card {
            background: #1c2541;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .item-card h4 {
            margin-bottom: 6px;
        }
        .item-card .sources {
            font-size: 0.85rem;
            color: #a3bde3;
        }
        .item-card .category {
            display: inline-block;
            padding: 2px 6px;
            margin-top: 4px;
            border-radius: 4px;
            background: #00a896;
            color: #1c2541;
            font-size: 0.7rem;
        }
        /* About section */
        #about p {
            max-width: 800px;
            margin: 0 auto 10px;
            opacity: 0.9;
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            header h1 {
                font-size: 2rem;
            }
            #breeding-result {
                flex-direction: column;
            }
            .environment-details ul {
                columns: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="logo">Palworld Guide</div>
        <ul>
            <li><a href="#pals">Pals</a></li>
            <li><a href="#items">Items</a></li>
            <li><a href="#breeding">Breeding</a></li>
            <li><a href="#map">Map</a></li>
            <li><a href="#about">About</a></li>
        </ul>
    </nav>
    <!-- Hero Section -->
    <header>
        <div class="content">
            <h1>Your Ultimate Palworld Companion</h1>
            <p>Discover every Pal, explore their abilities and stats, calculate breeding results, and explore the world of Palworld with an interactive map.</p>
        </div>
    </header>
    <!-- Pals Section -->
    <section id="pals">
        <h2 class="section-title">Pal Compendium</h2>
        <div id="error-message" style="text-align:center;color:#e63946;margin-bottom:10px;"></div>
        <div class="filters">
            <input type="text" id="search-input" placeholder="Search by name..." />
            <select id="type-filter">
                <option value="all">All Types</option>
            </select>
            <select id="rarity-filter">
                <option value="all">All Rarities</option>
                <option value="1">★</option>
                <option value="2">★★</option>
                <option value="3">★★★</option>
                <option value="4">★★★★</option>
                <option value="5">★★★★★</option>
            </select>
            <select id="sort-filter">
                <option value="name">Sort: Name</option>
                <option value="hp">HP</option>
                <option value="attack">Attack</option>
                <option value="defense">Defense</option>
                <option value="speed">Speed</option>
                <option value="stamina">Stamina</option>
                <option value="support">Support</option>
                <option value="food">Food</option>
            </select>
        </div>
        <div id="pal-list"></div>
    </section>
    <!-- Items Section -->
    <section id="items">
        <h2 class="section-title">Items & Materials</h2>
        <div class="filters">
            <input type="text" id="item-search-input" placeholder="Search items..." />
        </div>
        <div id="item-list"></div>
    </section>
    <!-- Modal for Pal Details -->
    <div id="pal-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <img id="modal-img" src="" alt="Pal image" />
                <div class="meta">
                    <h2 id="modal-name"></h2>
                    <p id="modal-types"></p>
                    <p id="modal-genus"></p>
                    <p id="modal-rarity"></p>
                </div>
            </div>
            <canvas id="stats-chart" width="400" height="300"></canvas>
            <h3>Stats</h3>
            <table class="stats-table" id="stats-table"></table>
            <h3>Work Suitability</h3>
            <div class="work-list" id="work-list"></div>
            <h3>Active Skills</h3>
            <table class="skills-table" id="skills-table"></table>
            <h3>Item Drops</h3>
            <ul class="drops-list" id="drops-list"></ul>
            <div style="margin-top:10px;">
                <a id="wiki-link" href="#" target="_blank" style="color:#00a896;">View on Wiki</a>
            </div>
        </div>
    </div>
    <!-- Breeding Calculator Section -->
    <section id="breeding">
        <h2 class="section-title">Breeding Calculator</h2>
        <select id="parent1-select"></select>
        <select id="parent2-select"></select>
        <div id="breeding-result"></div>
    </section>
    <!-- Interactive Map Section -->
    <section id="map">
        <h2 class="section-title">World Map & Environments</h2>
        <div id="map-container">
            <img src="https://www.siliconera.com/wp-content/uploads/2024/01/palworld-full-map-2.jpg" alt="Palworld map" />
            <!-- Markers will be inserted via JS -->
        </div>
        <div class="environment-list" id="env-list"></div>
        <div class="environment-details" id="env-details"></div>
    </section>
    <!-- About Section -->
    <section id="about">
        <h2 class="section-title">About This Guide</h2>
        <p>Palworld is a sprawling world inhabited by mysterious creatures called Pals. Each Pal possesses unique abilities, stats and work skills that make them invaluable companions both in battle and at your base.  This guide keeps all of the Pal data inside a small file that sits next to this webpage, so it continues to work even when you are offline.  It assembles names, stats, work abilities, item drops and breeding information from a community-maintained dataset【497589920752296†L0-L41】【744344374365692†L0-L44】 into an easy‑to‑browse compendium.</p>
        <p>Work suitabilities describe tasks a Pal can perform at your base, such as <strong>handiwork</strong>, <strong>transporting</strong> or <strong>planting</strong>.  Stats like HP and Attack show how tough a Pal is, while Support and Food values hint at how well they help around your base.  Breeding lets you pair two Pals to make an egg; the real game uses a complex formula to decide the baby, but this guide uses a simple average of their breeding power to teach the concept.</p>
        <p>The technology tree in Palworld is made up of blueprints split between regular technology and ancient technology; you earn Technology Points as you level up, explore and defeat bosses【244278054674625†L230-L247】.  The <em>Items</em> section lists common materials and food dropped by Pals and shows a rough category (Food, Material, etc.) so you know what to collect.  When you open a Pal, the map also highlights the kind of environment where that Pal usually lives to help you plan where to explore.</p>
    </section>
    <!-- Audio for UI feedback -->
    <audio id="click-sound" src="https://upload.wikimedia.org/wikipedia/commons/5/5c/Click.wav"></audio>
    <script>
        // Data containers
        const pals = {};
        let palList = [];
        let chartInstance;
        const itemsMap = {};

        // Environment mapping based on types
        const typeEnvironment = {
            Fire: 'Volcano',
            Ice: 'Snow',
            Water: 'Coast',
            Electric: 'Mountains',
            Grass: 'Forest',
            Earth: 'Forest',
            Ground: 'Forest',
            Neutral: 'Plains',
            Dark: 'Swamp',
            Dragon: 'Islands',
            Air: 'Plains'
        };

        // Assign colours for type badges
        const typeColors = {
            Fire: '#f35e51',
            Ice: '#70c1ff',
            Water: '#50c4e7',
            Electric: '#ffda79',
            Grass: '#64d58c',
            Earth: '#a68b5b',
            Ground: '#a68b5b',
            Neutral: '#8faaff',
            Dark: '#9b59b6',
            Dragon: '#e67e22',
            Air: '#85c1e9'
        };

        // Fetch all CSV files and build the pal data
        async function fetchData() {
            // Load data from local JSON file in the same directory.  This avoids any remote requests
            try {
                const response = await fetch('palworld_data_light.json');
                if (!response.ok) throw new Error('File missing');
                const dataset = await response.json();
                // Populate pals object.  Derive environment and convert drops arrays to keyed objects
                Object.values(dataset.pals).forEach(pal => {
                    const copy = JSON.parse(JSON.stringify(pal));
                    const pType = Array.isArray(copy.types) && copy.types.length > 0 ? copy.types[0] : 'Neutral';
                    copy.environment = typeEnvironment[pType] || 'Plains';
                    if (Array.isArray(copy.drops)) {
                        const dropObj = {};
                        copy.drops.forEach(item => { dropObj[item] = 1; });
                        copy.drops = dropObj;
                    }
                    pals[copy.id] = copy;
                });
                // Copy item categories from dataset.  Source lists will be created by buildItemIndex
                Object.assign(itemsMap, dataset.items);
                palList = Object.values(pals);
                // Render the UI
                renderPalList();
                buildItemIndex();
                renderItemList();
                renderEnvironmentList();
            } catch (err) {
                document.getElementById('error-message').textContent = 'Failed to load Pal data. Please ensure \u201cpalworld_data_light.json\u201d is saved in the same folder as this guide.';
                console.error(err);
            }
            // Merge stats
            stats.forEach(row => {
                const id = row.id.trim();
                if (pals[id]) {
                    pals[id].stats = {
                        hp: parseFloat(row.hp) || 0,
                        attack: parseFloat(row.attack) || 0,
                        defense: parseFloat(row.defense) || 0,
                        speed: parseFloat(row.speed) || 0,
                        stamina: parseFloat(row.stamina) || 0,
                        support: parseFloat(row.support) || 0,
                        food: parseFloat(row.food) || 0
                    };
                }
            });
            // Merge work suitabilities
            suit.forEach(row => {
                const id = row.id.trim();
                if (pals[id]) {
                    Object.keys(row).forEach(key => {
                        if (key !== 'id' && row[key]) {
                            pals[id].work[key] = parseInt(row[key]);
                        }
                    });
                }
            });
            // Merge skills
            skills.forEach(row => {
                const id = row.id.trim();
                if (pals[id]) {
                    const list = [];
                    for (let i = 1; i <= 7; i++) {
                        const name = row[`name${i}`];
                        const level = row[`lvl${i}`];
                        const power = row[`power${i}`];
                        const cooldown = row[`cooldown${i}`];
                        if (name) {
                            list.push({
                                name: name,
                                level: level ? parseInt(level) : null,
                                power: power ? parseInt(power) : null,
                                cooldown: cooldown ? parseFloat(cooldown) : null
                            });
                        }
                    }
                    pals[id].skills = list;
                }
            });
            // Merge drops
            drops.forEach(row => {
                const id = row.id.trim();
                if (pals[id]) {
                    const dropList = {};
                    for (let i = 1; i <= 8; i++) {
                        const item = row[`item${i}`];
                        const amount = row[`amount${i}`];
                        if (item) {
                            dropList[item] = amount ? parseInt(amount) : null;
                        }
                    }
                    pals[id].drops = dropList;
                }
            });
            // Merge breeding
            breeding.forEach(row => {
                const id = row.id.trim();
                if (pals[id]) {
                    pals[id].breeding = {
                        power: row.breeding_power ? parseInt(row.breeding_power) : null,
                        type1: row.breed_type1,
                        type2: row.breed_type2,
                        note: row.note
                    };
                    // assign types to main array
                    const types = [];
                    if (row.breed_type1 && row.breed_type1 !== '') types.push(row.breed_type1);
                    if (row.breed_type2 && row.breed_type2 !== '' && row.breed_type2 !== row.breed_type1) types.push(row.breed_type2);
                    pals[id].types = types;
                    // assign environment based on first type
                    const env = types.length ? (typeEnvironment[types[0]] || 'Plains') : 'Plains';
                    pals[id].environment = env;
                }
            });
            // Convert pals object to array for easier iteration
            palList = Object.values(pals);
            // Populate type filter options
            populateTypeOptions();
            // Populate parent selectors for breeding
            populateBreedingSelectors();
            // Render the pal list initially
            renderPalList();
            // Render environment list
            renderEnvironmentList();
            // Build item index
            buildItemIndex();
            renderItemList();
        }

        function populateTypeOptions() {
            const typeFilter = document.getElementById('type-filter');
            const types = new Set();
            palList.forEach(pal => {
                pal.types.forEach(t => types.add(t));
            });
            Array.from(types).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });
        }

        function populateBreedingSelectors() {
            const parent1 = document.getElementById('parent1-select');
            const parent2 = document.getElementById('parent2-select');
            palList.forEach(pal => {
                const opt1 = document.createElement('option');
                opt1.value = pal.id;
                opt1.textContent = pal.name;
                parent1.appendChild(opt1);
                const opt2 = opt1.cloneNode(true);
                parent2.appendChild(opt2);
            });
            // Default selection
            parent1.selectedIndex = 0;
            parent2.selectedIndex = 1;
            // Add change listeners
            parent1.addEventListener('change', computeBreeding);
            parent2.addEventListener('change', computeBreeding);
            computeBreeding();
        }

        function computeBreeding() {
            const p1 = pals[document.getElementById('parent1-select').value];
            const p2 = pals[document.getElementById('parent2-select').value];
            if (!p1 || !p2) return;
            const resultContainer = document.getElementById('breeding-result');
            resultContainer.innerHTML = '';
            // Approximate child by averaging breeding power
            const avg = Math.round(((p1.breeding.power || 0) + (p2.breeding.power || 0)) / 2);
            // Find pal with nearest breeding power
            let child = null;
            let minDiff = Infinity;
            palList.forEach(pal => {
                if (pal.breeding.power != null) {
                    const diff = Math.abs(pal.breeding.power - avg);
                    if (diff < minDiff) {
                        minDiff = diff;
                        child = pal;
                    }
                }
            });
            if (child) {
                const card = document.createElement('div');
                card.className = 'child-card';
                card.innerHTML = `
                    <img src="${child.image}" alt="${child.name}">
                    <h4>${child.name}</h4>
                    <p>${child.types.join(' / ')}</p>
                `;
                card.addEventListener('click', () => openModal(child.id));
                resultContainer.appendChild(card);
            }
            // Play click sound
            document.getElementById('click-sound').play();
        }

        // Render the list of pals based on search and filters
        function renderPalList() {
            const listContainer = document.getElementById('pal-list');
            listContainer.innerHTML = '';
            const searchValue = document.getElementById('search-input').value.toLowerCase();
            const typeValue = document.getElementById('type-filter').value;
            const rarityValue = document.getElementById('rarity-filter').value;
            let filtered = palList.filter(pal => {
                let match = true;
                if (searchValue && !pal.name.toLowerCase().includes(searchValue)) {
                    match = false;
                }
                if (typeValue !== 'all' && !pal.types.includes(typeValue)) {
                    match = false;
                }
                if (rarityValue !== 'all') {
                    match = pal.rarity == rarityValue;
                }
                return match;
            });
            // Sort based on selected sort value
            const sortValue = document.getElementById('sort-filter').value;
            filtered = filtered.sort((a,b) => {
                if (sortValue === 'name') return a.name.localeCompare(b.name);
                return (b.stats[sortValue] || 0) - (a.stats[sortValue] || 0);
            });
            filtered.forEach(pal => {
                const card = document.createElement('div');
                card.className = 'pal-card';
                card.innerHTML = `
                    <img src="${pal.image}" alt="${pal.name}" />
                    <div class="pal-info">
                        <h4>${pal.name}</h4>
                        <div class="types">
                            ${pal.types.map(t => `<span class="type-badge" style="background:${typeColors[t] || '#666'}">${t}</span>`).join(' ')}
                        </div>
                    </div>`;
                card.addEventListener('click', () => openModal(pal.id));
                listContainer.appendChild(card);
            });
        }

        // Modal functions
        function openModal(palId) {
            const pal = pals[palId];
            if (!pal) return;
            document.getElementById('modal-img').src = pal.image;
            document.getElementById('modal-name').textContent = pal.name;
            document.getElementById('modal-types').innerHTML = pal.types.map(t => `<span class="type-badge" style="background:${typeColors[t] || '#666'}">${t}</span>`).join(' ');
            document.getElementById('modal-genus').textContent = pal.genus ? `Genus: ${pal.genus}` : '';
            document.getElementById('modal-rarity').textContent = pal.rarity ? `Rarity: ${'★'.repeat(pal.rarity)}` : '';
            // Stats table
            const statsTable = document.getElementById('stats-table');
            statsTable.innerHTML = '';
            const stats = pal.stats;
            for (const key of ['hp','attack','defense','speed','stamina','support','food']) {
                const row = document.createElement('tr');
                row.innerHTML = `<th>${key.toUpperCase()}</th><td>${stats[key]}</td>`;
                statsTable.appendChild(row);
            }
            // Work list
            const workList = document.getElementById('work-list');
            workList.innerHTML = '';
            Object.entries(pal.work).forEach(([k,v]) => {
                const item = document.createElement('span');
                item.className = 'work-item';
                item.textContent = `${k} Lv.${v}`;
                workList.appendChild(item);
            });
            // Skills table
            const skillsTable = document.getElementById('skills-table');
            skillsTable.innerHTML = '';
            const header = document.createElement('tr');
            header.innerHTML = '<th>Name</th><th>Lvl</th><th>Power</th><th>Cooldown</th>';
            skillsTable.appendChild(header);
            pal.skills.forEach(s => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${s.name}</td><td>${s.level ?? ''}</td><td>${s.power ?? ''}</td><td>${s.cooldown ?? ''}</td>`;
                skillsTable.appendChild(row);
            });
            // Drops list
            const dropsList = document.getElementById('drops-list');
            dropsList.innerHTML = '';
            const drops = pal.drops;
            Object.entries(drops).forEach(([item, amt]) => {
                const li = document.createElement('li');
                li.textContent = `${item}${amt ? ' x'+amt : ''}`;
                dropsList.appendChild(li);
            });
            // Wiki link
            const wikiLink = document.getElementById('wiki-link');
            wikiLink.href = pal.wiki;
            // Stats chart
            const ctx = document.getElementById('stats-chart').getContext('2d');
            const data = {
                labels: ['HP','Attack','Defense','Speed','Stamina','Support','Food'],
                datasets: [{
                    label: pal.name,
                    data: [stats.hp, stats.attack, stats.defense, stats.speed, stats.stamina, stats.support, stats.food],
                    backgroundColor: 'rgba(0, 168, 150, 0.2)',
                    borderColor: '#00a896',
                    borderWidth: 2,
                    pointBackgroundColor: '#00a896'
                }]
            };
            const options = {
                scales: {
                    r: {
                        angleLines: { color: '#274156' },
                        grid: { color: '#274156' },
                        pointLabels: { color: '#edf2f4' },
                        ticks: {
                            backdropColor: 'transparent',
                            color: '#a3bde3'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#edf2f4' }
                    }
                }
            };
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'radar', data, options });
            // Show modal
            document.getElementById('pal-modal').style.display = 'flex';
            // Play click sound
            document.getElementById('click-sound').play();

            // Highlight pal's environment on the map
            showEnvironment(pal.environment, palList.filter(p => p.environment === pal.environment));
        }

        function closeModal() {
            document.getElementById('pal-modal').style.display = 'none';
        }

        // Environment map functions
        function renderEnvironmentList() {
            const envList = document.getElementById('env-list');
            const envTypes = {};
            palList.forEach(pal => {
                envTypes[pal.environment] = (envTypes[pal.environment] || []);
                envTypes[pal.environment].push(pal);
            });
            // Render markers on map
            const mapContainer = document.getElementById('map-container');
            const mapRect = mapContainer.getBoundingClientRect();
            // Predefined marker positions relative to the map container (percentage values)
            const positions = {
                'Volcano': { left: '15%', top: '70%' },
                'Snow': { left: '20%', top: '10%' },
                'Coast': { left: '80%', top: '60%' },
                'Mountains': { left: '60%', top: '20%' },
                'Forest': { left: '45%', top: '50%' },
                'Plains': { left: '55%', top: '40%' },
                'Swamp': { left: '30%', top: '55%' },
                'Islands': { left: '85%', top: '85%' }
            };
            Object.entries(envTypes).forEach(([env, pals]) => {
                // Create list item
                const item = document.createElement('div');
                item.className = 'environment-item';
                item.textContent = `${env} (${pals.length})`;
                item.addEventListener('click', () => showEnvironment(env, pals));
                envList.appendChild(item);
                // Create marker on map
                const pos = positions[env] || { left: '50%', top: '50%' };
                const marker = document.createElement('div');
                marker.className = 'env-marker';
                marker.style.left = pos.left;
                marker.style.top = pos.top;
                marker.textContent = pals.length;
                marker.title = env;
                marker.addEventListener('click', () => showEnvironment(env, pals));
                mapContainer.appendChild(marker);
            });
        }

        function showEnvironment(env, palsInEnv) {
            // Highlight selected environment item
            document.querySelectorAll('.environment-item').forEach(item => {
                if (item.textContent.startsWith(env)) item.classList.add('active');
                else item.classList.remove('active');
            });
            // Build details panel
            const details = document.getElementById('env-details');
            details.style.display = 'block';
            details.innerHTML = `<h3>${env} Environment</h3><ul>${palsInEnv.map(p => `<li>${p.name}</li>`).join('')}</ul>`;
            // Scroll into view if off screen
            details.scrollIntoView({ behavior: 'smooth' });
        }

        // Build item index from drops
        function buildItemIndex() {
            Object.values(pals).forEach(pal => {
                Object.entries(pal.drops).forEach(([item, amt]) => {
                    if (!itemsMap[item]) itemsMap[item] = { sources: [], category: classifyItem(item) };
                    itemsMap[item].sources.push({ pal: pal.name, amount: amt });
                });
            });
        }
        // Heuristic to classify item categories
        function classifyItem(item) {
            const name = item.toLowerCase();
            if (/meat|mutton|liver|steak|egg|milk/.test(name)) return 'Food';
            if (/ore|ingot|polymer|fragment|stone|bone|tooth|horn|claw|shell|pearl/.test(name)) return 'Material';
            if (/cloth|leather|fur|wool|feather/.test(name)) return 'Crafting';
            if (/berry|mushroom|fruit|flower|honey/.test(name)) return 'Produce';
            return 'Misc';
        }
        // Render item list with optional search
        function renderItemList() {
            const itemContainer = document.getElementById('item-list');
            itemContainer.innerHTML = '';
            const query = document.getElementById('item-search-input').value.toLowerCase();
            const items = Object.keys(itemsMap).filter(item => !query || item.toLowerCase().includes(query)).sort();
            items.forEach(itemName => {
                const data = itemsMap[itemName];
                const card = document.createElement('div');
                card.className = 'item-card';
                const sourcesText = data.sources.map(s => `${s.pal}${s.amount ? ' x'+s.amount : ''}`).join(', ');
                card.innerHTML = `<h4>${itemName}</h4><div class="sources">Dropped by: ${sourcesText}</div><span class="category">${data.category}</span>`;
                itemContainer.appendChild(card);
            });
        }

        // Event listeners for search and filter
        document.getElementById('search-input').addEventListener('input', () => {
            renderPalList();
        });
        document.getElementById('type-filter').addEventListener('change', () => {
            renderPalList();
        });
        document.getElementById('rarity-filter').addEventListener('change', () => {
            renderPalList();
        });
        document.getElementById('sort-filter').addEventListener('change', () => {
            renderPalList();
        });
        document.getElementById('item-search-input').addEventListener('input', () => {
            renderItemList();
        });

        // Initial data fetch when page loads
        fetchData();
    </script>
</body>
</html>