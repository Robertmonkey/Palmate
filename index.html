      gap: clamp(12px, 2vw, 24px);
      font-size: clamp(1.4rem, 2.2vw, 1.85rem);
      text-shadow: 0 6px 26px rgba(0, 0, 0, 0.5);
      background: linear-gradient(135deg, rgba(105, 228, 166, 0.24), rgba(42, 157, 143, 0.16));
      box-shadow: 0 16px 38px rgba(6, 22, 28, 0.55);
      --element-spotlight: rgba(105, 228, 166, 0.18);
      --element-surface-start: rgba(10, 24, 40, 0.9);
      --element-surface-end: rgba(6, 14, 26, 0.95);
      --element-border: rgba(148, 210, 189, 0.22);
      --element-shadow: rgba(3, 12, 24, 0.55);
      --element-panel-start: rgba(8, 16, 28, 0.82);
      --element-panel-end: rgba(12, 24, 40, 0.92);
      --element-panel-border: rgba(119, 141, 169, 0.35);
      --element-panel-glow: rgba(224, 225, 221, 0.08);
      --element-pill: rgba(119, 141, 169, 0.22);
      --element-pill-border: rgba(119, 141, 169, 0.45);
      --element-on: rgba(105, 228, 166, 0.24);
      --element-off: rgba(231, 111, 81, 0.24);
      --element-neutral: rgba(119, 141, 169, 0.22);
      position: relative;
      gap: clamp(16px, 2vw, 24px);
      border-radius: 26px;
      padding: clamp(20px, 2.4vw, 28px);
        radial-gradient(circle at 12% -6%, var(--element-spotlight), transparent 55%),
        radial-gradient(circle at 82% 8%, rgba(119, 141, 169, 0.2), transparent 60%),
        linear-gradient(160deg, var(--element-surface-start), var(--element-surface-end));
      border: 1px solid var(--element-border);
      box-shadow: 0 30px 64px var(--element-shadow);
      backdrop-filter: saturate(135%) blur(6px);
      background: linear-gradient(150deg, rgba(224, 255, 244, 0.2), rgba(224, 255, 244, 0));
      opacity: 0.35;
      flex-direction: column;
      gap: 10px;
      font-size: clamp(1.15rem, 2vw, 1.35rem);
      margin: 0;
      font-size: 0.9rem;
      color: rgba(224, 225, 221, 0.8);
      gap: 6px;
      width: max-content;
      padding: 6px 16px;
      font-weight: 700;
      letter-spacing: 0.12em;
      background: rgba(12, 26, 44, 0.6);
      border: 1px solid rgba(224, 255, 244, 0.22);
      color: rgba(224, 255, 244, 0.85);
      gap: clamp(14px, 1.8vw, 20px);
      position: relative;
      grid-template-columns: auto 1fr;
      gap: clamp(14px, 1.6vw, 20px);
      padding: clamp(14px, 1.8vw, 20px);
      border-radius: 20px;
      background: linear-gradient(155deg, var(--element-panel-start), var(--element-panel-end));
      border: 1px solid var(--element-panel-border);
      box-shadow: inset 0 0 0 1px var(--element-panel-glow);
    }
    .base-power-pal::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle at top left, rgba(224, 255, 244, 0.14), transparent 55%);
      opacity: 0.4;
      pointer-events: none;
    }
    .base-power-pal > * {
      position: relative;
      z-index: 1;
    }
    .base-power-pal__profile {
      display: grid;
      place-items: center;
    }
    .base-power-pal__portrait {
      width: clamp(72px, 8vw, 88px);
      height: clamp(72px, 8vw, 88px);
      border: 1px solid rgba(224, 255, 244, 0.22);
      background: rgba(6, 14, 24, 0.86);
      object-fit: contain;
      box-shadow: 0 16px 34px rgba(3, 12, 24, 0.5);
    }
    .base-power-pal__details {
      display: grid;
      gap: 10px;
      align-content: start;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
    }
    .base-power-pal__identity {
      display: flex;
      gap: 6px 10px;
      align-items: center;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0;
      border: none;
      background: none;
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      text-align: left;
    }
    .base-power-pal__name:hover,
    .base-power-pal__name:focus-visible {
      color: #d4f7ff;
      text-decoration: underline;
      outline: none;
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(12, 26, 44, 0.6);
      border: 1px solid rgba(224, 255, 244, 0.16);
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      color: rgba(224, 225, 221, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: rgba(8, 18, 34, 0.6);
      border: 1px solid rgba(224, 255, 244, 0.2);
      color: rgba(224, 255, 244, 0.85);
    }
    .base-power-pal__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .base-power-pal__types {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .base-power-pal__type {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(12, 24, 40, 0.55);
      border: 1px solid rgba(224, 255, 244, 0.16);
      font-size: 0.78rem;
      color: rgba(224, 255, 244, 0.85);
    }
    .base-power-pal__type img {
      width: 18px;
      height: 18px;
    }
    .base-power-pal__suit {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: var(--element-pill);
      border: 1px solid var(--element-pill-border);
      color: rgba(224, 255, 244, 0.88);
      color: rgba(224, 225, 221, 0.6);
      font-size: 0.74rem;
      background: var(--element-pill);
      border: 1px solid var(--element-pill-border);
      background: var(--element-on);
      border-color: rgba(105, 228, 166, 0.55);
      color: #cfffee;
      background: var(--element-off);
      border-color: rgba(231, 111, 81, 0.5);
      color: #ffd0c0;
      background: var(--element-neutral);
    .base-passive-chip {
      min-height: 0;
      padding: 6px 14px;
      font-size: 0.76rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      box-shadow: 0 14px 24px rgba(0, 0, 0, 0.35);
    }
    .base-passive-chip:focus-visible {
      outline: 2px solid rgba(140, 196, 255, 0.65);
      outline-offset: 3px;
    }
    .base-passive-chip[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .element-theme--neutral {
      --element-spotlight: rgba(105, 228, 166, 0.18);
      --element-surface-start: rgba(10, 24, 40, 0.9);
      --element-surface-end: rgba(6, 14, 26, 0.95);
      --element-border: rgba(148, 210, 189, 0.22);
      --element-shadow: rgba(3, 12, 24, 0.55);
      --element-panel-start: rgba(8, 16, 28, 0.82);
      --element-panel-end: rgba(12, 24, 40, 0.92);
      --element-panel-border: rgba(119, 141, 169, 0.35);
      --element-panel-glow: rgba(224, 225, 221, 0.08);
      --element-pill: rgba(119, 141, 169, 0.22);
      --element-pill-border: rgba(119, 141, 169, 0.45);
    }
    .element-theme--fire {
      --element-spotlight: rgba(255, 128, 92, 0.32);
      --element-surface-start: rgba(60, 20, 12, 0.92);
      --element-surface-end: rgba(32, 12, 8, 0.94);
      --element-border: rgba(255, 144, 108, 0.45);
      --element-shadow: rgba(120, 42, 20, 0.58);
      --element-panel-start: rgba(42, 16, 10, 0.88);
      --element-panel-end: rgba(66, 24, 14, 0.9);
      --element-panel-border: rgba(255, 146, 98, 0.42);
      --element-panel-glow: rgba(255, 188, 150, 0.18);
      --element-pill: rgba(255, 146, 98, 0.22);
      --element-pill-border: rgba(255, 170, 128, 0.48);
    }
    .element-theme--water {
      --element-spotlight: rgba(110, 210, 255, 0.32);
      --element-surface-start: rgba(14, 32, 56, 0.92);
      --element-surface-end: rgba(10, 24, 46, 0.94);
      --element-border: rgba(120, 198, 255, 0.45);
      --element-shadow: rgba(18, 48, 78, 0.52);
      --element-panel-start: rgba(14, 28, 52, 0.85);
      --element-panel-end: rgba(20, 40, 66, 0.9);
      --element-panel-border: rgba(126, 202, 255, 0.42);
      --element-panel-glow: rgba(160, 224, 255, 0.2);
      --element-pill: rgba(120, 198, 255, 0.2);
      --element-pill-border: rgba(150, 218, 255, 0.46);
    }
    .element-theme--ice {
      --element-spotlight: rgba(150, 240, 255, 0.32);
      --element-surface-start: rgba(16, 36, 64, 0.9);
      --element-surface-end: rgba(12, 30, 56, 0.92);
      --element-border: rgba(160, 230, 255, 0.42);
      --element-shadow: rgba(24, 54, 76, 0.5);
      --element-panel-start: rgba(18, 36, 60, 0.85);
      --element-panel-end: rgba(24, 44, 70, 0.9);
      --element-panel-border: rgba(170, 232, 255, 0.42);
      --element-panel-glow: rgba(200, 244, 255, 0.18);
      --element-pill: rgba(170, 232, 255, 0.2);
      --element-pill-border: rgba(190, 240, 255, 0.45);
    }
    .element-theme--electric {
      --element-spotlight: rgba(255, 230, 120, 0.32);
      --element-surface-start: rgba(48, 38, 8, 0.9);
      --element-surface-end: rgba(28, 22, 6, 0.94);
      --element-border: rgba(255, 228, 130, 0.45);
      --element-shadow: rgba(72, 56, 12, 0.58);
      --element-panel-start: rgba(40, 32, 10, 0.88);
      --element-panel-end: rgba(58, 46, 12, 0.92);
      --element-panel-border: rgba(255, 228, 130, 0.42);
      --element-panel-glow: rgba(255, 240, 160, 0.2);
      --element-pill: rgba(255, 228, 130, 0.2);
      --element-pill-border: rgba(255, 236, 160, 0.45);
    }
    .element-theme--grass {
      --element-spotlight: rgba(148, 232, 162, 0.32);
      --element-surface-start: rgba(18, 46, 30, 0.92);
      --element-surface-end: rgba(12, 36, 24, 0.94);
      --element-border: rgba(148, 232, 162, 0.42);
      --element-shadow: rgba(20, 56, 34, 0.5);
      --element-panel-start: rgba(18, 42, 26, 0.88);
      --element-panel-end: rgba(26, 58, 34, 0.9);
      --element-panel-border: rgba(148, 232, 162, 0.4);
      --element-panel-glow: rgba(188, 252, 202, 0.2);
      --element-pill: rgba(148, 232, 162, 0.2);
      --element-pill-border: rgba(178, 246, 188, 0.45);
    }
    .element-theme--ground {
      --element-spotlight: rgba(215, 172, 120, 0.32);
      --element-surface-start: rgba(46, 30, 18, 0.92);
      --element-surface-end: rgba(32, 22, 12, 0.94);
      --element-border: rgba(215, 172, 120, 0.42);
      --element-shadow: rgba(64, 44, 24, 0.52);
      --element-panel-start: rgba(40, 26, 16, 0.88);
      --element-panel-end: rgba(58, 36, 20, 0.9);
      --element-panel-border: rgba(215, 172, 120, 0.4);
      --element-panel-glow: rgba(236, 196, 150, 0.18);
      --element-pill: rgba(215, 172, 120, 0.2);
      --element-pill-border: rgba(232, 192, 148, 0.45);
    }
    .element-theme--dragon {
      --element-spotlight: rgba(188, 140, 255, 0.32);
      --element-surface-start: rgba(40, 22, 58, 0.9);
      --element-surface-end: rgba(28, 16, 40, 0.94);
      --element-border: rgba(188, 140, 255, 0.42);
      --element-shadow: rgba(58, 28, 92, 0.52);
      --element-panel-start: rgba(36, 18, 54, 0.88);
      --element-panel-end: rgba(54, 26, 78, 0.9);
      --element-panel-border: rgba(188, 140, 255, 0.4);
      --element-panel-glow: rgba(214, 176, 255, 0.2);
      --element-pill: rgba(188, 140, 255, 0.22);
      --element-pill-border: rgba(214, 176, 255, 0.48);
    }
    .element-theme--dark {
      --element-spotlight: rgba(130, 120, 210, 0.28);
      --element-surface-start: rgba(24, 18, 36, 0.92);
      --element-surface-end: rgba(16, 12, 26, 0.94);
      --element-border: rgba(140, 120, 210, 0.4);
      --element-shadow: rgba(34, 20, 60, 0.5);
      --element-panel-start: rgba(22, 16, 34, 0.88);
      --element-panel-end: rgba(34, 24, 52, 0.9);
      --element-panel-border: rgba(140, 120, 210, 0.4);
      --element-panel-glow: rgba(172, 150, 235, 0.18);
      --element-pill: rgba(140, 120, 210, 0.22);
      --element-pill-border: rgba(168, 150, 230, 0.46);
    }
    .element-theme--air {
      --element-spotlight: rgba(170, 236, 255, 0.3);
      --element-surface-start: rgba(20, 38, 60, 0.9);
      --element-surface-end: rgba(18, 34, 58, 0.94);
      --element-border: rgba(170, 236, 255, 0.4);
      --element-shadow: rgba(30, 54, 84, 0.5);
      --element-panel-start: rgba(18, 34, 54, 0.86);
      --element-panel-end: rgba(26, 46, 70, 0.9);
      --element-panel-border: rgba(170, 236, 255, 0.38);
      --element-panel-glow: rgba(190, 240, 255, 0.2);
      --element-pill: rgba(170, 236, 255, 0.22);
      --element-pill-border: rgba(190, 244, 255, 0.46);
    }
      gap: clamp(12px, 2vw, 20px);
    .base-monitor-grid {
      display: flex;
      flex-direction: column;
      gap: 14px;
      overflow-x: auto;
      padding-bottom: 6px;
    .base-monitor-grid__header {
      display: grid;
      align-items: stretch;
      gap: 0;
      padding: 12px 16px;
      border-radius: 20px;
      background: linear-gradient(150deg, rgba(16, 34, 58, 0.88), rgba(12, 26, 46, 0.9));
      border: 1px solid rgba(148, 210, 189, 0.32);
      box-shadow: 0 20px 42px rgba(4, 12, 28, 0.55);
      min-width: 720px;
    .base-monitor-grid__group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 720px;
    .base-monitor-grid__group-title {
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.16em;
      color: rgba(224, 225, 221, 0.62);
      padding-left: 4px;
    .base-monitor-grid__row {
      display: grid;
      align-items: stretch;
      gap: 0;
      padding: 12px 16px;
      border-radius: 18px;
      background: linear-gradient(155deg, var(--element-panel-start, rgba(8, 16, 28, 0.82)), var(--element-panel-end, rgba(12, 24, 40, 0.92)));
      border: 1px solid var(--element-panel-border, rgba(119, 141, 169, 0.35));
      box-shadow: inset 0 0 0 1px var(--element-panel-glow, rgba(224, 225, 221, 0.08));
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    .base-monitor-grid__row:hover {
      transform: translateY(-2px);
      box-shadow: inset 0 0 0 1px var(--element-panel-glow, rgba(224, 225, 221, 0.12)), 0 20px 42px rgba(4, 12, 28, 0.55);
    .base-monitor-grid__cell {
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
      font-size: 0.78rem;
      color: rgba(224, 225, 221, 0.78);
    }
    .base-monitor-grid__cell--pal {
      justify-content: flex-start;
      gap: 12px;
      padding: 8px 14px 8px 4px;
      color: var(--text);
    }
    .base-monitor-grid__portrait {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      border: 1px solid rgba(224, 255, 244, 0.16);
      background: rgba(6, 14, 24, 0.82);
      object-fit: contain;
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.4);
    }
    .base-monitor-grid__pal-details {
      display: grid;
      align-content: start;
    .base-monitor-grid__pal-name {
      padding: 0;
      border: none;
      background: none;
      color: inherit;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
    .base-monitor-grid__pal-name:hover,
    .base-monitor-grid__pal-name:focus-visible {
      color: #d4f7ff;
      text-decoration: underline;
      outline: none;
    }
    .base-monitor-grid__pal-alias {
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      color: rgba(224, 225, 221, 0.6);
    .base-monitor-grid__pal-role {
      font-size: 0.78rem;
      color: rgba(224, 225, 221, 0.7);
    .base-monitor-grid__pal-suit {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.72rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: var(--element-pill, rgba(119, 141, 169, 0.22));
      border: 1px solid var(--element-pill-border, rgba(119, 141, 169, 0.45));
      color: rgba(224, 255, 244, 0.82);
      width: max-content;
    }
    .base-monitor-grid__cell--toggle {
      padding: 10px 0;
    .base-monitor-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      min-width: 64px;
      border: 1px solid transparent;
    }
    .base-monitor-toggle::before {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .base-monitor-toggle--on {
      color: #cbffe6;
      background: rgba(105, 228, 166, 0.18);
      border-color: rgba(105, 228, 166, 0.45);
      box-shadow: 0 12px 24px rgba(12, 42, 32, 0.35);
    }
    .base-monitor-toggle--on::before {
      background: rgba(105, 228, 166, 0.85);
      box-shadow: 0 0 14px rgba(105, 228, 166, 0.45);
    }
    .base-monitor-toggle--off {
      color: #ffd6c9;
      background: rgba(231, 111, 81, 0.18);
      border-color: rgba(231, 111, 81, 0.45);
    }
    .base-monitor-toggle--off::before {
      background: rgba(231, 111, 81, 0.88);
      box-shadow: 0 0 14px rgba(231, 111, 81, 0.4);
    }
    .base-monitor-toggle--idle {
      color: #eadcff;
      background: rgba(206, 135, 255, 0.16);
      border-color: rgba(206, 135, 255, 0.42);
    }
    .base-monitor-toggle--idle::before {
      background: rgba(206, 135, 255, 0.85);
      box-shadow: 0 0 14px rgba(206, 135, 255, 0.4);
    }
    .base-monitor-toggle--neutral {
      color: rgba(224, 225, 221, 0.65);
      background: rgba(119, 141, 169, 0.12);
      border: 1px dashed rgba(119, 141, 169, 0.4);
    }
    .base-monitor-toggle--neutral::before {
      background: transparent;
      border: 2px dashed rgba(119, 141, 169, 0.45);
      box-shadow: none;

    const ELEMENT_THEME_KEYS = new Set(['neutral', 'fire', 'water', 'ice', 'electric', 'grass', 'ground', 'dragon', 'dark', 'air']);

    function normaliseElementThemeKey(type) {
      const normalized = (type || 'neutral').toString().trim().toLowerCase();
      if (ELEMENT_THEME_KEYS.has(normalized)) return normalized;
      return 'neutral';
    }

    function getElementThemeClassForType(type) {
      return `element-theme--${normaliseElementThemeKey(type)}`;
    }

    function getElementThemeClassForPal(pal) {
      if (!pal) return getElementThemeClassForType('neutral');
      const primary = getPrimaryType(pal);
      return getElementThemeClassForType(primary);
    }

    const MONITORING_TOGGLE_META = {
      handiwork: { label: 'Handiwork', kid: 'Build' },
      transporting: { label: 'Transport', kid: 'Carry' },
      mining: { label: 'Mining', kid: 'Mine' },
      lumbering: { label: 'Lumber', kid: 'Chop' },
      gathering: { label: 'Gather', kid: 'Gather' },
      planting: { label: 'Plant', kid: 'Plant' },
      watering: { label: 'Water', kid: 'Water' },
      kindling: { label: 'Kindling', kid: 'Fire' },
      electricity: { label: 'Power', kid: 'Power' },
      cooling: { label: 'Cooling', kid: 'Cool' },
      medicine: { label: 'Medicine', kid: 'Heal' },
      farming: { label: 'Farming', kid: 'Farm' },
      ranching: { label: 'Ranch', kid: 'Ranch' },
      combat: { label: 'Combat', kid: 'Fight' },
      idle: { label: 'Aura Idle', kid: 'Aura Idle' }
    };

    const MONITORING_TOGGLE_ORDER = [
      'handiwork',
      'transporting',
      'mining',
      'lumbering',
      'gathering',
      'planting',
      'watering',
      'kindling',
      'electricity',
      'cooling',
      'medicine',
      'farming',
      'ranching',
      'combat',
      'idle'
    ];

    function normaliseWorkToggleName(name) {
      if (!name) return null;
      const value = String(name).trim().toLowerCase();
      switch (value) {
        case 'handiwork':
          return 'handiwork';
        case 'transporting':
          return 'transporting';
        case 'mining':
          return 'mining';
        case 'lumbering':
          return 'lumbering';
        case 'gathering':
          return 'gathering';
        case 'planting':
          return 'planting';
        case 'watering':
          return 'watering';
        case 'kindling':
          return 'kindling';
        case 'generating electricity':
        case 'electricity':
          return 'electricity';
        case 'cooling':
          return 'cooling';
        case 'medicine production':
        case 'medicine':
          return 'medicine';
        case 'farming (ranch)':
        case 'ranching':
          return 'ranching';
        case 'farming':
          return 'farming';
        case 'combat':
          return 'combat';
        case 'keep all work toggles off':
          return 'idle';
        default:
          return null;
      }
    }

    function buildMonitoringToggleState(toggles) {
      const on = new Set();
      const off = new Set();
      if (toggles && typeof toggles === 'object') {
        (toggles.on || []).forEach(name => {
          const key = normaliseWorkToggleName(name);
          if (key) on.add(key);
        });
        (toggles.off || []).forEach(name => {
          const key = normaliseWorkToggleName(name);
          if (key) off.add(key);
        });
      }
      return { on, off };
    }

    function getMonitoringTasks() {
      const discovered = new Set();
      BASE_POWER_CARDS.forEach(card => {
        (card.pals || []).forEach(pal => {
          const toggles = pal?.toggles || {};
          [...(toggles.on || []), ...(toggles.off || [])].forEach(name => {
            const key = normaliseWorkToggleName(name);
            if (key) discovered.add(key);
          });
        });
      });
      return MONITORING_TOGGLE_ORDER
        .filter(key => discovered.has(key))
        .map(key => {
          const meta = MONITORING_TOGGLE_META[key] || {};
          const label = kidMode ? (meta.kid || meta.label || niceName(key)) : (meta.label || niceName(key));
          return { key, label };
        });
    }
    function resolvePassiveInfo(name) {
      const trimmed = (name || '').trim();
      if (!trimmed) {
        return { trait: '', info: null };
      }
      if (PASSIVE_DETAILS && Object.prototype.hasOwnProperty.call(PASSIVE_DETAILS, trimmed)) {
        return { trait: trimmed, info: PASSIVE_DETAILS[trimmed] };
      }
      const lower = trimmed.toLowerCase();
      if (PASSIVE_DETAIL_LOOKUP instanceof Map && PASSIVE_DETAIL_LOOKUP.has(lower)) {
        const info = PASSIVE_DETAIL_LOOKUP.get(lower);
        const canonical = info && info.name ? info.name : trimmed;
        return { trait: canonical, info };
      }
      if (PASSIVE_DETAILS && typeof PASSIVE_DETAILS === 'object') {
        const match = Object.entries(PASSIVE_DETAILS).find(([traitName]) => traitName.toLowerCase() === lower);
        if (match) {
          return { trait: match[0], info: match[1] };
        }
      }
      return { trait: trimmed, info: null };
    }

    function createPassiveChip(traitName) {
      const { trait, info } = resolvePassiveInfo(traitName);
      const label = trait || (traitName || '').trim() || 'Trait';
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip passive base-passive-chip';
      chip.dataset.trait = label;
      chip.dataset.palPassive = label;
      chip.textContent = label;
      const meta = info ? classifyPassiveRank(info.rank) : null;
      if (meta?.className) {
        chip.classList.add(meta.className);
        if (meta.key) chip.dataset.rank = meta.key;
        if (meta.label) chip.dataset.rankLabel = meta.label;
      }
      const tooltip = info?.description
        || info?.effect
        || (traitsDictionary && typeof traitsDictionary[label] === 'string' ? traitsDictionary[label] : '');
      if (tooltip) {
        chip.title = tooltip;
      }
      return chip;
    }

        if (modifier === 'passive') {
          const chip = createPassiveChip(item);
          if (chip) {
            row.appendChild(chip);
          }
          return;
        }
      const fragment = document.createDocumentFragment();
        const primaryPal = Array.isArray(card.pals) ? card.pals.find(entry => entry && entry.name) : null;
        const primaryRecord = primaryPal ? findPalByName(primaryPal.name) : null;
        const cardTheme = getElementThemeClassForPal(primaryRecord);
        cardEl.classList.add(cardTheme);

        header.appendChild(title);
          header.appendChild(subtitle);

        (card.pals || []).forEach(pal => {
          if (!pal || !pal.name) return;
          const palRecord = findPalByName(pal.name);
          const palTheme = getElementThemeClassForPal(palRecord);
          palEl.classList.add(palTheme);
          if (palRecord && palRecord.id != null) {
            palEl.dataset.palId = String(palRecord.id);
          }
          palEl.dataset.palName = pal.name;

          const profile = document.createElement('div');
          profile.className = 'base-power-pal__profile';
          const portrait = document.createElement('img');
          portrait.className = 'base-power-pal__portrait';
          portrait.alt = `${pal.name} portrait`;
          if (palRecord && palRecord.id != null) {
            portrait.dataset.palId = String(palRecord.id);
          }
          portrait.dataset.palName = pal.name;
          applyPalArtwork(portrait, palRecord, { alt: `${pal.name} portrait` });
          profile.appendChild(portrait);
          palEl.appendChild(profile);

          const details = document.createElement('div');
          details.className = 'base-power-pal__details';
          palEl.appendChild(details);

          const identity = document.createElement('div');
          identity.className = 'base-power-pal__identity';
          const nameButton = document.createElement('button');
          nameButton.type = 'button';
          nameButton.className = 'base-power-pal__name';
          nameButton.textContent = pal.name;
          if (palRecord && palRecord.id != null) {
            nameButton.dataset.palId = String(palRecord.id);
          }
          nameButton.dataset.palName = pal.name;
          identity.appendChild(nameButton);
            identity.appendChild(alias);
          palHeader.appendChild(identity);
            const role = document.createElement('span');
            palHeader.appendChild(role);
          }
          details.appendChild(palHeader);

          const meta = document.createElement('div');
          meta.className = 'base-power-pal__meta';
          const palTypes = Array.isArray(palRecord?.types) ? palRecord.types.filter(Boolean) : [];
          if (palTypes.length) {
            const typesWrap = document.createElement('div');
            typesWrap.className = 'base-power-pal__types';
            palTypes.slice(0, 2).forEach(typeName => {
              const typeChip = document.createElement('span');
              typeChip.className = 'base-power-pal__type';
              const iconSrc = iconMap[typeName] || iconMap['Neutral'];
              if (iconSrc) {
                const icon = document.createElement('img');
                icon.src = iconSrc;
                icon.alt = `${typeName} element`;
                typeChip.appendChild(icon);
              }
              typeChip.appendChild(document.createTextNode(typeName));
              typesWrap.appendChild(typeChip);
            });
            meta.appendChild(typesWrap);
          }
          if (pal.workSuit) {
            const suit = document.createElement('span');
            suit.className = 'base-power-pal__suit';
            suit.textContent = pal.workSuit;
            meta.appendChild(suit);
          }
          if (meta.children.length) {
            details.appendChild(meta);

          appendLabeledChips(details, kidMode ? 'Keep ON' : 'Keep ON', onItems, onModifier);
          const offItems = Array.isArray(pal.toggles?.off) ? pal.toggles.off : [];
          appendLabeledChips(details, kidMode ? 'Switch OFF' : 'Turn OFF', offItems, 'off');
          appendLabeledChips(details, kidMode ? 'Passives' : 'Passive traits', Array.isArray(pal.passives) ? pal.passives : [], 'passive');

            details.appendChild(upgrade);
            details.appendChild(notes);
        fragment.appendChild(cardEl);
      container.appendChild(fragment);
      if (!container.dataset.listenerBound) {
        container.addEventListener('click', event => {
          const traitChip = event.target.closest('.base-passive-chip');
          if (traitChip) {
            const traitName = traitChip.dataset.trait;
            if (traitName) {
              showTraitDetail(traitName);
            }
            event.preventDefault();
            return;
          }
          const palTrigger = event.target.closest('.base-power-pal__name, .base-power-pal__portrait');
          if (palTrigger) {
            const palId = palTrigger.dataset.palId || palTrigger.closest('.base-power-pal')?.dataset.palId;
            const palName = palTrigger.dataset.palName || palTrigger.closest('.base-power-pal')?.dataset.palName || palTrigger.textContent || '';
            if (palId) {
              showPalDetail(palId);
            } else if (palName) {
              focusSearch(palName, { target: 'pals' });
            }
            event.preventDefault();
          }
        });
        container.dataset.listenerBound = 'true';
      }
    function renderBaseToggleTable(grid) {
      if (!grid) return;
      grid.innerHTML = '';
      const tasks = getMonitoringTasks();
      if (!tasks.length) {
        const empty = document.createElement('p');
        empty.className = 'empty-state';
        empty.textContent = kidMode
          ? 'Monitoring chart loading…'
          : 'Monitoring chart data is still loading.';
        grid.appendChild(empty);
        return;
      }
      const columnTemplate = ['minmax(240px, 1fr)', ...tasks.map(() => 'minmax(0, 72px)')].join(' ');
      const minWidth = 240 + tasks.length * 88;

      const header = document.createElement('div');
      header.className = 'base-monitor-grid__header';
      header.style.gridTemplateColumns = columnTemplate;
      header.style.minWidth = `${minWidth}px`;
      const palHeader = document.createElement('div');
      palHeader.className = 'base-monitor-grid__cell base-monitor-grid__cell--pal';
      palHeader.textContent = kidMode ? 'Pal focus' : 'Pal & role';
      header.appendChild(palHeader);
      tasks.forEach(task => {
        const cell = document.createElement('div');
        cell.className = 'base-monitor-grid__cell base-monitor-grid__cell--head';
        cell.textContent = task.label;
        header.appendChild(cell);
      });
      grid.appendChild(header);

        const group = document.createElement('div');
        group.className = 'base-monitor-grid__group';
        group.style.minWidth = `${minWidth}px`;
        const title = document.createElement('div');
        title.className = 'base-monitor-grid__group-title';
        title.textContent = card.title;
        group.appendChild(title);
        (card.pals || []).forEach(pal => {
          if (!pal || !pal.name) return;
          const palRecord = findPalByName(pal.name);
          const row = document.createElement('div');
          row.className = 'base-monitor-grid__row';
          row.classList.add(getElementThemeClassForPal(palRecord));
          row.style.gridTemplateColumns = columnTemplate;
          row.style.minWidth = `${minWidth}px`;

          const palCell = document.createElement('div');
          palCell.className = 'base-monitor-grid__cell base-monitor-grid__cell--pal';
          const portrait = document.createElement('img');
          portrait.className = 'base-monitor-grid__portrait';
          portrait.alt = `${pal.name} portrait`;
          if (palRecord && palRecord.id != null) {
            portrait.dataset.palId = String(palRecord.id);
          }
          portrait.dataset.palName = pal.name;
          applyPalArtwork(portrait, palRecord, { alt: `${pal.name} portrait` });
          palCell.appendChild(portrait);

          const palDetails = document.createElement('div');
          palDetails.className = 'base-monitor-grid__pal-details';
          const nameBtn = document.createElement('button');
          nameBtn.type = 'button';
          nameBtn.className = 'base-monitor-grid__pal-name';
          nameBtn.textContent = pal.name;
          if (palRecord && palRecord.id != null) {
            nameBtn.dataset.palId = String(palRecord.id);
          }
          nameBtn.dataset.palName = pal.name;
          palDetails.appendChild(nameBtn);
            alias.className = 'base-monitor-grid__pal-alias';
            palDetails.appendChild(alias);
          }
          if (pal.role) {
            const role = document.createElement('span');
            role.className = 'base-monitor-grid__pal-role';
            role.textContent = pal.role;
            palDetails.appendChild(role);
          if (pal.workSuit) {
            const suit = document.createElement('span');
            suit.className = 'base-monitor-grid__pal-suit';
            suit.textContent = pal.workSuit;
            palDetails.appendChild(suit);
          }
          palCell.appendChild(palDetails);

          const toggleState = buildMonitoringToggleState(pal.toggles || {});
          const statusLabels = {
            on: kidMode ? 'On' : 'On',
            off: kidMode ? 'Off' : 'Off',
            idle: kidMode ? 'Idle' : 'Idle',
            neutral: '—'
          };
          tasks.forEach(task => {
            const cell = document.createElement('div');
            cell.className = 'base-monitor-grid__cell base-monitor-grid__cell--toggle';
            let status = 'neutral';
            if (task.key === 'idle') {
              status = toggleState.on.has('idle') ? 'idle' : 'neutral';
            } else if (toggleState.on.has(task.key)) {
              status = 'on';
            } else if (toggleState.off.has(task.key)) {
              status = 'off';
            }
            const indicator = document.createElement('span');
            indicator.className = `base-monitor-toggle base-monitor-toggle--${status}`;
            indicator.textContent = statusLabels[status] || '—';
            cell.appendChild(indicator);
            row.appendChild(cell);
          });
          group.appendChild(row);
        grid.appendChild(group);

      if (!grid.dataset.listenerBound) {
        grid.addEventListener('click', event => {
          const palTarget = event.target.closest('.base-monitor-grid__pal-name, .base-monitor-grid__portrait');
          if (palTarget) {
            const palCell = palTarget.closest('.base-monitor-grid__cell--pal');
            const fallbackButton = palCell ? palCell.querySelector('.base-monitor-grid__pal-name') : null;
            const palId = palTarget.dataset.palId || fallbackButton?.dataset.palId;
            const palName = palTarget.dataset.palName || fallbackButton?.dataset.palName || palTarget.textContent || '';
            if (palId) {
              showPalDetail(palId);
            } else if (palName) {
              focusSearch(palName, { target: 'pals' });
            }
            event.preventDefault();
          }
        });
        grid.dataset.listenerBound = 'true';
      }
          <div class="base-monitor-grid" id="baseToggleGrid"></div>
        toggleGrid: page.querySelector('#baseToggleGrid')
      renderBaseToggleTable(basePlannerElements.toggleGrid);
