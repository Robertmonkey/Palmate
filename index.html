    function normalisePassiveDetails(rawDetails) {
      const descriptions = {};
      Object.entries(defaultTraitsDictionary).forEach(([name, desc]) => {
        const trimmedName = (name || '').trim();
        if (trimmedName) {
          descriptions[trimmedName] = desc;
        }
      });
      const normalised = {};
      if (rawDetails && typeof rawDetails === 'object') {
        Object.entries(rawDetails).forEach(([rawName, rawValue]) => {
          if (rawValue == null) return;
          const entry = typeof rawValue === 'string' ? { description: rawValue } : { ...rawValue };
          const traitName = (entry.name || rawName || '').trim();
          if (!traitName) return;
          const description = (entry.description || '').trim();
          const effect = (entry.effect || '').trim();
          const stats = entry.stats && typeof entry.stats === 'object'
            ? Object.entries(entry.stats).reduce((acc, [statName, statValue]) => {
                const key = (statName || '').trim();
                if (!key) return acc;
                acc[key] = statValue;
                return acc;
              }, {})
            : null;
          const statsPayload = stats && Object.keys(stats).length ? stats : null;
          const naturalOn = Array.isArray(entry.naturalOn)
            ? entry.naturalOn.map(name => (name || '').trim()).filter(Boolean)
            : [];
          const normalisedEntry = {
            name: traitName,
            description: description || effect || descriptions[traitName] || '',
            effect,
            rank: entry.rank != null ? entry.rank : null,
            stats: statsPayload,
            source: entry.source || '',
            naturalOn
          };
          normalised[traitName] = normalisedEntry;
          if (normalisedEntry.description) {
            descriptions[traitName] = normalisedEntry.description;
          } else if (effect) {
            descriptions[traitName] = effect;
          } else if (!descriptions[traitName]) {
            descriptions[traitName] = '';
          }
        });
      }
      return { normalised, descriptions };
    }

        const passiveSync = normalisePassiveDetails(payload.passiveDetails || {});
        PASSIVE_DETAILS = passiveSync.normalised;
        traitsDictionary = passiveSync.descriptions;
        skillsDictionary = { ...defaultSkillsDictionary };
        if (SKILL_DETAILS && Object.keys(SKILL_DETAILS).length) {
          const normalizedSkills = {};
          Object.entries(SKILL_DETAILS).forEach(([key, info = {}]) => {
            const normalizedKey = key.toLowerCase().replace(/[\s-]+/g, '_');
            normalizedSkills[normalizedKey] = {
              name: (info.name || key).replace(/_/g, ' '),
              damage: info.power ? `Power ${info.power}` : (info.damage || 'Unknown'),
              type: info.element || info.type || 'Unknown',
              description: info.description || 'No description available.'
            };
          });
          skillsDictionary = { ...defaultSkillsDictionary, ...normalizedSkills };
        }
      const traitEntries = Array.from(new Set(
        Object.keys(traitsDictionary || {})
          .map(name => (name || '').trim())
          .filter(Boolean)
      )).map(name => ({
      const passiveEntries = Array.from(new Set(
        Object.keys(traitsDictionary || {})
          .map(name => (name || '').trim())
          .filter(Boolean)
      )).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
      const fallbackCopy = 'This trait has mysterious effects that aren\'t fully documented. See how it behaves in-game!';
      const trimmedName = (name || '').trim();
      const info = PASSIVE_DETAILS[trimmedName] || PASSIVE_DETAILS[name] || null;
      const lookupKey = trimmedName || name;
      const traitDescription = typeof traitsDictionary[lookupKey] === 'string'
        ? traitsDictionary[lookupKey]
        : '';
      const description = info && info.description ? info.description : traitDescription;
      const effect = info && info.effect ? info.effect : '';
      const statsEntries = info && info.stats && typeof info.stats === 'object'
        ? Object.entries(info.stats).filter(([stat, value]) => (stat || '').trim() && value != null)
        : [];
      const naturalOn = info && Array.isArray(info.naturalOn)
        ? info.naturalOn.filter(Boolean)
        : [];
      let html = `<h3>${escapeHTML(trimmedName || name || 'Unknown Trait')}</h3>`;
      html += `<p>${escapeHTML(description || effect || fallbackCopy)}</p>`;
      if (info) {
        if (effect && effect !== description) {
          html += `<p><strong>Effect:</strong> ${escapeHTML(effect)}</p>`;
        }
        if (info.rank !== undefined && info.rank !== null && info.rank !== '') {
          let rankLabel;
          if (typeof info.rank === 'number' && !Number.isNaN(info.rank)) {
            const sign = info.rank > 0 ? `+${info.rank}` : `${info.rank}`;
            rankLabel = `Rank ${sign}`;
          } else {
            const rawRank = String(info.rank);
            rankLabel = /^rank/i.test(rawRank) ? rawRank : `Rank ${rawRank}`;
          }
          html += `<p><strong>Rank:</strong> ${escapeHTML(rankLabel)}</p>`;
        }
        if (statsEntries.length) {
          const statsList = statsEntries
            .map(([stat, value]) => `<li>${escapeHTML(`${stat}: ${value}`)}</li>`)
            .join('');
          if (statsList) {
            html += `<div><strong>Stat changes:</strong><ul class="trait-detail__stats">${statsList}</ul></div>`;
          }
        }
        if (naturalOn.length) {
          const palsList = naturalOn
            .map(pal => `<li>${escapeHTML(pal)}</li>`)
            .join('');
          if (palsList) {
            html += `<div><strong>Found on:</strong><ul class="trait-detail__pals">${palsList}</ul></div>`;
          }
        }
        if (info.source) {
          if (/^https?:\/\//i.test(info.source)) {
            const safeUrl = escapeHTML(info.source);
            html += `<p><a href="${safeUrl}" target="_blank" rel="noopener">View source</a></p>`;
          } else {
            html += `<p><strong>Source:</strong> ${escapeHTML(info.source)}</p>`;
          }
        }
      }
      div.innerHTML = html;
