<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palmate – Palworld Companion</title>
  <!-- Chart.js for radar charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Font Awesome for interface icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Core styles: cosmic blue theme with smooth scrollbars -->
  <style>
    /*
      Colour palette for our epic cosmic theme.  We move away from the
      flat blues of the original and embrace rich purples and golds
      inspired by the Palworld universe.  These variables define the
      background, primary and secondary navigation colours, accent
      highlights, light text, card backgrounds and success/danger
      notifications.  Feel free to tweak these values for your own
      flavour.
    */
    :root {
      /*
        Updated colour palette to give the UI a warmer, more inviting
        atmosphere.  The dark navy base contrasts with desaturated
        blues and soft greens, while the accent colour pops against
        the card backgrounds.  Light colours are slightly brighter to
        improve readability for younger players.  Feel free to tweak
        these values to suit your own tastes.
      */
      --bg: #0d1b2a;
      --primary: #1b263b;
      --secondary: #415a77;
      --accent: #778da9;
      --light: #e0e1dd;
      --card-bg: #1e3246;
      --card-hover: #2e4a62;
      --text: #f0f4f8;
      --danger: #e76f51;
      --success: #2a9d8f;
    }
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      /* Set a cosmic background image across the entire page.  We use
         background-attachment: fixed so the stars stay put as you
         scroll, lending a sense of depth.  The fallback colour
         ensures readability while the image loads. */
      background: var(--bg) url('assets/images/background.png') center/cover fixed no-repeat;
      color: var(--text);
      font-family: "Trebuchet MS", sans-serif;
      height: 100%;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }
    /* Remove the old #app layout (previously used for sidebar).  The
       content area now sits below the navbar and fills the remaining
       space. */
    /* Top navigation bar styling */
    #navbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--primary);
      display: flex;
      align-items: center;
      padding: 0 10px;
      height: 60px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    #navbar .logo {
      font-size: 1.4rem;
      font-weight: bold;
      letter-spacing: 1px;
      margin-right: 20px;
    }
    #navbar .nav-item {
      border: none;
      background: none;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: border-color 0.3s, color 0.3s;
    }
    #navbar .nav-item i {
      font-size: 1.1rem;
    }
    #navbar .nav-item:hover {
      color: var(--accent);
    }
    #navbar .nav-item.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Mode toggle button styling */
    .mode-btn {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 10px;
      transition: color 0.3s;
    }
    .mode-btn:hover {
      color: var(--accent);
    }

    /* Kid mode adjustments: larger targets and font sizes, simplified cards */
    body.kid-mode .pal-card img {
      width: 120px;
      height: 120px;
    }
    body.kid-mode .item-card img {
      width: 120px;
      height: 120px;
    }
    body.kid-mode .pal-card .name,
    body.kid-mode .item-card .name {
      font-size: 1.2rem;
    }
    body.kid-mode .nav-item span {
      font-size: 1rem;
    }
    body.kid-mode .search-bar input {
      font-size: 1rem;
    }
    /* Main content area.  This section fills the page below the
       navbar.  We add a top margin equal to the navbar height to
       ensure the content does not scroll underneath it. */
    #content {
      padding: 20px;
      margin-top: 60px;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .search-bar {
      width: 100%;
      max-width: 400px;
    }
    .search-bar input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      background: var(--card-bg);
      color: var(--text);
      font-size: 0.9rem;
    }
    /* Grid for cards */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    body.kid-mode .card-grid {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }
    /* Pal and item cards */
    .pal-card, .item-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
      cursor: pointer;
      position: relative;
    }
    .pal-card:hover, .item-card:hover {
      transform: translateY(-4px);
      background: var(--card-hover);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .pal-card img, .item-card img {
      /* Increase the size of the images to make each pal and item
         card more visually striking and easier for younger players
         to recognise. */
      width: 100px;
      height: 100px;
      object-fit: contain;
      margin-bottom: 8px;
    }
    .pal-card .name, .item-card .name {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .pal-card .badge {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      color: var(--text);
      font-size: 0.8rem;
    }
    .pal-card .badge img {
      width: 22px;
      height: 22px;
    }
    .pal-card .rarity {
      font-size: 0.8rem;
      margin-bottom: 6px;
      color: var(--light);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }
    .pal-card .rarity .stars i {
      color: #E4B914;
      font-size: 0.8rem;
      margin-right: 2px;
    }
    .pal-card .rarity .label {
      color: var(--accent);
      font-weight: bold;
      text-transform: capitalize;
    }
    .pal-card .catch-btn {
      background: var(--success);
      border: none;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: background 0.2s;
    }
    .pal-card .catch-btn.caught {
      background: var(--secondary);
    }
    /* Modal */
    #modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 200;
    }
    #modal.active {
      opacity: 1;
      pointer-events: auto;
    }
    #modalContent {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    #modalClose {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }
    /* Environment map */
    #mapContainer {
      position: relative;
      width: 100%;
      margin: 10px 0;
      border-radius: 8px;
      overflow: hidden;
    }
    #mapContainer img {
      width: 100%;
      height: auto;
      display: block;
    }
    #mapOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #mapOverlay .zone {
      position: absolute;
      opacity: 0;
      background: var(--accent);
      border: 2px solid var(--light);
      /* Make the highlight circular/elliptical to better approximate
         natural habitats instead of square boxes */
      border-radius: 50%;
      transition: opacity 0.3s;
    }
    #mapOverlay .zone.active {
      /* Lower opacity for a gentler highlight that doesn’t overpower the map */
      opacity: 0.2;
    }
    /* Items */
    .item-card .name {
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .item-card .category {
      font-size: 0.75rem;
      color: var(--light);
      margin-bottom: 6px;
    }
    .item-card .drops {
      font-size: 0.7rem;
      color: var(--text);
    }
    .item-card .collect-btn {
      margin-top: 6px;
      background: var(--success);
      border: none;
      color: #fff;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .item-card .collect-btn.collected {
      background: var(--secondary);
    }
    /* Tech tree */
    .tech-level {
      margin-bottom: 20px;
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .tech-level h3 {
      margin-bottom: 10px;
    }
    .tech-item {
      margin-left: 10px;
      padding: 6px;
      border-left: 3px solid var(--secondary);
      margin-bottom: 6px;
    }
    .tech-item .materials {
      font-size: 0.8rem;
      color: var(--light);
    }
    .tech-item .unlock-btn {
      margin-top: 4px;
      background: var(--success);
      border: none;
      color: #fff;
      padding: 3px 5px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .tech-item .unlock-btn.unlocked {
      background: var(--secondary);
    }
    /* Breeding page */
    #breedingPage select {
      padding: 6px;
      margin-right: 8px;
      border-radius: 4px;
      border: none;
      background: var(--card-bg);
      color: var(--text);
    }
    #breedingPage button {
      padding: 6px 10px;
      background: var(--accent);
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    #breedingResult {
      margin-top: 10px;
    }
    /* Progress bars */
    .progress-bar {
      background: var(--card-bg);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-bar .fill {
      height: 16px;
      width: 0;
      background: var(--success);
      transition: width 0.5s;
    }
    .progress-label {
      font-size: 0.8rem;
      margin-bottom: 2px;
    }
    /* Custom scrollbars */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--primary);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--secondary);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- Top navigation bar.  We move away from the vertical sidebar and instead
       present a horizontal bar across the top of the page.  Each button
       contains an icon and label.  The active tab is highlighted
       via a coloured underline defined in CSS. -->
  <nav id="navbar">
    <div class="logo">Pal Marathon</div>
    <!-- Navigation items.  We add Home, Map, Route and Glossary to
         provide quick access to all major sections of the app.  The
         first item (Home) is active by default.  Icons chosen via
         Font Awesome provide an intuitive visual cue for each tab. -->
    <button class="nav-item active" data-page="home"><i class="fa-solid fa-house"></i><span>Home</span></button>
    <button class="nav-item" data-page="pals"><i class="fa-solid fa-paw"></i><span>Pals</span></button>
    <button class="nav-item" data-page="map"><i class="fa-solid fa-map"></i><span>Map</span></button>
    <button class="nav-item" data-page="route"><i class="fa-solid fa-road"></i><span>Route</span></button>
    <button class="nav-item" data-page="tech"><i class="fa-solid fa-cog"></i><span>Tech</span></button>
    <button class="nav-item" data-page="items"><i class="fa-solid fa-box"></i><span>Items</span></button>
    <button class="nav-item" data-page="glossary"><i class="fa-solid fa-book-open"></i><span>Glossary</span></button>
    <button class="nav-item" data-page="breeding"><i class="fa-solid fa-egg"></i><span>Breeding</span></button>
    <button class="nav-item" data-page="progress"><i class="fa-solid fa-chart-line"></i><span>Progress</span></button>
    <!-- Mode toggle button sits on the far right.  Clicking it
         switches between Kid Mode (simplified UI) and Grown‑up
         Mode (full details).  The icon updates accordingly. -->
    <button id="modeToggle" class="mode-btn" title="Switch to grown-up mode"><i class="fa-solid fa-child"></i></button>
  </nav>
  <div id="content">
      <!-- Home page -->
      <section id="homePage" class="page active">
        <header class="page-header">
          <h2>Tonight’s Plan</h2>
        </header>
        <p>Welcome to Pal Marathon, your companion guide for completing Palworld with your family. Use the quick cards below to get started on tonight’s adventure.</p>
        <div id="homeCards" class="card-grid"></div>
      </section>
      <!-- Pals page -->
      <section id="palsPage" class="page">
        <header class="page-header">
          <h2>Pals</h2>
          <div class="search-bar"><input id="palSearch" type="text" placeholder="Search pals by name or type..."></div>
        </header>
        <div id="palsList" class="card-grid"></div>
      </section>
      <!-- Items page -->
      <section id="itemsPage" class="page">
        <header class="page-header">
          <h2>Items</h2>
          <div class="search-bar"><input id="itemSearch" type="text" placeholder="Search items..."></div>
        </header>
        <div id="itemsList" class="card-grid"></div>
      </section>
      <!-- Map page -->
      <section id="mapPage" class="page">
        <header class="page-header">
          <h2>Map</h2>
        </header>
        <p>Explore Palpagos! Toggle layers to highlight points of interest. Open the interactive map for detailed navigation.</p>
        <div id="mapLayers" style="margin-bottom:10px;"></div>
        <!-- Interactive map iframe: embed the palworld.gg map directly in the app.  The iframe
             loads the external interactive map inside our site so you can browse
             without leaving the page.  For mobile or restricted browsers this
             may not display due to cross‑origin policies, so we also provide
             the static map below as a fallback. -->
        <div id="interactiveMapWrapper" style="width:100%; height:600px; border-radius:8px; overflow:hidden; margin-bottom:12px;">
          <iframe id="mapIframe" src="https://palworld.gg/map" style="width:100%; height:100%; border:none;" title="Palworld Interactive Map"></iframe>
        </div>
        <!-- Static map fallback with dynamic overlay for spawn highlights -->
        <div id="mapWrapper" style="position:relative; width:100%; border-radius:8px; overflow:hidden;">
          <img src="assets/images/palworld-full-map-2.webp" alt="Palworld map" style="width:100%;height:auto;">
          <div id="mapOverlayDynamic" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></div>
        </div>
      </section>
      <!-- Route page -->
      <section id="routePage" class="page">
        <header class="page-header">
          <h2>Route</h2>
        </header>
        <p>Follow this suggested order to conquer the tower bosses. Each card offers tips and links to recommended pals and gear.</p>
        <div id="routeList" class="card-grid"></div>
      </section>
      <!-- Tech page -->
      <section id="techPage" class="page">
        <header class="page-header">
          <h2>Technology Tree</h2>
        </header>
        <p>This section shows the Pal Sphere blueprints and materials you need. Check off recipes as you unlock them in your game.</p>
        <div id="techList"></div>
      </section>
      <!-- Breeding page -->
      <section id="breedingPage" class="page">
        <header class="page-header">
          <h2>Breeding Calculator</h2>
        </header>
        <p>Select two pals to see the predicted baby pal and get tips for breeding. Be sure to place a cake in the box to start breeding!</p>
        <div class="breeding-selectors">
          <select id="parent1"></select>
          <select id="parent2"></select>
          <button id="breedBtn">Predict Baby</button>
        </div>
        <div id="breedingResult"></div>
      </section>
      <!-- Progress page -->
      <section id="progressPage" class="page">
        <header class="page-header">
          <h2>Your Progress</h2>
        </header>
        <p>Track your adventure by marking pals you catch, items you gather and tech you unlock. Your progress is saved in this browser.</p>
        <div class="progress-section">
          <div class="progress-label">Pals caught</div>
          <div class="progress-bar"><div class="fill" id="palsProgress"></div></div>
          <div class="progress-label">Items collected</div>
          <div class="progress-bar"><div class="fill" id="itemsProgress"></div></div>
          <div class="progress-label">Tech unlocked</div>
          <div class="progress-bar"><div class="fill" id="techProgress"></div></div>
        </div>
      </section>
      <!-- Glossary page -->
      <section id="glossaryPage" class="page">
        <header class="page-header">
          <h2>Glossary</h2>
        </header>
        <p>Here you’ll find definitions for passives, moves, elements and work suitabilities. Tap any term to learn more.</p>
        <div id="glossaryContent"></div>
      </section>
    </div>
  </div>
  <!-- Modal for pal details -->
  <div id="modal">
    <div id="modalContent">
      <button id="modalClose">Close</button>
      <div id="modalBody"></div>
    </div>
  </div>
  <script>
    // Data variables
    let PALS = {};
    let ITEMS = {};
    let TECH = [];
    let ROUTE = [];
    let SKILL_DETAILS = {};
    let PASSIVE_DETAILS = {};
    // Map of items to pals that drop them.  Populated after data load.
    let DROPS_MAP = {};
    // Map pal names to IDs for quick lookup when clicking breeding
    // combos.  Populated after data load.
    let PAL_NAME_TO_ID = {};
    // Progress tracking
    let caught = JSON.parse(localStorage.getItem('caught') || '{}');
    let collected = JSON.parse(localStorage.getItem('collected') || '{}');
    let unlocked = JSON.parse(localStorage.getItem('unlocked') || '{}');
    // Maximum stats for scaling radar chart
    // Maximum stats for scaling radar chart.  Speed is capped lower to avoid
    // overpowering the chart – the fastest pals reach around 1000.
    const maxStats = { hp: 150, attack: 150, defense: 145, speed: 1000, stamina: 350, support: 150, food: 9 };
    // Type to environment mapping
    const environmentMap = {
      'Fire': 'Volcano',
      'Ice': 'Snow',
      'Electric': 'Coast',
      'Water': 'River',
      'Grass': 'Forest',
      'Ground': 'Desert',
      'Dark': 'Swamp',
      'Dragon': 'Mountains',
      'Air': 'Highlands',
      'Neutral': 'Plains'
    };
    // Rarity to recommended sphere
    const raritySphere = {
      1: 'Pal Sphere',
      2: 'Mega Sphere',
      3: 'Giga Sphere',
      4: 'Hyper Sphere',
      5: 'Ultra Sphere',
      6: 'Legendary Sphere'
    };
    // Human-friendly rarity names for better readability on cards and details.
    const rarityNames = {
      1: 'Common',
      2: 'Uncommon',
      3: 'Rare',
      4: 'Epic',
      5: 'Legendary',
      6: 'Mythic'
    };
    // Sphere capture rates and descriptions (approximate for guidance)
    const sphereRates = {
      'Pal Sphere': { rate: 0.3, description: 'Good for beginners and low-level pals (Lv 1-15)' },
      'Mega Sphere': { rate: 0.45, description: 'Better success for mid-level pals (Lv 16-30)' },
      'Giga Sphere': { rate: 0.6, description: 'Ideal for stronger pals (Lv 31-45)' },
      'Hyper Sphere': { rate: 0.75, description: 'Very high success for tough pals (Lv 46-60)' },
      'Ultra Sphere': { rate: 0.85, description: 'Excellent for very tough pals (Lv 61-70)' },
      'Legendary Sphere': { rate: 1.0, description: 'Guaranteed catch for legendary pals (Lv 71+)' }
    };
    // Trait lists for guidance (simplified)
    const goodTraits = ['Diligent', 'Runner', 'Strong', 'Loyal'];
    const badTraits = ['Coward', 'Lazy', 'Gullible'];

    // Whether we’re in Kid Mode.  Kid Mode simplifies the UI by
    // enlarging fonts, hiding advanced stats and using shorter
    // explanations.  Start in kid mode by default; toggled via the
    // mode button in the nav bar.
    let kidMode = true;

    // Descriptions for active skills.  Each entry maps the skill key
    // (as it appears in the data) to a human-friendly object with
    // damage, type (AoE, cone, single-target) and a brief description
    // gleaned from community knowledge and official guides.  When
    // unknown, we provide a generic description encouraging players to
    // experiment.  Feel free to extend this dictionary with more
    // abilities as you discover them.
    const skillsDictionary = {
      'rolly_poly': { name:'Roly Poly', damage:'Low', type:'Charge', description:'Curls into a ball and rolls after foes; be careful as you may become dizzy afterwards' },
      'air_cannon': { name:'Air Cannon', damage:'Moderate', type:'Projectile', description:'Fires compressed air that pushes enemies back in a line' },
      'power_shot': { name:'Power Shot', damage:'Moderate', type:'Projectile', description:'Charges up and fires a strong projectile at a single target' },
      'implode': { name:'Implode', damage:'Massive', type:'Area', description:'Self-destructs in a powerful explosion harming all nearby – the user faints afterwards' },
      'electric_ball': { name:'Electric Ball', damage:'High', type:'Projectile', description:'Launches a ball of lightning that zaps enemies on contact' },
      'dragon_burst': { name:'Dragon Burst', damage:'High', type:'Area', description:'Unleashes draconic energy in a burst around the user' },
      'fire_blast': { name:'Fire Blast', damage:'High', type:'Cone', description:'Breathes fire in a wide cone, burning anything in its path' },
      'leaf_dance': { name:'Leaf Dance', damage:'Moderate', type:'Area', description:'Summons swirling leaves that slice nearby enemies' }
    ,
      // Additional skills with descriptions derived from the Palworld Wiki【841863502450800†L124-L156】.  These give
      // players a better sense of each move’s effect.
      'acid_rain': { name:'Acid Rain', damage:'Moderate', type:'Area', description:'Creates acidic clouds that pour down rain on enemies' },
      'air_blade': { name:'Air Blade', damage:'Moderate', type:'Fan', description:'Sends out sharp blades of air in a fan shape' },
      'apocalypse': { name:'Apocalypse', damage:'High', type:'Area', description:'Generates several dark vortexes in the surrounding area' },
      'aqua_burst': { name:'Aqua Burst', damage:'High', type:'Projectile', description:'Creates a giant ball of water and hurls it at an enemy' },
      'aqua_gun': { name:'Aqua Gun', damage:'Low', type:'Projectile', description:'Hurls a ball of water straight at an enemy' },
      'beam_slicer': { name:'Beam Slicer', damage:'Very High', type:'Beam', description:'Mows down the frontal area with a dragon beam; the impacted area explodes shortly after' },
      'blast_cannon': { name:'Blast Cannon', damage:'High', type:'Projectile', description:'Fires an energy bullet imbued with dragon power that explodes on impact' },
      'blizzard_spike': { name:'Blizzard Spike', damage:'Very High', type:'Projectile', description:'Creates a giant lump of ice and hurls it; damages those in the surrounding area upon impact' },
      'bog_blast': { name:'Bog Blast', damage:'Low', type:'Projectile', description:'Hurls sticky mud at an enemy' },
      'bubble_blast': { name:'Bubble Blast', damage:'Moderate', type:'Homing', description:'Fires numerous bubbles that slowly pursue an enemy' },
      'circle_vine': { name:'Circle Vine', damage:'High', type:'Area', description:'Sprouts sharp roots in and around the enemy’s location' },
      'comet_strike': { name:'Comet Strike', damage:'High', type:'Area', description:'Drops a meteorite straight down, generating a shock wave around the impact area' },
      'cryst_breath': { name:'Cryst Breath', damage:'High', type:'Cone', description:'Enshrouds an enemy in a frigid blast of air, dealing continuous damage' },
      'dark_arrow': { name:'Dark Arrow', damage:'Moderate', type:'Homing', description:'Fires off dark energy that homes in on an enemy' },
      'dark_ball': { name:'Dark Ball', damage:'Low', type:'Homing', description:'Unleashes a sphere of darkness that slowly tracks down the enemy' },
      'dark_cannon': { name:'Dark Cannon', damage:'Moderate', type:'Projectile', description:'Fires off dark energy that homes in on an enemy' },
      'dark_laser': { name:'Dark Laser', damage:'Very High', type:'Beam', description:'Charges dark energy before blasting enemies with a powerful beam' },
      'diamond_rain': { name:'Diamond Rain', damage:'Very High', type:'Area', description:'Creates numerous lumps of ice that consecutively drop on a foe’s head' },
      'draconic_breath': { name:'Draconic Breath', damage:'Moderate', type:'Cone', description:'Exhales breath imbued with draconic energy, dealing continuous damage to those in front' },
      'dragon_cannon': { name:'Dragon Cannon', damage:'Low', type:'Projectile', description:'Hurls an energy ball imbued with draconic energy at an enemy' },
      'dragon_meteor': { name:'Dragon Meteor', damage:'Very High', type:'Area', description:'Calls down numerous small meteorites and launches them at an enemy' },
      'fire_ball': { name:'Fire Ball', damage:'Very High', type:'Projectile', description:'Creates a giant ball of flames and hurls it; it explodes over a wide area upon impact' },
      'flame_funnel': { name:'Flame Funnel', damage:'High', type:'Area', description:'Creates multiple spheres of fiery energy, from which countless fireballs shoot towards the enemy' },
      'flame_wall': { name:'Flame Wall', damage:'High', type:'Area', description:'Creates a wall of flames at the enemy’s location; the wall remains and deals damage over time' },
      'flare_arrow': { name:'Flare Arrow', damage:'Moderate', type:'Homing', description:'Fires three flaming arrows in succession that home in on an enemy' },
      'flare_storm': { name:'Flare Storm', damage:'Moderate', type:'Area', description:'Generates two flaming tornadoes on either side before launching them at an enemy' }
    };

    // Descriptions for passive traits.  Each entry summarises the
    // benefits or drawbacks of the trait.  We extracted a few from
    // community guides and added our own commentary for others.  Add
    // additional traits here as needed.  Traits not present here
    // will display a generic encouragement to experiment.
    const traitsDictionary = {
      'Swift': 'Increases movement speed by 30%, letting your pal dash around quickly',
      'Legend': 'Raises Attack and Defense by 20% and Movement Speed by 15%',
      'Lord of the Sea': 'Increases Water attack damage by 20%',
      'Runner': 'Boosts movement speed by 20%',
      'Diligent': 'Raises work efficiency, making jobs go 20% faster',
      'Strong': 'Increases attack damage by 20%',
      'Loyal': 'Improves Attack and Defense slightly (about 10%)',
      'Coward': 'Lowers Attack and Defense by 10%; this pal gets scared easily',
      'Lazy': 'Decreases work speed by 20%, making tasks take longer',
      'Gullible': 'More susceptible to negative status effects; be wary when battling'
    };

    // Mapping of environment names to highlight coordinates.  Each
    // environment corresponds to a circular highlight on the map.  The
    // x and y values represent the percentage offsets from the top-left
    // corner of the map image, while w and h represent the diameter
    // percentages of the highlight.  These were chosen manually to
    // approximate the Palworld regions and provide a more natural
    // spotlight compared to boxy overlays.
    const zonePositions = {
      'Volcano': { x: 68, y: 10, w: 30, h: 30 },
      'Snow': { x: 10, y: 10, w: 25, h: 25 },
      'Plains': { x: 40, y: 50, w: 35, h: 35 },
      'Forest': { x: 12, y: 55, w: 25, h: 25 },
      'Coast': { x: 78, y: 60, w: 25, h: 25 },
      'Desert': { x: 50, y: 65, w: 25, h: 25 },
      'Swamp': { x: 85, y: 45, w: 20, h: 20 },
      'Mountains': { x: 50, y: 20, w: 25, h: 25 },
      'Highlands': { x: 40, y: 5, w: 30, h: 20 },
      'River': { x: 5, y: 70, w: 25, h: 20 }
    };

    // Route definitions.  Each entry describes a tower boss encounter
    // along the Pal Marathon journey, including the recommended
    // element(s) to bring and a short description.  Use these
    // entries to build the Route page.  Level ordering taken from
    // community consensus and our own research.
    const DEFAULT_ROUTE = [
      {
        step: 1,
        name: 'Rayne Syndicate Tower',
        boss: 'Zoe & Grizzbolt',
        element: 'Electric',
        weakness: ['Ground'],
        hp: 30000,
        description: 'The first tower encounter. Ground-type pals stun Grizzbolt and keep Zoe on the back foot.',
        location: 'Windswept Hills (112, -434)',
        tips: 'Stock up on basic healing items and bring a Ground mount to dodge lightning strikes.',
        steps: [
          'Gather Ground-type pals or moves before entering the arena.',
          'Repair your gear and craft Pal Spheres for quick captures.',
          'Use fast travel to reach Windswept Hills and clear the approach.',
          'Stay mobile and punish Grizzbolt after each telegraphed blast.'
        ]
      },
      {
        step: 2,
        name: 'Free Pal Alliance Tower',
        boss: 'Lily & Lyleen',
        element: 'Grass',
        weakness: ['Fire'],
        hp: 69000,
        description: 'An arctic siege led by Lily. Fire-element pals melt Lyleen’s defenses.',
        location: 'Free Pal Alliance territory (185, 28)',
        tips: 'Wear cold-resistance armor and bring heat sources for the climb.',
        steps: [
          'Assemble a Fire-heavy team with ranged attacks for the arena.',
          'Carry thawing medicine, food, and a portable heat source.',
          'Navigate the frozen approach carefully to avoid adds.',
          'Burn down Lyleen quickly to prevent healing bursts.'
        ]
      },
      {
        step: 3,
        name: 'Brothers of the Eternal Pyre Tower',
        boss: 'Axel & Orserk',
        element: 'Electric/Dragon',
        weakness: ['Ground', 'Ice'],
        hp: 130000,
        description: 'A volcanic gauntlet with heavy lightning output. Ice or Ground pals blunt Orserk’s power.',
        location: 'Volcanic island (approx.)',
        tips: 'Equip heat-resistant armor and plan a safe water crossing.',
        steps: [
          'Sail or glide to the volcanic island with cooling gear ready.',
          'Keep ice weapons or Ground projectiles handy for staggers.',
          'Clear local mobs quickly to secure the arena.',
          'Focus Orserk first, then clean up Axel at range.'
        ]
      },
      {
        step: 4,
        name: 'PIDF Tower',
        boss: 'Marcus & Faleris',
        element: 'Fire',
        weakness: ['Water'],
        hp: 168000,
        description: 'Aerial inferno. Water and Ice pals extinguish Faleris and ground Marcus.',
        location: 'PIDF territory (350, -200)',
        tips: 'Bring ranged Water attacks and fireproof cloaks for the arena.',
        steps: [
          'Craft Water ammunition and restock high-tier healing supplies.',
          'Approach via high ground to avoid patrols.',
          'Spread out to dodge Faleris’ firestorms.',
          'Douse Marcus once Faleris drops to end the fight.'
        ]
      },
      {
        step: 5,
        name: 'PAL Genetic Research Unit Tower',
        boss: 'Victor & Shadowbeak',
        element: 'Dark',
        weakness: ['Dragon'],
        hp: 205000,
        description: 'Shadowbeak’s dark beams demand high burst damage. Dragon pals shine here.',
        location: 'PAL Genetic Research Unit (558, 340)',
        tips: 'Carry light sources and stamina food to keep pressure high.',
        steps: [
          'Deploy Dragon pals resistant to Dark projectiles.',
          'Keep moving to avoid beam barrages.',
          'Use stagger windows to burst Shadowbeak down.',
          'Finish Victor before he calls reinforcements.'
        ]
      },
      {
        step: 6,
        name: 'Moonflower Tower',
        boss: 'Saya & Selyne',
        element: 'Ice/Dragon',
        weakness: ['Dragon'],
        hp: 240000,
        description: 'Celestial strikes mix Ice and Dragon damage. Bring resilient Dragons with sustain.',
        location: 'Moonflower tower (640, -410)',
        tips: 'Use frost resistance consumables and anti-Dragon armor plates.',
        steps: [
          'Prepare Dragon pals with healing passives or potions.',
          'Avoid lingering in the center to dodge lunar blasts.',
          'Burst Selyne between beam volleys.',
          'Interrupt Saya’s support skills with staggers.'
        ]
      },
      {
        step: 7,
        name: 'Tower of the Brothers of the Iron Hammer',
        boss: 'Bjorn & Bastigor',
        element: 'Ice',
        weakness: ['Fire'],
        hp: 310000,
        description: 'The final snowbound duel. Fire pals cut through Bastigor’s armor and warm the arena.',
        location: 'Bastion of the Iron Hammer (730, -50)',
        tips: 'Pack hot drinks and ignite brazier traps to thaw the arena.',
        steps: [
          'Assemble Fire pals with high stagger potential.',
          'Destroy ice pillars to open movement lanes.',
          'Focus Bastigor while Bjorn reloads his cannons.',
          'Celebrate and loot the tower chest after victory.'
        ]
      }
    ];
    ROUTE = DEFAULT_ROUTE.map(step => ({ ...step }));
    const DATA_SOURCES = [
      'data/palworld_complete_data_final.json',
      'data/palworld_complete_data_enhanced.json',
      'data/palworld_complete_data.json'
    ];
    const EMBEDDED_DATA_SCRIPT = 'data/palworld_complete_data_fallback.js';
    let embeddedDataPromise = null;

    async function loadEmbeddedDataset() {
      if (window.__PALMATE_EMBEDDED_DATA__) {
        return window.__PALMATE_EMBEDDED_DATA__;
      }
      if (!embeddedDataPromise) {
        embeddedDataPromise = new Promise(resolve => {
          const script = document.createElement('script');
          script.src = EMBEDDED_DATA_SCRIPT;
          script.async = true;
          script.onload = () => resolve(window.__PALMATE_EMBEDDED_DATA__ || null);
          script.onerror = event => {
            console.warn('Unable to load embedded dataset script.', event);
            resolve(null);
          };
          document.head.appendChild(script);
        });
      }
      try {
        return await embeddedDataPromise;
      } catch (err) {
        console.warn('Embedded dataset loader failed.', err);
        return null;
      }
    }
    // Type icon mapping (relative file paths)
    const iconMap = {
      'Neutral': 'assets/icons/neutral.png',
      'Fire': 'assets/icons/fire.png',
      'Ice': 'assets/icons/ice.png',
      'Electric': 'assets/icons/electric.png',
      'Water': 'assets/icons/water.png',
      'Grass': 'assets/icons/grass.png',
      'Ground': 'assets/icons/ground.png',
      'Dark': 'assets/icons/dark.png',
      'Dragon': 'assets/icons/dragon.png',
      'Air': 'assets/icons/air.png'
    };

    // Audio cues for a more immersive UI.  Users can add their own sound files
    // (e.g. click.mp3, modal_open.mp3, modal_close.mp3) inside assets/sounds.
    const clickSound = new Audio('assets/sounds/click.mp3');
    const openSound = new Audio('assets/sounds/modal_open.mp3');
    const closeSound = new Audio('assets/sounds/modal_close.mp3');
    function playSound(sound) {
      // Gracefully handle missing audio files
      if (!sound || typeof sound.play !== 'function') return;
      try {
        sound.currentTime = 0;
        sound.play();
      } catch (err) {
        // Audio play can fail if files are missing or browser policy blocks it
        console.debug('Sound error', err);
      }
    }
    // Navigation handling: top nav bar.  Each .nav-item button
    // switches to its associated page when clicked.  After the
    // switch, we play a click sound.
    document.querySelectorAll('#navbar .nav-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-page');
        switchPage(target);
        playSound(clickSound);
      });
    });

    // Mode toggle button: switch between kid and grown-up modes.  The
    // icon and tooltip change based on the current mode.  We also
    // apply a class on the body for CSS adjustments and rebuild
    // pages to honour the new mode (e.g. hiding advanced stats).
    document.getElementById('modeToggle').addEventListener('click', () => {
      kidMode = !kidMode;
      document.body.classList.toggle('kid-mode', kidMode);
      const modeIcon = document.querySelector('#modeToggle i');
      const toggleTitle = document.getElementById('modeToggle');
      if (kidMode) {
        modeIcon.classList.remove('fa-user-astronaut');
        modeIcon.classList.add('fa-child');
        toggleTitle.title = 'Switch to grown-up mode';
      } else {
        modeIcon.classList.remove('fa-child');
        modeIcon.classList.add('fa-user-astronaut');
        toggleTitle.title = 'Switch to kid mode';
      }
      // Rebuild dynamic pages to reflect the mode change
      buildPalPage();
      buildItemPage();
      buildTechPage();
      buildRoutePage();
      buildGlossaryPage();
      // Home page re-render to update suggestions styling
      buildHomePage();
    });
    function switchPage(page) {
      // Hide all pages and show the selected page.  Our pages are
      // <section> elements with IDs like palsPage, itemsPage, etc.
      document.querySelectorAll('.page').forEach(section => section.classList.remove('active'));
      const activePage = document.getElementById(page + 'Page');
      if (activePage) activePage.classList.add('active');
      // Update navigation item active state
      document.querySelectorAll('#navbar .nav-item').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-page') === page);
      });
    }
    // Modal controls
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    document.getElementById('modalClose').addEventListener('click', closeModal);
    function openModal() {
      modal.classList.add('active');
      playSound(openSound);
    }
    function closeModal() {
      modal.classList.remove('active');
      modalBody.innerHTML = '';
      playSound(closeSound);
    }
    async function loadDatasetSequentially() {
      const isFileProtocol = window.location.protocol === 'file:';
      if (isFileProtocol) {
        const embeddedPayload = await loadEmbeddedDataset();
        if (embeddedPayload) {
          return { payload: embeddedPayload, source: 'embedded fallback dataset' };
        }
        console.warn('File protocol detected but embedded dataset fallback was unavailable. Continuing with fetch attempts.');
      }
      const loadErrors = [];
      for (const source of DATA_SOURCES) {
        try {
          const response = await fetch(source);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const payload = await response.json();
          if (!payload || typeof payload !== 'object') {
            throw new Error('Invalid JSON payload');
          }
          if (!payload.pals || !payload.items || !payload.tech) {
            console.warn(`Dataset ${source} missing required keys. Skipping.`);
            continue;
          }
          return { payload, source };
        } catch (err) {
          loadErrors.push({ source, error: err });
          console.warn(`Failed to load dataset ${source}`, err);
        }
      }
      const embeddedFallback = await loadEmbeddedDataset();
      if (embeddedFallback) {
        return { payload: embeddedFallback, source: 'embedded fallback dataset' };
      }
      const errorSummary = loadErrors.length
        ? loadErrors.map(entry => {
            const reason = entry.error && entry.error.message ? entry.error.message : entry.error;
            return `${entry.source} (${reason})`;
          }).join('; ')
        : '';
      const summarySuffix = errorSummary ? ` ${errorSummary}` : '';
      throw new Error(`Unable to load any dataset from the data folder.${summarySuffix}`);
    }

    (async function initialisePalmate() {
      try {
        const { payload, source } = await loadDatasetSequentially();
        console.info(`Palmate data source: ${source}`);
        // Data is namespaced under pals, items and tech plus extra sections
        PALS = payload.pals || {};
        ITEMS = payload.items || {};
        TECH = payload.tech || [];
        const hasRouteTable = Array.isArray(payload.route) && payload.route.length;
        if (!hasRouteTable) {
          console.warn('Loaded dataset does not contain a route table. Falling back to bundled defaults.');
        }
        ROUTE = hasRouteTable ? payload.route : DEFAULT_ROUTE.map(step => ({ ...step }));
        SKILL_DETAILS = payload.skillsDetails || {};
        PASSIVE_DETAILS = payload.passiveDetails || {};
        // Build name‑to‑ID lookup map
        PAL_NAME_TO_ID = {};
        Object.values(PALS).forEach(p => {
          PAL_NAME_TO_ID[p.name] = p.id;
        });
        // Build a global map of item drops for quick lookup
        DROPS_MAP = {};
        Object.values(PALS).forEach(pal => {
          (pal.drops || []).forEach(item => {
            if (!DROPS_MAP[item]) DROPS_MAP[item] = [];
            DROPS_MAP[item].push(pal.name);
          });
        });
        // Build pages
        buildPalPage();
        buildItemPage();
        buildTechPage();
        buildBreedingPage();
        buildHomePage();
        buildRoutePage();
        // Synchronise skills and traits dictionaries with the loaded data.
        // Override the static dictionaries with entries from the JSON file.
        skillsDictionary = {};
        Object.keys(SKILL_DETAILS).forEach(key => {
          const info = SKILL_DETAILS[key] || {};
          skillsDictionary[key] = {
            name: (info.name || key).replace(/_/g, ' '),
            damage: info.damage || 'Unknown',
            type: info.type || 'Unknown',
            description: info.description || 'No description available.'
          };
        });
        traitsDictionary = {};
        Object.keys(PASSIVE_DETAILS).forEach(key => {
          traitsDictionary[key] = PASSIVE_DETAILS[key];
        });
        buildGlossaryPage();
        buildMapPage();
        buildProgressPage();
        updateProgressUI();
      } catch (err) {
        console.error(err);
        const reason = err && err.message ? ` (${err.message})` : '';
        const extraHelp = window.location.protocol === 'file:'
          ? ' Launching a local web server or regenerating data/palworld_complete_data_fallback.js usually resolves file:// restrictions.'
          : ' Please confirm that the data folder is deployed with the site.';
        document.body.insertAdjacentHTML('beforeend', `<p style="color:red">Failed to load data${reason}.${extraHelp}</p>`);
      }
    })();
    // Build pal page
    function buildPalPage() {
      const list = document.getElementById('palsList');
      const search = document.getElementById('palSearch');
      function render(filter = '') {
        list.innerHTML = '';
        const term = filter.toLowerCase();
        Object.values(PALS).forEach(pal => {
          if (!pal.name.toLowerCase().includes(term) && !pal.types.join(',').toLowerCase().includes(term)) return;
          const card = document.createElement('div');
          card.className = 'pal-card';
          // Build type icon HTML
          const typeIcons = pal.types.map(t => `<img src="${iconMap[t] || iconMap['Neutral']}" alt="${t} icon" style="width:20px;height:20px;margin-right:2px;">`).join('');
          // Render the pal card. Use the local image if available. If the image fails to load
          // (for example, if the pal image file is missing), fall back to the first element
          // icon so the card always has a visual cue. The onerror handler sets the source
          // to the appropriate icon based on the pal’s primary type.
          // Build rarity label and star icons.  Rarity names add readability and
          // stars provide a quick visual indicator.  We use Font Awesome stars
          // here to ensure consistent sizing and colour.
          const rarity = Math.max(1, Math.min(pal.rarity || 0, 6));
          let rarityLabel = rarityNames[rarity] || '';
          let starIcons = Array(rarity).fill('<i class="fa-solid fa-star"></i>').join('');
          // In kid mode we suppress rarity and stars to avoid
          // confusion and clutter.  Kids can still see the card
          // colour and image to gauge rarity implicitly.
          if (kidMode) {
            rarityLabel = '';
            starIcons = '';
          }
          card.innerHTML = `
            <img src="${pal.localImage || iconMap[pal.types[0]] || iconMap['Neutral']}" alt="${pal.name} image"
                 onerror="this.onerror=null; this.src='${'assets/icons/'}${pal.types[0].toLowerCase()}.png';">
            <div class="name">${pal.name}</div>
            <div class="badge">${typeIcons}</div>
            <div class="rarity"><span class="stars">${starIcons}</span> <span class="label">${rarityLabel}</span></div>
            <button class="catch-btn ${caught[pal.id] ? 'caught' : ''}">${caught[pal.id] ? 'Caught' : 'Catch'}</button>
          `;
          card.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() === 'button') return;
            showPalDetail(pal.id);
          });
          const btn = card.querySelector('button');
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            caught[pal.id] = !caught[pal.id];
            localStorage.setItem('caught', JSON.stringify(caught));
            btn.classList.toggle('caught', caught[pal.id]);
            btn.textContent = caught[pal.id] ? 'Caught' : 'Catch';
            updateProgressUI();
            playSound(clickSound);
          });
          list.appendChild(card);
        });
      }
      search.addEventListener('input', () => render(search.value));
      render();
    }
    // Show pal details in modal
    function showPalDetail(id) {
      const pal = PALS[id];
      if (!pal) return;
      modalBody.innerHTML = '';
      const container = document.createElement('div');
      // Header with icon and name
      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.alignItems = 'center';
      header.style.gap = '12px';
      // Use the local Pal image for the detail header
      const img = document.createElement('img');
      img.src = pal.localImage || iconMap[pal.types[0]] || iconMap['Neutral'];
      img.style.width = '120px';
      img.style.height = '120px';
      img.style.borderRadius = '8px';
      // Fallback in case the Pal image fails to load. Replace it with the primary type icon.
      img.onerror = () => {
        img.onerror = null;
        img.src = iconMap[pal.types[0]] || iconMap['Neutral'];
      };
      const titleWrap = document.createElement('div');
      // Build type icons row for the header
      const typesHtml = pal.types.map(t => `<img src="${iconMap[t] || iconMap['Neutral']}" alt="${t}" style="width:20px;height:20px;margin-right:4px;">`).join('');
      // Build rarity label and stars for the detail header
      const rarity = Math.max(1, Math.min(pal.rarity || 0, 6));
      const rLabel = rarityNames[rarity] || '';
      const rStars = Array(rarity).fill('<i class="fa-solid fa-star" style="color:#E4B914"></i>').join('');
      titleWrap.innerHTML = `<h3>${pal.name}</h3><div style="font-size:0.8rem;color:var(--light);display:flex;align-items:center;gap:6px;">${typesHtml}<span class="rarity-label" style="color:var(--accent);font-weight:bold;">${rLabel}</span><span class="rarity-stars">${rStars}</span></div>`;
      header.appendChild(img);
      header.appendChild(titleWrap);
      container.appendChild(header);
      // Basic info.  In kid mode we omit price to keep it simple.
      const info = document.createElement('div');
      info.style.margin = '10px 0';
      let infoHtml = `<strong>Genus:</strong> ${pal.genus}<br><strong>Size:</strong> ${pal.size.toUpperCase()}`;
      if (!kidMode) infoHtml += `<br><strong>Price:</strong> ${pal.price} G`;
      info.innerHTML = infoHtml;
      container.appendChild(info);
      // Habitat / spawn areas info.  Show all configured spawn
      // regions if available; fall back to the generic environment
      // mapping.  Provide a button to open the map page for further
      // exploration.
      const habitats = pal.spawnAreas && pal.spawnAreas.length ? pal.spawnAreas : [environmentMap[pal.types[0]] || 'Unknown'];
      const envInfo = document.createElement('div');
      envInfo.style.marginTop = '4px';
      envInfo.innerHTML = `<strong>Habitat:</strong> ${habitats.join(', ')}`;
      // Add an "Open on Map" button that brings the user to the Map page
      const mapBtn = document.createElement('button');
      mapBtn.textContent = 'Open on Map';
      mapBtn.className = 'collect-btn';
      mapBtn.style.marginLeft = '8px';
      mapBtn.addEventListener('click', () => {
        // Switch to map page and scroll into view
        switchPage('mapPage');
      });
      envInfo.appendChild(mapBtn);
      container.appendChild(envInfo);
      // Capture advice.  In kid mode we shorten the description.
      const sphere = raritySphere[pal.rarity] || 'Pal Sphere';
      const sRate = sphereRates[sphere];
      const sphereInfo = document.createElement('div');
      if (kidMode) {
        sphereInfo.innerHTML = `<strong>Catch Tip:</strong> Use a ${sphere}.`;
      } else {
        sphereInfo.innerHTML = `<strong>Recommended Sphere:</strong> ${sphere} – ${(sRate.rate * 100).toFixed(0)}% chance. ${sRate.description}`;
      }
      container.appendChild(sphereInfo);
      // Traits info.  In kid mode we provide a simple explanation rather
      // than lists.  In grown-up mode we link to trait definitions.
      const traitInfo = document.createElement('div');
      if (kidMode) {
        traitInfo.innerHTML = `<strong>Traits:</strong> Some pals have special traits that make them fast, strong or clever. Collect many pals to discover them!`;
      } else {
        const goodLinks = goodTraits.map(t => `<a href="#" class="trait-link" data-trait="${t}">${t}</a>`).join(', ');
        const badLinks = badTraits.map(t => `<a href="#" class="trait-link" data-trait="${t}">${t}</a>`).join(', ');
        traitInfo.innerHTML = `<strong>Traits:</strong> Good traits include ${goodLinks}. Bad traits include ${badLinks}. Breeding can pass traits down to babies!`;
      }
      container.appendChild(traitInfo);
      // Radar chart.  Only render in grown-up mode to avoid
      // overwhelming kids with numbers.  In kid mode we leave it
      // out entirely.
      if (!kidMode) {
        const canvas = document.createElement('canvas');
        canvas.width = 300;
        canvas.height = 300;
        container.appendChild(canvas);
        // Stats chart data
        const statValues = ['hp','attack','defense','speed','stamina','support','food'];
        const chartData = statValues.map(k => Math.round(pal.stats[k] / maxStats[k] * 100));
        new Chart(canvas.getContext('2d'), {
          type: 'radar',
          data: {
            labels: ['HP','ATK','DEF','SPD','STA','SUP','FOOD'],
            datasets: [{
              label: pal.name,
              data: chartData,
              fill: true,
              backgroundColor: 'rgba(119,141,169,0.3)',
              borderColor: 'rgba(119,141,169,0.8)',
              pointBackgroundColor: 'rgba(119,141,169,1)'
            }]
          },
          options: {
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                grid: { color: 'rgba(255,255,255,0.1)' },
                pointLabels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
      // Work skills
      if (kidMode) {
        // Summarise work roles in a single sentence
        const summary = document.createElement('div');
        summary.style.marginTop = '10px';
        if (pal.work && Object.keys(pal.work).length) {
          const roles = Object.keys(pal.work).join(', ');
          summary.innerHTML = `<strong>Base Jobs:</strong> ${roles}`;
        } else {
          summary.innerHTML = `<strong>Base Jobs:</strong> None`;
        }
        container.appendChild(summary);
      } else {
        const workDiv = document.createElement('div');
        workDiv.style.marginTop = '10px';
        let workHtml = '<strong>Work Skills:</strong> ';
        if (pal.work && Object.keys(pal.work).length) {
          workHtml += '<ul>';
          for (const skill in pal.work) {
            workHtml += `<li>${skill} (Lv ${pal.work[skill]})</li>`;
          }
          workHtml += '</ul>';
        } else {
          workHtml += 'None';
        }
        workDiv.innerHTML = workHtml;
        container.appendChild(workDiv);
      }
      // Active skills
      if (kidMode) {
        const skillsDiv = document.createElement('div');
        skillsDiv.style.marginTop = '10px';
        let skillsHtml = '<strong>Skills:</strong> ';
        if (pal.skills && pal.skills.length) {
          const names = pal.skills.map(s => s.name.replace(/_/g,' '));
          skillsHtml += names.join(', ');
        } else {
          skillsHtml += 'None';
        }
        skillsDiv.innerHTML = skillsHtml;
        container.appendChild(skillsDiv);
      } else {
        const skillsDiv = document.createElement('div');
        skillsDiv.style.marginTop = '10px';
        let skillsHtml = '<strong>Active Skills:</strong> ';
        if (pal.skills && pal.skills.length) {
          skillsHtml += '<ul>';
          pal.skills.forEach(s => {
            const rawName = s.name;
            const humanName = rawName.replace(/_/g, ' ');
            skillsHtml += `<li><a href="#" class="skill-link" data-skill="${rawName}">${humanName}</a> (Lv ${s.level}, Power ${s.power}, CD ${s.cooldown}s)</li>`;
          });
          skillsHtml += '</ul>';
        } else {
          skillsHtml += 'None';
        }
        skillsDiv.innerHTML = skillsHtml;
        container.appendChild(skillsDiv);
      }
      // Drops
      if (kidMode) {
        const dropDiv = document.createElement('div');
        dropDiv.style.marginTop = '10px';
        let dropsHtml = '<strong>Drops:</strong> ';
        if (pal.drops && pal.drops.length) {
          dropsHtml += pal.drops.map(item => item.replace(/_/g,' ')).join(', ');
        } else {
          dropsHtml += 'None';
        }
        dropDiv.innerHTML = dropsHtml;
        container.appendChild(dropDiv);
      } else {
        const dropDiv = document.createElement('div');
        dropDiv.style.marginTop = '10px';
        let dropsHtml = '<strong>Drops:</strong> ';
        if (pal.drops && pal.drops.length) {
          dropsHtml += '<ul>';
          pal.drops.forEach(item => {
            const cat = ITEMS[item] ? ITEMS[item].category : 'Unknown';
            const human = item.replace(/_/g,' ');
            dropsHtml += `<li><a href="#" class="item-link" data-item="${item}">${human}</a> (${cat})</li>`;
          });
          dropsHtml += '</ul>';
        } else {
          dropsHtml += 'None';
        }
        dropDiv.innerHTML = dropsHtml;
        container.appendChild(dropDiv);
      }
      // Breeding info
      if (!kidMode) {
        const breedDiv = document.createElement('div');
        breedDiv.style.marginTop = '10px';
        breedDiv.innerHTML = `<strong>Breeding Power:</strong> ${pal.breeding.power}<br><strong>Types:</strong> ${pal.breeding.type1}${pal.breeding.type2 ? ' / ' + pal.breeding.type2 : ''}<br>Babies inherit traits and stats from both parents. Average the parents’ breeding power to predict the baby!`;
        container.appendChild(breedDiv);
      }
      // Breeding combos section.  Show a list of parent pairs that can
      // produce this pal.  Each parent name is clickable to view its
      // details.  We clamp to a reasonable number of combos to
      // avoid overwhelming the UI.  If no combos exist, skip this
      // section.
      if (!kidMode && pal.breedingCombos && pal.breedingCombos.length) {
        const combosDiv = document.createElement('div');
        combosDiv.style.marginTop = '10px';
        let combosHtml = '<strong>Breeding Combos:</strong><ul>';
        pal.breedingCombos.slice(0, 5).forEach(pair => {
          const p1 = pair[0];
          const p2 = pair[1];
          combosHtml += `<li><a href="#" class="pal-link" data-pal-name="${p1}">${p1}</a> + <a href="#" class="pal-link" data-pal-name="${p2}">${p2}</a></li>`;
        });
        combosHtml += '</ul>';
        combosDiv.innerHTML = combosHtml;
        container.appendChild(combosDiv);
      }
      // Map container with highlight
      const mapWrap = document.createElement('div');
      mapWrap.id = 'mapContainer';
      const mapImg = document.createElement('img');
      mapImg.src = 'assets/images/palworld-full-map-2.webp';
      mapImg.alt = 'Palworld map';
      mapWrap.appendChild(mapImg);
      const overlay = document.createElement('div');
      overlay.id = 'mapOverlay';
      // We no longer create a fixed set of rectangular zones.  Instead,
      // when a pal is selected we will insert a single circular
      // highlight representing its preferred habitat.  Remove any
      // previous highlights from the overlay.
      overlay.innerHTML = '';
      mapWrap.appendChild(overlay);
      container.appendChild(mapWrap);
      modalBody.appendChild(container);
      // Create and position the highlight based on the primary environment.
      const envName = environmentMap[pal.types[0]];
      if (envName && zonePositions[envName]) {
        const zp = zonePositions[envName];
        const hl = document.createElement('div');
        hl.style.position = 'absolute';
        hl.style.left = zp.x + '%';
        hl.style.top = zp.y + '%';
        hl.style.width = zp.w + '%';
        hl.style.height = zp.h + '%';
        hl.style.borderRadius = '50%';
        hl.style.background = 'rgba(197,122,255,0.35)';
        hl.style.border = '2px solid var(--light)';
        hl.style.pointerEvents = 'none';
        overlay.appendChild(hl);
      }
      // Attach click handlers for skill, trait and item links within this modal.
      container.addEventListener('click', (e) => {
        // Skill link: show skill details
        if (e.target.classList.contains('skill-link')) {
          e.preventDefault();
          const skillKey = e.target.dataset.skill;
          showSkillDetail(skillKey);
          return;
        }
        // Trait link: show trait details
        if (e.target.classList.contains('trait-link')) {
          e.preventDefault();
          const traitName = e.target.dataset.trait;
          showTraitDetail(traitName);
          return;
        }
        // Item link: show item details
        if (e.target.classList.contains('item-link')) {
          e.preventDefault();
          const itemName = e.target.dataset.item;
          openItemDetail(itemName);
          return;
        }
        // Pal link in breeding combos: open that pal by name
        if (e.target.classList.contains('pal-link')) {
          e.preventDefault();
          const name = e.target.dataset.palName;
          const pid = PAL_NAME_TO_ID[name];
          if (pid) showPalDetail(pid);
          return;
        }
      });
      openModal();
    }
    // Build items page
    function buildItemPage() {
      const list = document.getElementById('itemsList');
      const search = document.getElementById('itemSearch');
      // Compute which pals drop each item
      const dropsMap = {};
      Object.values(PALS).forEach(pal => {
        (pal.drops || []).forEach(item => {
          if (!dropsMap[item]) dropsMap[item] = [];
          dropsMap[item].push(pal.name);
        });
      });
      function render(filter = '') {
        list.innerHTML = '';
        const term = filter.toLowerCase();
        Object.keys(ITEMS).sort().forEach(item => {
          const human = item.replace(/_/g,' ');
          if (!human.toLowerCase().includes(term)) return;
          const card = document.createElement('div');
          card.className = 'item-card';
          const category = ITEMS[item].category || 'Misc';
          card.innerHTML = `
            <div class="name">${human}</div>
            <div class="category">${category}</div>
            <div class="drops">Dropped by: ${(dropsMap[item] || []).join(', ') || 'None'}</div>
            <button class="collect-btn ${collected[item] ? 'collected' : ''}">${collected[item] ? 'Collected' : 'Collect'}</button>
          `;
          const btn = card.querySelector('button');
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            collected[item] = !collected[item];
            localStorage.setItem('collected', JSON.stringify(collected));
            btn.classList.toggle('collected', collected[item]);
            btn.textContent = collected[item] ? 'Collected' : 'Collect';
            updateProgressUI();
          });
          // Clicking the card opens the item details modal.  Exclude button clicks.
          card.addEventListener('click', (e) => {
            // Only trigger if the click target is not the button
            if (e.target.tagName.toLowerCase() === 'button') return;
            openItemDetail(item);
          });
          list.appendChild(card);
        });
      }
      search.addEventListener('input', () => render(search.value));
      render();
    }
    // Build technology tree page
    function buildTechPage() {
      const list = document.getElementById('techList');
      list.innerHTML = '';
      TECH.forEach(level => {
        const wrapper = document.createElement('div');
        wrapper.className = 'tech-level';
        wrapper.innerHTML = `<h3>Tech Level ${level.level}</h3>`;
        level.items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'tech-item';
        const matList = item.materials ? Object.entries(item.materials).map(([k,v]) => `${k}: ${v}`).join(', ') : '';
        const matStr = matList ? `<span class="materials">Materials: ${matList}</span><br>` : '';
        const techPoints = item.techPoints ? `<span class="materials">Tech Points: ${item.techPoints}</span><br>` : '';
        div.innerHTML = `
            <strong>${item.name}</strong> (${item.category})<br>
            ${matStr}${techPoints}
            <span class="description">${item.description || ''}</span><br>
            <button class="unlock-btn ${unlocked[item.name] ? 'unlocked' : ''}">${unlocked[item.name] ? 'Unlocked' : 'Unlock'}</button>
          `;
          const btn = div.querySelector('button');
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            unlocked[item.name] = !unlocked[item.name];
            localStorage.setItem('unlocked', JSON.stringify(unlocked));
            btn.classList.toggle('unlocked', unlocked[item.name]);
            btn.textContent = unlocked[item.name] ? 'Unlocked' : 'Unlock';
            updateProgressUI();
          });
          wrapper.appendChild(div);
        });
        list.appendChild(wrapper);
      });
    }
    // Build breeding page
    function buildBreedingPage() {
      const sel1 = document.getElementById('parent1');
      const sel2 = document.getElementById('parent2');
      sel1.innerHTML = '';
      sel2.innerHTML = '';
      Object.values(PALS).sort((a,b) => a.name.localeCompare(b.name)).forEach(pal => {
        const opt1 = document.createElement('option');
        opt1.value = pal.id;
        opt1.textContent = pal.name;
        const opt2 = opt1.cloneNode(true);
        sel1.appendChild(opt1);
        sel2.appendChild(opt2);
      });
      document.getElementById('breedBtn').addEventListener('click', () => {
        const id1 = Number(sel1.value);
        const id2 = Number(sel2.value);
        const pal1 = PALS[id1];
        const pal2 = PALS[id2];
        const avgPower = Math.floor((pal1.breeding.power + pal2.breeding.power) / 2);
        let closest = pal1;
        let diff = Math.abs(pal1.breeding.power - avgPower);
        Object.values(PALS).forEach(p => {
          const d = Math.abs(p.breeding.power - avgPower);
          if (d < diff) {
            diff = d;
            closest = p;
          }
        });
        const res = document.getElementById('breedingResult');
        res.innerHTML = '';
        const card = document.createElement('div');
        card.className = 'pal-card';
        card.style.cursor = 'default';
        card.innerHTML = `
          <img src="${iconMap[closest.types[0]] || iconMap['Neutral']}" alt="icon">
          <div class="name">${closest.name}</div>
          <div class="badge">${closest.types.join(', ')}</div>
          <div class="rarity">${'⭐'.repeat(closest.rarity)}</div>
        `;
        res.appendChild(card);
        const tip = document.createElement('p');
        tip.style.marginTop = '8px';
        tip.innerHTML = `The baby pal is likely <strong>${closest.name}</strong> (Breeding Power: ${closest.breeding.power}). Feed a <strong>Cake</strong> to start breeding.`;
        res.appendChild(tip);
      });
    }

    // Home page builder.  Displays large action cards and a rotating
    // suggested pal for tonight.  The cards encourage players to
    // catch a pal, fight a boss or build something new.  In grown‑up
    // mode the suggestions include more context like recommended
    // work types or where to find the boss.
    function buildHomePage() {
      const home = document.getElementById('homeCards');
      if (!home) return;
      home.innerHTML = '';
      // Define the three core actions.  Each entry can include an
      // icon (Font Awesome class), title and description.  Later we
      // could wire these cards to jump to the relevant page.
      const actions = [
        { icon: 'fa-paw', title: 'Catch a Pal', desc: 'Find a new pal to join your team', onClick: () => switchPage('pals') },
        { icon: 'fa-helmet-battle', title: 'Fight a Boss', desc: 'Prepare for your next tower battle', onClick: () => switchPage('route') },
        { icon: 'fa-hammer', title: 'Build Something', desc: 'Craft gear or structures to improve your base', onClick: () => switchPage('tech') }
      ];
      actions.forEach(act => {
        const card = document.createElement('div');
        card.className = 'pal-card';
        card.innerHTML = `<i class="fa-solid ${act.icon}" style="font-size:48px;margin-bottom:8px;color:var(--accent)"></i><div class="name">${act.title}</div><div style="font-size:0.9rem;color:var(--light);">${act.desc}</div>`;
        card.addEventListener('click', () => {
          act.onClick();
          playSound(clickSound);
        });
        home.appendChild(card);
      });
      // Add a rotating suggested pal card.  Choose a pal at random
      // whose rarity is low (≤3) to ensure early accessibility.  If
      // none exist, just pick a random pal.  The suggestion hints at
      // the pal’s best work or battle roles.
      const palsArray = Object.values(PALS);
      let candidates = palsArray.filter(p => p.rarity <= 3);
      if (!candidates.length) candidates = palsArray;
      const suggestion = candidates[Math.floor(Math.random() * candidates.length)];
      const sugCard = document.createElement('div');
      sugCard.className = 'pal-card';
      sugCard.innerHTML = `<img src="${suggestion.localImage || iconMap[suggestion.types[0]]}" alt="${suggestion.name}" style="width:100px;height:100px;"><div class="name">Try ${suggestion.name}!</div><div style="font-size:0.85rem;color:var(--light);">${kidMode ? 'Great pal for early game' : 'Rarity: ' + rarityNames[Math.max(1,Math.min(suggestion.rarity||0,6))]}</div>`;
      sugCard.addEventListener('click', () => {
        showPalDetail(suggestion.id);
        playSound(clickSound);
      });
      home.appendChild(sugCard);
    }

    // Route page builder.  Creates cards for each tower battle in the
    // ROUTE array.  Each card lists the order, boss names, recommended
    // element and a short description.  We include a checkbox for
    // marking the encounter complete, stored in localStorage.  Boss
    // names link to their pal details if known.
    function buildRoutePage() {
      const list = document.getElementById('routeList');
      if (!list) return;
      list.innerHTML = '';
      ROUTE.forEach(step => {
        const card = document.createElement('div');
        card.className = 'pal-card';
        // Determine if this step is complete via localStorage
        const routeProgress = JSON.parse(localStorage.getItem('routeProgress') || '{}');
        const done = !!routeProgress[step.step];
        // Attempt to link the boss pal to its detail page
        const bossNames = step.boss.split('&').map(s => s.trim());
        // We'll link the first pal in the pair; additional names link separately
        const bossPalName = bossNames[1] ? bossNames[1] : bossNames[0];
        const bossId = PAL_NAME_TO_ID[bossPalName];
        let bossLink = step.boss;
        if (bossId) {
          bossLink = bossNames.map(name => {
            const id = PAL_NAME_TO_ID[name.trim()];
            return id ? `<a href="#" class="pal-link" data-pal-name="${name.trim()}">${name.trim()}</a>` : name.trim();
          }).join(' & ');
        }
        const weaknesses = Array.isArray(step.weakness) ? step.weakness.join(', ') : step.weakness;
        card.innerHTML = `
          <div class="name">${step.step}. ${step.name}</div>
          <div style="font-size:0.9rem;color:var(--light);">Boss: ${bossLink}</div>
          <div style="font-size:0.8rem;color:var(--light);">Element: ${step.element}</div>
          <div style="font-size:0.8rem;color:var(--light);">Weakness: ${weaknesses}</div>
          <div style="font-size:0.8rem;color:var(--light);">HP: ${step.hp.toLocaleString()}</div>
          <div style="font-size:0.75rem;color:var(--text);margin:6px 0;">${step.description}</div>
          <div style="font-size:0.7rem;color:var(--light);">Location: ${step.location || 'Unknown'}</div>
          <div style="font-size:0.7rem;color:var(--light);">Tips: ${step.tips || ''}</div>
          ${step.steps ? '<div style="font-size:0.7rem;color:var(--light); margin-top:4px;"><ol style="padding-left:18px; margin:4px 0;">' + step.steps.map(s => `<li>${s}</li>`).join('') + '</ol></div>' : ''}
          <button class="collect-btn${done ? ' collected' : ''}" style="margin-top:8px;">${done ? 'Completed' : 'Mark done'}</button>
        `;
        const btn = card.querySelector('button');
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const prog = JSON.parse(localStorage.getItem('routeProgress') || '{}');
          prog[step.step] = !done;
          localStorage.setItem('routeProgress', JSON.stringify(prog));
          buildRoutePage();
          playSound(clickSound);
        });
        // Link click handler inside card
        card.addEventListener('click', (e) => {
          if (e.target.classList.contains('pal-link')) {
            e.preventDefault();
            const pname = e.target.dataset.palName;
            const pid = PAL_NAME_TO_ID[pname];
            if (pid) showPalDetail(pid);
          }
        });
        list.appendChild(card);
      });
    }

    // Glossary page builder.  Presents a list of passives and moves
    // with their descriptions.  Elements and work suitabilities are
    // summarised in simple tables.  Clicking a passive or move
    // shows more detail in a modal using the existing functions.
    function buildGlossaryPage() {
      const container = document.getElementById('glossaryContent');
      if (!container) return;
      container.innerHTML = '';
      // Build passives list
      const passivesSection = document.createElement('div');
      passivesSection.innerHTML = '<h3>Passive Skills</h3>';
      const passiveList = document.createElement('ul');
      Object.keys(traitsDictionary).sort().forEach(trait => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="#" class="trait-link" data-trait="${trait}">${trait}</a>: ${traitsDictionary[trait]}`;
        passiveList.appendChild(li);
      });
      passivesSection.appendChild(passiveList);
      container.appendChild(passivesSection);
      // Build moves list (only first 30 for brevity)
      const movesSection = document.createElement('div');
      movesSection.innerHTML = '<h3>Active Skills</h3>';
      const movesList = document.createElement('ul');
      const moveKeys = Object.keys(skillsDictionary);
      moveKeys.sort().slice(0, 30).forEach(key => {
        const info = skillsDictionary[key];
        const li = document.createElement('li');
        li.innerHTML = `<a href="#" class="skill-link" data-skill="${key}">${info.name}</a>: ${info.description}`;
        movesList.appendChild(li);
      });
      if (moveKeys.length > 30) {
        const more = document.createElement('p');
        more.innerHTML = `...and ${moveKeys.length - 30} more skills. Use search or view pals for full list.`;
        movesSection.appendChild(more);
      }
      movesSection.appendChild(movesList);
      container.appendChild(movesSection);
      // Elements table
      const elemSection = document.createElement('div');
      elemSection.innerHTML = '<h3>Elements & Type Chart</h3>';
      const elemTable = document.createElement('table');
      elemTable.style.width = '100%';
      elemTable.style.borderCollapse = 'collapse';
      const types = ['Neutral','Fire','Water','Grass','Electric','Ice','Ground','Dragon','Dark','Air'];
      elemTable.innerHTML = `<tr><th>Element</th><th>Strong Against</th><th>Weak Against</th></tr>`;
      const strengths = {
        Fire: 'Grass, Ice',
        Water: 'Fire, Ground',
        Grass: 'Water, Ground',
        Electric: 'Water, Air',
        Ice: 'Dragon, Grass',
        Ground: 'Electric, Fire',
        Dragon: 'Dark, Dragon',
        Dark: 'Neutral',
        Air: 'Grass, Ground',
        Neutral: 'None'
      };
      const weaknesses = {
        Fire: 'Water, Ground',
        Water: 'Electric, Grass',
        Grass: 'Fire, Ice, Air',
        Electric: 'Ground',
        Ice: 'Fire, Electric',
        Ground: 'Water, Grass',
        Dragon: 'Dragon, Ice',
        Dark: 'Dragon',
        Air: 'Electric, Ice',
        Neutral: 'None'
      };
      types.forEach(t => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${t}</td><td>${strengths[t] || 'Unknown'}</td><td>${weaknesses[t] || 'Unknown'}</td>`;
        elemTable.appendChild(row);
      });
      elemSection.appendChild(elemTable);
      container.appendChild(elemSection);
      // Work suitabilities legend
      const workSection = document.createElement('div');
      workSection.innerHTML = '<h3>Work Suitabilities</h3>';
      const suits = ['Kindling','Watering','Planting','Electricity','Handiwork','Gathering','Lumbering','Mining','Medicine','Cooling','Transporting','Farming'];
      const ul = document.createElement('ul');
      suits.forEach(s => {
        const li = document.createElement('li');
        li.textContent = `${s} – useful for base tasks like ${s.toLowerCase()}.`;
        ul.appendChild(li);
      });
      workSection.appendChild(ul);
      container.appendChild(workSection);
      // Click handlers for glossary links
      container.addEventListener('click', (e) => {
        if (e.target.classList.contains('trait-link')) {
          e.preventDefault();
          const trait = e.target.dataset.trait;
          showTraitDetail(trait);
        } else if (e.target.classList.contains('skill-link')) {
          e.preventDefault();
          const key = e.target.dataset.skill;
          showSkillDetail(key);
        }
      });
    }

    // Map page builder.  Creates toggles for different layers and
    // instructions to open the external interactive map.  We do not
    // re‑host community map tiles; instead we encourage opening
    // palworld.gg with the appropriate filters.  A simple overlay is
    // available via environment highlights but hidden by default.
    function buildMapPage() {
      const layers = document.getElementById('mapLayers');
      if (!layers) return;
      layers.innerHTML = '';
      const categories = [
        { name: 'Pals', desc: 'See spawn locations on the external map', url: 'https://palworld.gg/map' },
        { name: 'Alpha Pals', desc: 'Locate strong alpha variants', url: 'https://palworld.gg/map' },
        { name: 'Towers', desc: 'Find tower bosses and fast travel points', url: 'https://palworld.gg/map' },
        { name: 'Dungeons', desc: 'Open map to see dungeon entrances', url: 'https://palworld.gg/map' },
        { name: 'Effigies', desc: 'Locate Lifmunk Effigies for free levels', url: 'https://palworld.gg/map' },
        { name: 'Skill Fruit Trees', desc: 'Find Skill Fruit trees to learn moves', url: 'https://palworld.gg/map' },
        { name: 'Fast Travel', desc: 'Discover fast travel statues', url: 'https://palworld.gg/map' }
      ];
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'collect-btn';
        btn.style.margin = '4px';
        btn.textContent = cat.name;
        btn.addEventListener('click', () => {
          window.open(cat.url, '_blank');
        });
        layers.appendChild(btn);
      });
    }
    // Update progress bars
    function updateProgressUI() {
      const totalPals = Object.keys(PALS).length;
      const caughtCount = Object.keys(caught).filter(k => caught[k]).length;
      const palsBar = document.getElementById('palsProgress');
      palsBar.style.width = ((caughtCount / totalPals) * 100) + '%';
      const totalItems = Object.keys(ITEMS).length;
      const collectedCount = Object.keys(collected).filter(k => collected[k]).length;
      const itemsBar = document.getElementById('itemsProgress');
      itemsBar.style.width = ((collectedCount / totalItems) * 100) + '%';
      // Count tech recipes
      let totalRecipes = 0;
      TECH.forEach(lvl => { totalRecipes += lvl.items.length; });
      const unlockedCount = Object.keys(unlocked).filter(k => unlocked[k]).length;
      const techBar = document.getElementById('techProgress');
      techBar.style.width = ((unlockedCount / totalRecipes) * 100) + '%';
    }

    // Display detailed information about an item.  This function builds
    // modal content including the item name, category, which pals drop it,
    // and any tech recipes using the item.  If the item appears in the
    // technology tree, we also list the recipes that require it.  The
    // function expects the raw item key as stored in the ITEMS object.
    function openItemDetail(itemKey) {
      const item = ITEMS[itemKey];
      modalBody.innerHTML = '';
      const wrap = document.createElement('div');
      const human = itemKey.replace(/_/g, ' ');
      wrap.innerHTML = `<h3>${human}</h3><p><strong>Category:</strong> ${item.category || 'Unknown'}</p>`;
      // Pals dropping this item
      const drops = DROPS_MAP[itemKey] || [];
      const dropsHtml = drops.length ? drops.join(', ') : 'None';
      wrap.innerHTML += `<p><strong>Dropped by:</strong> ${dropsHtml}</p>`;
      // Show tech recipes that require this item as a material
      const recipes = [];
      TECH.forEach(level => {
        level.items.forEach(it => {
          if (it.materials[itemKey]) {
            recipes.push({ name: it.name, qty: it.materials[itemKey], level: level.level });
          }
        });
      });
      if (recipes.length) {
        let recHtml = '<ul>';
        recipes.forEach(r => {
          recHtml += `<li>Level ${r.level}: ${r.name} (x${r.qty})</li>`;
        });
        recHtml += '</ul>';
        wrap.innerHTML += `<p><strong>Used in Tech:</strong> ${recHtml}</p>`;
      }
      modalBody.appendChild(wrap);
      openModal();
    }

    // Show details about an active skill.  Looks up the skill in the
    // dictionary; if it’s missing we display a generic placeholder.
    function showSkillDetail(key) {
      const lower = key.toLowerCase();
      const info = skillsDictionary[lower] || { name: key.replace(/_/g,' '), damage: 'Unknown', type: 'Unknown', description: 'This skill\'s effects are a mystery! Try it out in battle.' };
      modalBody.innerHTML = '';
      const div = document.createElement('div');
      div.innerHTML = `<h3>${info.name}</h3><p><strong>Damage:</strong> ${info.damage}</p><p><strong>Type:</strong> ${info.type}</p><p>${info.description}</p>`;
      modalBody.appendChild(div);
      openModal();
    }

    // Show details about a passive trait.  Retrieves the description
    // from the trait dictionary.  Unknown traits yield a default
    // explanation encouraging exploration.
    function showTraitDetail(name) {
      const desc = traitsDictionary[name] || 'This trait has mysterious effects that aren\'t fully documented. See how it behaves in-game!';
      modalBody.innerHTML = '';
      const div = document.createElement('div');
      div.innerHTML = `<h3>${name}</h3><p>${desc}</p>`;
      modalBody.appendChild(div);
      openModal();
    }
  </script>
</body>
</html>
