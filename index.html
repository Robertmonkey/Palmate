<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palmate – Palworld Companion</title>
  <!-- Chart.js for radar charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Font Awesome for interface icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <!-- Core styles: cosmic blue theme with smooth scrollbars -->
  <style>
    /*
      Colour palette for our epic cosmic theme.  We move away from the
      flat blues of the original and embrace rich purples and golds
      inspired by the Palworld universe.  These variables define the
      background, primary and secondary navigation colours, accent
      highlights, light text, card backgrounds and success/danger
      notifications.  Feel free to tweak these values for your own
      flavour.
    */
    :root {
      /*
        Updated colour palette to give the UI a warmer, more inviting
        atmosphere.  The dark navy base contrasts with desaturated
        blues and soft greens, while the accent colour pops against
        the card backgrounds.  Light colours are slightly brighter to
        improve readability for younger players.  Feel free to tweak
        these values to suit your own tastes.
      */
      --bg: #0d1b2a;
      --primary: #1b263b;
      --secondary: #415a77;
      --accent: #778da9;
      --light: #e0e1dd;
      --card-bg: #1e3246;
      --card-hover: #2e4a62;
      --text: #f0f4f8;
      --muted: rgba(224,225,221,0.7);
      --danger: #e76f51;
      --success: #2a9d8f;
    }
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      /* Set a cosmic background image across the entire page.  We use
         background-attachment: fixed so the stars stay put as you
         scroll, lending a sense of depth.  The fallback colour
         ensures readability while the image loads. */
      background: var(--bg) url('assets/images/background.png') center/cover fixed no-repeat;
      color: var(--text);
      font-family: "Trebuchet MS", sans-serif;
      height: 100%;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }
    /* Remove the old #app layout (previously used for sidebar).  The
       content area now sits below the navbar and fills the remaining
       space. */
    /* Top navigation bar styling */
    #navbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      padding-top: calc(env(safe-area-inset-top, 0px) + 8px);
      min-height: 60px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    #navbar::-webkit-scrollbar {
      display: none;
    }
    #navbar .logo {
      font-size: 1.4rem;
      font-weight: bold;
      letter-spacing: 1px;
      margin-right: 12px;
      flex-shrink: 0;
    }
    #navbar .nav-item {
      border: none;
      background: none;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: border-color 0.3s, color 0.3s;
      flex: 0 0 auto;
    }
    #navbar .nav-item i {
      font-size: 1.1rem;
    }
    #navbar .nav-item:hover {
      color: var(--accent);
    }
    #navbar .nav-item.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Mode toggle button styling */
    .mode-btn {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 10px;
      transition: color 0.3s;
      flex: 0 0 auto;
    }
    .mode-btn:hover {
      color: var(--accent);
    }

    /* Kid mode adjustments: larger targets and font sizes, simplified cards */
    body.kid-mode .pal-card img {
      width: 120px;
      height: 120px;
    }
    body.kid-mode .item-card img {
      width: 120px;
      height: 120px;
    }
    body.kid-mode .pal-card .name,
    body.kid-mode .item-card .name {
      font-size: 1.2rem;
    }
    body.kid-mode .nav-item span {
      font-size: 1rem;
    }
    body.kid-mode .search-bar input {
      font-size: 1rem;
    }
    /* Main content area.  This section fills the page below the
       navbar.  We add a top margin equal to the navbar height to
       ensure the content does not scroll underneath it. */
    #content {
      padding: 20px;
      margin-top: 20px;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    @media (max-width: 900px) {
      #navbar .nav-item {
        padding: 10px 12px;
        font-size: 0.85rem;
      }
      .card-grid {
        grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      }
    }

    @media (max-width: 600px) {
      #navbar {
        gap: 6px;
      }
      #navbar .logo {
        font-size: 1.1rem;
        margin-right: 8px;
      }
      #content {
        padding: 16px 12px 24px;
      }
      .page-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      .search-bar {
        max-width: none;
      }
      .card-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 14px;
      }
      body.kid-mode .card-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }

    @media (max-width: 480px) {
      #navbar {
        gap: 4px;
      }
      #navbar .nav-item {
        padding: 8px 10px;
        font-size: 0.8rem;
      }
      #navbar .nav-item i {
        font-size: 1rem;
      }
      #content {
        padding: 14px 10px 20px;
      }
      .card-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
      }
      body.kid-mode .card-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      .pal-card img,
      .item-card img {
        width: 90px;
        height: 90px;
      }
    }
    .search-bar {
      width: 100%;
      max-width: 400px;
    }
    .search-bar input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      background: var(--card-bg);
      color: var(--text);
      font-size: 0.9rem;
    }
    /* Grid for cards */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    body.kid-mode .card-grid {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }
    /* Pal and item cards */
    .pal-card, .item-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
      cursor: pointer;
      position: relative;
    }
    .pal-card:hover, .item-card:hover {
      transform: translateY(-4px);
      background: var(--card-hover);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .pal-card img, .item-card img {
      /* Increase the size of the images to make each pal and item
         card more visually striking and easier for younger players
         to recognise. */
      width: 100px;
      height: 100px;
      object-fit: contain;
      margin-bottom: 8px;
    }
    .pal-card .name, .item-card .name {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .pal-card .badge {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
      color: var(--text);
      font-size: 0.8rem;
    }
    .pal-card .badge img {
      width: 22px;
      height: 22px;
    }
    .pal-card .rarity {
      font-size: 0.8rem;
      margin-bottom: 6px;
      color: var(--light);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }
    .pal-card .rarity .stars i {
      color: #E4B914;
      font-size: 0.8rem;
      margin-right: 2px;
    }
    .pal-card .rarity .label {
      color: var(--accent);
      font-weight: bold;
      text-transform: capitalize;
    }
    .pal-card .catch-btn {
      background: var(--success);
      border: none;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: background 0.2s;
    }
    .pal-card .catch-btn.caught {
      background: var(--secondary);
    }
    /* Modal */
    #modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 200;
    }
    #modal.active {
      opacity: 1;
      pointer-events: auto;
    }
    #modalContent {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    #modalClose {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }
    .external-embed {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .external-embed .embed-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .external-embed .embed-actions h3 {
      margin: 0;
      font-size: 1.3rem;
    }
    .external-embed .embed-link {
      color: var(--accent);
      text-decoration: none;
      font-weight: bold;
    }
    .external-embed .embed-link:hover,
    .external-embed .embed-link:focus {
      text-decoration: underline;
    }
    .external-embed .embed-note,
    .external-embed .embed-fallback {
      font-size: 0.9rem;
      color: var(--light);
      margin: 0;
    }
    .external-embed .embed-summary {
      background: rgba(65, 90, 119, 0.35);
      border-radius: 8px;
      padding: 12px;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    body.kid-mode .external-embed .embed-summary {
      font-size: 1rem;
    }
    .external-embed .embed-frame {
      width: 100%;
      min-height: 70vh;
      border: none;
      border-radius: 10px;
      background: #fff;
    }
    .item-detail-card {
      display: grid;
      gap: 18px;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
    }
    .item-detail-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .item-detail-heading {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1 1 auto;
      min-width: 0;
    }
    .item-detail-image {
      width: 96px;
      height: 96px;
      border-radius: 14px;
      background: rgba(0, 0, 0, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }
    .item-detail-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .item-detail-placeholder {
      font-size: 2rem;
      color: var(--accent);
    }
    .item-detail-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }
    .item-detail-meta h3 {
      margin: 0;
      font-size: 1.6rem;
      line-height: 1.2;
    }
    .item-detail-meta .type-tag {
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }
    .detail-collect-btn {
      background: var(--secondary);
      border: none;
      color: var(--text);
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .detail-collect-btn:hover,
    .detail-collect-btn:focus {
      background: var(--accent);
      transform: translateY(-1px);
    }
    .detail-collect-btn.collected {
      background: var(--success);
      color: #fff;
    }
    .item-detail-description p {
      margin: 0 0 8px;
      line-height: 1.6;
      font-size: 1rem;
    }
    .item-detail-description p:last-child {
      margin-bottom: 0;
    }
    .item-detail-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    .item-detail-stats .stat-pill {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 12px;
    }
    .item-detail-stats .stat-pill .label {
      display: block;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .item-detail-stats .stat-pill .value {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .item-detail-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      gap: 8px;
    }
    .item-detail-section h4 {
      margin: 0;
      font-size: 1.1rem;
    }
    .item-detail-section p {
      margin: 0;
      line-height: 1.5;
    }
    .item-detail-summary ul {
      margin: 0;
      padding-left: 20px;
      line-height: 1.5;
    }
    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip-list .chip {
      background: rgba(119, 141, 169, 0.35);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
    }
    .chip-list .chip.highlight {
      background: rgba(42, 157, 143, 0.35);
    }
    .ingredient-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .ingredient-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .ingredient-card img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.25);
    }
    .ingredient-card .ingredient-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .ingredient-card .name {
      font-weight: 600;
    }
    .item-detail-footer {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 0.9rem;
    }
    .item-detail-footer a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }
    .item-detail-footer a:hover,
    .item-detail-footer a:focus {
      text-decoration: underline;
    }
    .item-detail-note {
      color: var(--accent);
      font-size: 0.85rem;
    }
    body.kid-mode .item-detail-card {
      gap: 14px;
      padding: 20px;
    }
    body.kid-mode .item-detail-meta h3 {
      font-size: 1.4rem;
    }
    body.kid-mode .item-detail-description p {
      font-size: 1.05rem;
    }
    body.kid-mode .item-detail-stats {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    body.kid-mode .item-detail-stats .stat-pill {
      padding: 10px;
    }
    body.kid-mode .item-detail-stats .stat-pill .value {
      font-size: 1rem;
    }
    body.kid-mode .detail-collect-btn {
      font-size: 1rem;
      padding: 12px 20px;
    }
    body.kid-mode .chip-list .chip {
      font-size: 0.95rem;
      padding: 8px 16px;
    }
    body.kid-mode .item-detail-section h4 {
      font-size: 1rem;
    }
    .modal-action-btn {
      background: var(--accent);
      border: none;
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .modal-action-btn:hover,
    .modal-action-btn:focus {
      background: var(--secondary);
      transform: translateY(-1px);
    }
    body.kid-mode .modal-action-btn {
      font-size: 1rem;
    }
    /* Environment map */
    #mapContainer {
      position: relative;
      width: 100%;
      margin: 10px 0;
      border-radius: 8px;
      overflow: hidden;
    }
    #mapContainer img {
      width: 100%;
      height: auto;
      display: block;
    }
    #mapOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #mapOverlay .zone {
      position: absolute;
      opacity: 0;
      background: var(--accent);
      border: 2px solid var(--light);
      /* Make the highlight circular/elliptical to better approximate
         natural habitats instead of square boxes */
      border-radius: 50%;
      transition: opacity 0.3s;
    }
    #mapOverlay .zone.active {
      /* Lower opacity for a gentler highlight that doesn’t overpower the map */
      opacity: 0.2;
    }
    .map-modal {
      display: grid;
      gap: 12px;
    }
    .map-modal h3 {
      margin: 0;
    }
    .map-modal-note {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .map-modal-details {
      display: grid;
      gap: 6px;
      font-size: 0.95rem;
    }
    .map-modal-canvas {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      background: var(--primary);
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    .map-modal-canvas img {
      display: block;
      width: 100%;
      height: auto;
    }
    .map-marker {
      position: absolute;
      width: 18px;
      height: 18px;
      background: var(--danger);
      border: 2px solid var(--light);
      border-radius: 50%;
      transform: translate(-50%, -100%);
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    .map-marker::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      width: 2px;
      height: 16px;
      background: var(--danger);
      transform: translateX(-50%);
    }
    .map-marker-label {
      position: absolute;
      top: calc(100% + 6px);
      left: 50%;
      transform: translate(-50%, 0);
      background: rgba(13,27,42,0.85);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      pointer-events: none;
    }
    body.kid-mode .map-modal-details p {
      font-size: 1rem;
    }
    /* Items */
    .item-card .name {
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .item-card .category {
      font-size: 0.75rem;
      color: var(--light);
      margin-bottom: 6px;
    }
    .item-card .drops {
      font-size: 0.7rem;
      color: var(--text);
    }
    .item-card .collect-btn {
      margin-top: 6px;
      background: var(--success);
      border: none;
      color: #fff;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .item-card .collect-btn.collected {
      background: var(--secondary);
    }
    /* Route tracking */
    .route-card {
      text-align: left;
      cursor: default;
      border: 1px solid transparent;
    }
    .route-card.completed {
      border-color: var(--success);
      box-shadow: 0 4px 14px rgba(46, 204, 113, 0.25);
      background: rgba(46, 204, 113, 0.08);
    }
    .route-card .name {
      margin-bottom: 6px;
    }
    .route-steps {
      margin-top: 8px;
    }
    .route-step-list {
      list-style-position: inside;
      padding-left: 0;
      margin: 4px 0 0;
      counter-reset: route-step;
    }
    .route-step {
      counter-increment: route-step;
      margin-bottom: 6px;
      padding: 6px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.02);
      transition: background 0.2s, color 0.2s;
    }
    .route-step::marker {
      font-weight: 700;
      color: var(--secondary);
    }
    .route-step.completed {
      background: rgba(46, 204, 113, 0.12);
    }
    .route-step.completed::marker {
      color: var(--success);
    }
    .route-step-label {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      font-size: 0.75rem;
      color: var(--light);
    }
    .route-step input[type="checkbox"] {
      margin-top: 2px;
      transform: scale(1.05);
    }
    .route-step-text {
      flex: 1;
      line-height: 1.35;
    }
    .route-step.completed .route-step-label {
      color: var(--text);
      font-weight: 600;
    }
    .route-step.completed .route-step-text {
      text-decoration: line-through;
    }
    .route-progress-summary {
      font-size: 0.7rem;
      color: var(--light);
      margin-top: 6px;
    }
    .route-card.completed .route-progress-summary {
      color: var(--success);
      font-weight: 600;
    }
    /* Tech tree */
    .tech-level {
      margin-bottom: 20px;
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .tech-level h3 {
      margin-bottom: 10px;
    }
    .tech-item {
      margin-left: 10px;
      padding: 6px;
      border-left: 3px solid var(--secondary);
      margin-bottom: 6px;
    }
    .tech-item .materials {
      font-size: 0.8rem;
      color: var(--light);
    }
    .tech-item .unlock-btn {
      margin-top: 4px;
      background: var(--success);
      border: none;
      color: #fff;
      padding: 3px 5px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .tech-item .unlock-btn.unlocked {
      background: var(--secondary);
    }
    /* Breeding page */
    .breeding-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
    }
    .breeding-tab {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--card-hover);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
    .breeding-tab.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .breeding-mode {
      display: none;
      margin-top: 16px;
    }
    .breeding-mode.active {
      display: block;
    }
    .breeding-panels {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .breeding-panel {
      flex: 1 1 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .breeding-panel h3 {
      margin: 0;
      font-size: 1.05rem;
    }
    .breeding-panel .pal-search input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      background: var(--card-bg);
      color: var(--text);
      font-size: 0.9rem;
    }
    .pal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }
    body.kid-mode .pal-grid {
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
    }
    .pal-card.compact {
      padding: 10px;
    }
    .pal-card.compact img {
      width: 80px;
      height: 80px;
    }
    .pal-card.compact .name {
      font-size: 0.95rem;
    }
    .pal-card.compact .badge {
      font-size: 0.75rem;
    }
    .pal-card.compact .rarity {
      font-size: 0.7rem;
    }
    .pal-card.static {
      cursor: default;
    }
    .pal-card.static:hover {
      transform: none;
      background: var(--card-bg);
      box-shadow: none;
    }
    .pal-card.selectable {
      cursor: pointer;
    }
    .pal-card.selected {
      outline: 3px solid var(--accent);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
    }
    .breeding-result {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .breeding-flow {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .combo-arrow {
      font-size: 1.4rem;
      color: var(--light);
    }
    .breeding-tip {
      font-size: 0.9rem;
      color: var(--light);
    }
    .breeding-combo-link {
      align-self: flex-start;
      padding: 8px 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .breeding-combo-link:hover {
      opacity: 0.9;
    }
    .breeding-combos {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .breeding-combo {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    .breeding-combo:hover {
      background: var(--card-hover);
      transform: translateY(-2px);
    }
    .breeding-combo .pal-card {
      flex: 1 1 160px;
      margin: 0;
    }
    .breeding-baby-header {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .breeding-baby-header h3 {
      margin: 0;
    }
    .empty-state {
      font-size: 0.9rem;
      color: var(--light);
      padding: 12px 0;
    }
    @media (max-width: 768px) {
      .breeding-panels {
        flex-direction: column;
      }
      .pal-grid {
        max-height: 300px;
      }
    }
    /* Progress bars */
    .progress-bar {
      background: var(--card-bg);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-bar .fill {
      height: 16px;
      width: 0;
      background: var(--success);
      transition: width 0.5s;
    }
    .progress-label {
      font-size: 0.8rem;
      margin-bottom: 2px;
    }
    /* Custom scrollbars */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--primary);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--secondary);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- Top navigation bar.  We move away from the vertical sidebar and instead
       present a horizontal bar across the top of the page.  Each button
       contains an icon and label.  The active tab is highlighted
       via a coloured underline defined in CSS. -->
  <nav id="navbar">
    <div class="logo">Pal Marathon</div>
    <!-- Navigation items.  We add Home, Map, Route and Glossary to
         provide quick access to all major sections of the app.  The
         first item (Home) is active by default.  Icons chosen via
         Font Awesome provide an intuitive visual cue for each tab. -->
    <button class="nav-item active" data-page="home"><i class="fa-solid fa-house"></i><span>Home</span></button>
    <button class="nav-item" data-page="pals"><i class="fa-solid fa-paw"></i><span>Pals</span></button>
    <button class="nav-item" data-page="map"><i class="fa-solid fa-map"></i><span>Map</span></button>
    <button class="nav-item" data-page="route"><i class="fa-solid fa-road"></i><span>Route</span></button>
    <button class="nav-item" data-page="tech"><i class="fa-solid fa-cog"></i><span>Tech</span></button>
    <button class="nav-item" data-page="items"><i class="fa-solid fa-box"></i><span>Items</span></button>
    <button class="nav-item" data-page="glossary"><i class="fa-solid fa-book-open"></i><span>Glossary</span></button>
    <button class="nav-item" data-page="breeding"><i class="fa-solid fa-egg"></i><span>Breeding</span></button>
    <button class="nav-item" data-page="progress"><i class="fa-solid fa-chart-line"></i><span>Progress</span></button>
    <!-- Mode toggle button sits on the far right.  Clicking it
         switches between Kid Mode (simplified UI) and Grown‑up
         Mode (full details).  The icon updates accordingly. -->
    <button id="modeToggle" class="mode-btn" title="Switch to grown-up mode"><i class="fa-solid fa-child"></i></button>
  </nav>
  <div id="content">
      <!-- Home page -->
      <section id="homePage" class="page active">
        <header class="page-header">
          <h2>Tonight’s Plan</h2>
        </header>
        <p>Welcome to Pal Marathon, your companion guide for completing Palworld with your family. Use the quick cards below to get started on tonight’s adventure.</p>
        <div id="homeCards" class="card-grid"></div>
      </section>
      <!-- Pals page -->
      <section id="palsPage" class="page">
        <header class="page-header">
          <h2>Pals</h2>
          <div class="search-bar"><input id="palSearch" type="text" placeholder="Search pals by name or type..."></div>
        </header>
        <div id="palsList" class="card-grid"></div>
      </section>
      <!-- Items page -->
      <section id="itemsPage" class="page">
        <header class="page-header">
          <h2>Items</h2>
          <div class="search-bar"><input id="itemSearch" type="text" placeholder="Search items..."></div>
        </header>
        <div id="itemsList" class="card-grid"></div>
      </section>
      <!-- Map page -->
      <section id="mapPage" class="page">
        <header class="page-header">
          <h2>Map</h2>
        </header>
        <p>Explore Palpagos! Toggle layers to highlight points of interest. Open the interactive map for detailed navigation.</p>
        <div id="mapLayers" style="margin-bottom:10px;"></div>
        <!-- Interactive map iframe: embed the palworld.gg map directly in the app with a larger viewing window. -->
        <div id="interactiveMapWrapper" style="width:100%; height:75vh; min-height:600px; border-radius:8px; overflow:hidden; margin-bottom:12px;">
          <iframe id="mapIframe" src="https://palworld.gg/map" style="width:100%; height:100%; border:none;" title="Palworld Interactive Map"></iframe>
        </div>
      </section>
      <!-- Route page -->
      <section id="routePage" class="page"></section>
      <!-- Tech page -->
      <section id="techPage" class="page">
        <header class="page-header">
          <h2>Technology Tree</h2>
        </header>
        <p>This section shows the Pal Sphere blueprints and materials you need. Check off recipes as you unlock them in your game.</p>
        <div id="techList"></div>
      </section>
      <!-- Breeding page -->
      <section id="breedingPage" class="page">
        <header class="page-header">
          <h2>Breeding Planner</h2>
        </header>
        <p class="breeding-intro">Tap pals to choose your breeding partners or switch tabs to work backwards from the baby you want.</p>
        <div class="breeding-tabs">
          <button type="button" class="breeding-tab active" data-target="breedingPredict">Pick parents</button>
          <button type="button" class="breeding-tab" data-target="breedingDiscover">Find parents</button>
        </div>
        <div id="breedingPredict" class="breeding-mode active">
          <div class="breeding-panels">
            <div class="breeding-panel">
              <h3>Parent A</h3>
              <div class="pal-search">
                <input type="search" id="parent1Search" placeholder="Search pals" aria-label="Search parent A pals">
              </div>
              <div class="pal-grid" id="parent1Grid"></div>
            </div>
            <div class="breeding-panel">
              <h3>Parent B</h3>
              <div class="pal-search">
                <input type="search" id="parent2Search" placeholder="Search pals" aria-label="Search parent B pals">
              </div>
              <div class="pal-grid" id="parent2Grid"></div>
            </div>
          </div>
          <div class="breeding-result" id="breedingResult"></div>
        </div>
        <div id="breedingDiscover" class="breeding-mode">
          <div class="breeding-panel">
            <h3>Desired pal</h3>
            <div class="pal-search">
              <input type="search" id="babySearch" placeholder="Search pals" aria-label="Search desired pals">
            </div>
            <div class="pal-grid" id="babyGrid"></div>
          </div>
          <div class="breeding-combos" id="breedingCombos"></div>
        </div>
      </section>
      <!-- Progress page -->
      <section id="progressPage" class="page">
        <header class="page-header">
          <h2>Your Progress</h2>
        </header>
        <p>Track your adventure by marking pals you catch, items you gather and tech you unlock. Your progress is saved in this browser.</p>
        <div class="progress-section">
          <div class="progress-label">Pals caught</div>
          <div class="progress-bar"><div class="fill" id="palsProgress"></div></div>
          <div class="progress-label">Items collected</div>
          <div class="progress-bar"><div class="fill" id="itemsProgress"></div></div>
          <div class="progress-label">Tech unlocked</div>
          <div class="progress-bar"><div class="fill" id="techProgress"></div></div>
        </div>
      </section>
      <!-- Glossary page -->
      <section id="glossaryPage" class="page">
        <header class="page-header">
          <h2>Glossary</h2>
        </header>
        <p>Here you’ll find definitions for passives, moves, elements and work suitabilities. Tap any term to learn more.</p>
        <div id="glossaryContent"></div>
      </section>
    </div>
  </div>
  <!-- Modal for pal details -->
  <div id="modal">
    <div id="modalContent">
      <button id="modalClose">Close</button>
      <div id="modalBody"></div>
    </div>
  </div>
  <script>
    // Data variables
    let PALS = {};
    let ITEMS = {};
    let TECH = [];
    let TECH_LOOKUP = {};
    let SKILL_DETAILS = {};
    let PASSIVE_DETAILS = {};
    let ITEM_DETAILS = {};
    // Map of items to pals that drop them.  Populated after data load.
    let DROPS_MAP = {};
    // Map pal names to IDs for quick lookup when clicking breeding
    // combos.  Populated after data load.
    let PAL_NAME_TO_ID = {};
    let PAL_SLUG_TO_ID = {};
    // Persist breeding page selections between rebuilds (e.g. when switching modes)
    const BREEDING_SELECTION = { parent1Id: null, parent2Id: null, babyId: null, mode: 'breedingPredict' };
    // Progress tracking
    let caught = JSON.parse(localStorage.getItem('caught') || '{}');
    let collected = JSON.parse(localStorage.getItem('collected') || '{}');
    let unlocked = JSON.parse(localStorage.getItem('unlocked') || '{}');
    // Maximum stats for scaling radar chart
    // Maximum stats for scaling radar chart.  Speed is capped lower to avoid
    // overpowering the chart – the fastest pals reach around 1000.
    const maxStats = { hp: 150, attack: 150, defense: 145, speed: 1000, stamina: 350, support: 150, food: 9 };
    // Type to environment mapping
    const environmentMap = {
      'Fire': 'Volcano',
      'Ice': 'Snow',
      'Electric': 'Coast',
      'Water': 'River',
      'Grass': 'Forest',
      'Ground': 'Desert',
      'Dark': 'Swamp',
      'Dragon': 'Mountains',
      'Air': 'Highlands',
      'Neutral': 'Plains'
    };
    // Rarity to recommended sphere
    const raritySphere = {
      1: 'Pal Sphere',
      2: 'Mega Sphere',
      3: 'Giga Sphere',
      4: 'Hyper Sphere',
      5: 'Ultra Sphere',
      6: 'Legendary Sphere'
    };
    // Human-friendly rarity names for better readability on cards and details.
    const rarityNames = {
      1: 'Common',
      2: 'Uncommon',
      3: 'Rare',
      4: 'Epic',
      5: 'Legendary',
      6: 'Mythic'
    };
    // Sphere capture rates and descriptions (approximate for guidance)
    const sphereRates = {
      'Pal Sphere': { rate: 0.3, description: 'Good for beginners and low-level pals (Lv 1-15)' },
      'Mega Sphere': { rate: 0.45, description: 'Better success for mid-level pals (Lv 16-30)' },
      'Giga Sphere': { rate: 0.6, description: 'Ideal for stronger pals (Lv 31-45)' },
      'Hyper Sphere': { rate: 0.75, description: 'Very high success for tough pals (Lv 46-60)' },
      'Ultra Sphere': { rate: 0.85, description: 'Excellent for very tough pals (Lv 61-70)' },
      'Legendary Sphere': { rate: 1.0, description: 'Guaranteed catch for legendary pals (Lv 71+)' }
    };
    // Trait lists for guidance (simplified)
    const goodTraits = ['Diligent', 'Runner', 'Strong', 'Loyal'];
    const badTraits = ['Coward', 'Lazy', 'Gullible'];

    // Whether we’re in Kid Mode.  Kid Mode simplifies the UI by
    // enlarging fonts, hiding advanced stats and using shorter
    // explanations.  Start in kid mode by default; toggled via the
    // mode button in the nav bar.
    let kidMode = true;
    document.body.classList.toggle('kid-mode', kidMode);

    // Descriptions for active skills.  Each entry maps the skill key
    // (as it appears in the data) to a human-friendly object with
    // damage, type (AoE, cone, single-target) and a brief description
    // gleaned from community knowledge and official guides.  When
    // unknown, we provide a generic description encouraging players to
    // experiment.  Feel free to extend this dictionary with more
    // abilities as you discover them.
    const defaultSkillsDictionary = {
      'rolly_poly': { name:'Roly Poly', damage:'Low', type:'Charge', description:'Curls into a ball and rolls after foes; be careful as you may become dizzy afterwards' },
      'air_cannon': { name:'Air Cannon', damage:'Moderate', type:'Projectile', description:'Fires compressed air that pushes enemies back in a line' },
      'power_shot': { name:'Power Shot', damage:'Moderate', type:'Projectile', description:'Charges up and fires a strong projectile at a single target' },
      'implode': { name:'Implode', damage:'Massive', type:'Area', description:'Self-destructs in a powerful explosion harming all nearby – the user faints afterwards' },
      'electric_ball': { name:'Electric Ball', damage:'High', type:'Projectile', description:'Launches a ball of lightning that zaps enemies on contact' },
      'dragon_burst': { name:'Dragon Burst', damage:'High', type:'Area', description:'Unleashes draconic energy in a burst around the user' },
      'fire_blast': { name:'Fire Blast', damage:'High', type:'Cone', description:'Breathes fire in a wide cone, burning anything in its path' },
      'leaf_dance': { name:'Leaf Dance', damage:'Moderate', type:'Area', description:'Summons swirling leaves that slice nearby enemies' }
    ,
      // Additional skills with descriptions derived from the Palworld Wiki【841863502450800†L124-L156】.  These give
      // players a better sense of each move’s effect.
      'acid_rain': { name:'Acid Rain', damage:'Moderate', type:'Area', description:'Creates acidic clouds that pour down rain on enemies' },
      'air_blade': { name:'Air Blade', damage:'Moderate', type:'Fan', description:'Sends out sharp blades of air in a fan shape' },
      'apocalypse': { name:'Apocalypse', damage:'High', type:'Area', description:'Generates several dark vortexes in the surrounding area' },
      'aqua_burst': { name:'Aqua Burst', damage:'High', type:'Projectile', description:'Creates a giant ball of water and hurls it at an enemy' },
      'aqua_gun': { name:'Aqua Gun', damage:'Low', type:'Projectile', description:'Hurls a ball of water straight at an enemy' },
      'beam_slicer': { name:'Beam Slicer', damage:'Very High', type:'Beam', description:'Mows down the frontal area with a dragon beam; the impacted area explodes shortly after' },
      'blast_cannon': { name:'Blast Cannon', damage:'High', type:'Projectile', description:'Fires an energy bullet imbued with dragon power that explodes on impact' },
      'blizzard_spike': { name:'Blizzard Spike', damage:'Very High', type:'Projectile', description:'Creates a giant lump of ice and hurls it; damages those in the surrounding area upon impact' },
      'bog_blast': { name:'Bog Blast', damage:'Low', type:'Projectile', description:'Hurls sticky mud at an enemy' },
      'bubble_blast': { name:'Bubble Blast', damage:'Moderate', type:'Homing', description:'Fires numerous bubbles that slowly pursue an enemy' },
      'circle_vine': { name:'Circle Vine', damage:'High', type:'Area', description:'Sprouts sharp roots in and around the enemy’s location' },
      'comet_strike': { name:'Comet Strike', damage:'High', type:'Area', description:'Drops a meteorite straight down, generating a shock wave around the impact area' },
      'cryst_breath': { name:'Cryst Breath', damage:'High', type:'Cone', description:'Enshrouds an enemy in a frigid blast of air, dealing continuous damage' },
      'dark_arrow': { name:'Dark Arrow', damage:'Moderate', type:'Homing', description:'Fires off dark energy that homes in on an enemy' },
      'dark_ball': { name:'Dark Ball', damage:'Low', type:'Homing', description:'Unleashes a sphere of darkness that slowly tracks down the enemy' },
      'dark_cannon': { name:'Dark Cannon', damage:'Moderate', type:'Projectile', description:'Fires off dark energy that homes in on an enemy' },
      'dark_laser': { name:'Dark Laser', damage:'Very High', type:'Beam', description:'Charges dark energy before blasting enemies with a powerful beam' },
      'diamond_rain': { name:'Diamond Rain', damage:'Very High', type:'Area', description:'Creates numerous lumps of ice that consecutively drop on a foe’s head' },
      'draconic_breath': { name:'Draconic Breath', damage:'Moderate', type:'Cone', description:'Exhales breath imbued with draconic energy, dealing continuous damage to those in front' },
      'dragon_cannon': { name:'Dragon Cannon', damage:'Low', type:'Projectile', description:'Hurls an energy ball imbued with draconic energy at an enemy' },
      'dragon_meteor': { name:'Dragon Meteor', damage:'Very High', type:'Area', description:'Calls down numerous small meteorites and launches them at an enemy' },
      'fire_ball': { name:'Fire Ball', damage:'Very High', type:'Projectile', description:'Creates a giant ball of flames and hurls it; it explodes over a wide area upon impact' },
      'flame_funnel': { name:'Flame Funnel', damage:'High', type:'Area', description:'Creates multiple spheres of fiery energy, from which countless fireballs shoot towards the enemy' },
      'flame_wall': { name:'Flame Wall', damage:'High', type:'Area', description:'Creates a wall of flames at the enemy’s location; the wall remains and deals damage over time' },
      'flare_arrow': { name:'Flare Arrow', damage:'Moderate', type:'Homing', description:'Fires three flaming arrows in succession that home in on an enemy' },
      'flare_storm': { name:'Flare Storm', damage:'Moderate', type:'Area', description:'Generates two flaming tornadoes on either side before launching them at an enemy' }
    };
    let skillsDictionary = { ...defaultSkillsDictionary };

    // Descriptions for passive traits.  Each entry summarises the
    // benefits or drawbacks of the trait.  We extracted a few from
    // community guides and added our own commentary for others.  Add
    // additional traits here as needed.  Traits not present here
    // will display a generic encouragement to experiment.
    const defaultTraitsDictionary = {
      'Swift': 'Increases movement speed by 30%, letting your pal dash around quickly',
      'Legend': 'Raises Attack and Defense by 20% and Movement Speed by 15%',
      'Lord of the Sea': 'Increases Water attack damage by 20%',
      'Runner': 'Boosts movement speed by 20%',
      'Diligent': 'Raises work efficiency, making jobs go 20% faster',
      'Strong': 'Increases attack damage by 20%',
      'Loyal': 'Improves Attack and Defense slightly (about 10%)',
      'Coward': 'Lowers Attack and Defense by 10%; this pal gets scared easily',
      'Lazy': 'Decreases work speed by 20%, making tasks take longer',
      'Gullible': 'More susceptible to negative status effects; be wary when battling'
    };
    let traitsDictionary = { ...defaultTraitsDictionary };

    // Mapping of environment names to highlight coordinates.  Each
    // environment corresponds to a circular highlight on the map.  The
    // x and y values represent the percentage offsets from the top-left
    // corner of the map image, while w and h represent the diameter
    // percentages of the highlight.  These were chosen manually to
    // approximate the Palworld regions and provide a more natural
    // spotlight compared to boxy overlays.
    const zonePositions = {
      'Volcano': { x: 68, y: 10, w: 30, h: 30 },
      'Snow': { x: 10, y: 10, w: 25, h: 25 },
      'Plains': { x: 40, y: 50, w: 35, h: 35 },
      'Forest': { x: 12, y: 55, w: 25, h: 25 },
      'Coast': { x: 78, y: 60, w: 25, h: 25 },
      'Desert': { x: 50, y: 65, w: 25, h: 25 },
      'Swamp': { x: 85, y: 45, w: 20, h: 20 },
      'Mountains': { x: 50, y: 20, w: 25, h: 25 },
      'Highlands': { x: 40, y: 5, w: 30, h: 20 },
      'River': { x: 5, y: 70, w: 25, h: 20 }
    };

    const DATA_SOURCES = [
      'data/palworld_complete_data_final.json',
      'data/palworld_complete_data_enhanced.json',
      'data/palworld_complete_data.json'
    ];
    const EMBEDDED_DATA_SCRIPT = 'data/palworld_complete_data_fallback.js';
    const ITEM_DETAILS_SOURCES = ['data/item_details.json'];
    const ITEM_DETAILS_FALLBACK_SCRIPT = 'data/item_details_fallback.js';
    const ITEM_DETAILS_GLOBAL = '__PALMATE_ITEM_DETAILS__';
    let embeddedDataPromise = null;
    let itemDetailsEmbeddedPromise = null;

    async function loadEmbeddedDataset() {
      if (window.__PALMATE_EMBEDDED_DATA__) {
        return window.__PALMATE_EMBEDDED_DATA__;
      }
      if (!embeddedDataPromise) {
        embeddedDataPromise = new Promise(resolve => {
          const script = document.createElement('script');
          script.src = EMBEDDED_DATA_SCRIPT;
          script.async = true;
          script.onload = () => resolve(window.__PALMATE_EMBEDDED_DATA__ || null);
          script.onerror = event => {
            console.warn('Unable to load embedded dataset script.', event);
            resolve(null);
          };
          document.head.appendChild(script);
        });
      }
      try {
        return await embeddedDataPromise;
      } catch (err) {
        console.warn('Embedded dataset loader failed.', err);
        return null;
      }
    }
    async function loadItemDetailsFallback() {
      if (window[ITEM_DETAILS_GLOBAL]) {
        return window[ITEM_DETAILS_GLOBAL];
      }
      if (!itemDetailsEmbeddedPromise) {
        itemDetailsEmbeddedPromise = new Promise(resolve => {
          const script = document.createElement('script');
          script.src = ITEM_DETAILS_FALLBACK_SCRIPT;
          script.async = true;
          script.onload = () => resolve(window[ITEM_DETAILS_GLOBAL] || null);
          script.onerror = event => {
            console.warn('Unable to load item detail fallback script.', event);
            resolve(null);
          };
          document.head.appendChild(script);
        });
      }
      try {
        return await itemDetailsEmbeddedPromise;
      } catch (err) {
        console.warn('Item detail fallback loader failed.', err);
        return null;
      }
    }
    async function loadItemDetailsDataset() {
      const loadErrors = [];
      for (const source of ITEM_DETAILS_SOURCES) {
        try {
          const response = await fetch(source);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const payload = await response.json();
          if (!payload || typeof payload !== 'object') {
            throw new Error('Invalid JSON payload');
          }
          return payload;
        } catch (error) {
          loadErrors.push({ source, error });
          console.warn(`Failed to load item details from ${source}`, error);
        }
      }
      return null;
    }
    async function loadItemDetails() {
      const dataset = await loadItemDetailsDataset();
      if (dataset) return dataset;
      const fallback = await loadItemDetailsFallback();
      if (fallback) return fallback;
      console.warn('Item detail dataset unavailable. Item cards will use minimal info.');
      return {};
    }
    // Type icon mapping (relative file paths)
    const iconMap = {
      'Neutral': 'assets/icons/neutral.png',
      'Fire': 'assets/icons/fire.png',
      'Ice': 'assets/icons/ice.png',
      'Electric': 'assets/icons/electric.png',
      'Water': 'assets/icons/water.png',
      'Grass': 'assets/icons/grass.png',
      'Ground': 'assets/icons/ground.png',
      'Dark': 'assets/icons/dark.png',
      'Dragon': 'assets/icons/dragon.png',
      'Air': 'assets/icons/air.png'
    };

    // Audio cues for a more immersive UI.  Users can add their own sound files
    // (e.g. click.mp3, modal_open.mp3, modal_close.mp3) inside assets/sounds.
    const clickSound = new Audio('assets/sounds/click.mp3');
    const openSound = new Audio('assets/sounds/modal_open.mp3');
    const closeSound = new Audio('assets/sounds/modal_close.mp3');
    function playSound(sound) {
      // Gracefully handle missing audio files
      if (!sound || typeof sound.play !== 'function') return;
      try {
        sound.currentTime = 0;
        sound.play();
      } catch (err) {
        // Audio play can fail if files are missing or browser policy blocks it
        console.debug('Sound error', err);
      }
    }
    // Navigation handling: top nav bar.  Each .nav-item button
    // switches to its associated page when clicked.  After the
    // switch, we play a click sound.
    document.querySelectorAll('#navbar .nav-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-page');
        switchPage(target);
        playSound(clickSound);
      });
    });

    // Mode toggle button: switch between kid and grown-up modes.  The
    // icon and tooltip change based on the current mode.  We also
    // apply a class on the body for CSS adjustments and rebuild
    // pages to honour the new mode (e.g. hiding advanced stats).
    document.getElementById('modeToggle').addEventListener('click', () => {
      kidMode = !kidMode;
      document.body.classList.toggle('kid-mode', kidMode);
      const modeIcon = document.querySelector('#modeToggle i');
      const toggleTitle = document.getElementById('modeToggle');
      if (kidMode) {
        modeIcon.classList.remove('fa-user-astronaut');
        modeIcon.classList.add('fa-child');
        toggleTitle.title = 'Switch to grown-up mode';
      } else {
        modeIcon.classList.remove('fa-child');
        modeIcon.classList.add('fa-user-astronaut');
        toggleTitle.title = 'Switch to kid mode';
      }
      // Rebuild dynamic pages to reflect the mode change
      buildPalPage();
      buildItemPage();
      buildTechPage();
      buildBreedingPage();
      buildGlossaryPage();
      renderRouteGuide();
      // Home page re-render to update suggestions styling
      buildHomePage();
    });
    function switchPage(page) {
      // Hide all pages and show the selected page.  Our pages are
      // <section> elements with IDs like palsPage, itemsPage, etc.
      document.querySelectorAll('.page').forEach(section => section.classList.remove('active'));
      const activePage = document.getElementById(page + 'Page');
      if (activePage) activePage.classList.add('active');
      // Update navigation item active state
      document.querySelectorAll('#navbar .nav-item').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-page') === page);
      });
    }
    // Modal controls
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    document.getElementById('modalClose').addEventListener('click', closeModal);
    modal.addEventListener('click', event => {
      if (event.target === modal) {
        closeModal();
      }
    });
    function openModal() {
      modal.classList.add('active');
      playSound(openSound);
    }
    function closeModal() {
      modal.classList.remove('active');
      modalBody.innerHTML = '';
      playSound(closeSound);
    }
    const PALWORLD_BASE_URL = 'https://palworld.gg';
    const PALWORLD_PAL_SLUG_OVERRIDES = {
      // Reserved for pals whose Palworld.gg slug does not match the default slugification.
    };
    const PALWORLD_ITEM_SLUG_OVERRIDES = {
      // Reserved for items whose Palworld.gg slug does not match their key.
    };
    const ROUTE_GLOSSARY_SUMMARIES = {
      'lifmunk-effigy': {
        title: 'Lifmunk Effigy',
        kid: [
          'Tiny glowing statues hidden all over Palworld.',
          'Feed them to the Statue of Power to make catching pals easier.'
        ],
        grown: [
          'Collectible statues that grant Capture Power when offered at a Statue of Power.',
          'Always grab them on sight; the bonus stacks and makes catching high-level pals easier.'
        ],
        url: `${PALWORLD_BASE_URL}/items?search=${encodeURIComponent('Lifmunk Effigy')}`,
        note: 'Peek at Palworld.gg without losing your place in the route.'
      },
      'skill-fruit': {
        title: 'Skill Fruit',
        kid: [
          'Special fruit that lets a pal learn a new move.',
          'Find them in dungeons or treasure chests and save the ones you like.'
        ],
        grown: [
          'Consumable items that instantly teach the move printed on the fruit.',
          'Best sourced from dungeons; stash rare elements until you know which pal will use them.'
        ],
        url: `${PALWORLD_BASE_URL}/items?search=${encodeURIComponent('Skill Fruit')}`,
        note: 'Palmate keeps this move info handy so you can stay on track.'
      }
    };
    const MAP_WORLD_BOUNDS = { minX: -720, maxX: 720, minY: -720, maxY: 720 };
    function clampToRange(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }
    function worldCoordsToPercent(coords) {
      if (!Array.isArray(coords) || coords.length < 2) {
        return { left: 50, top: 50 };
      }
      const [rawX, rawY] = coords.map(Number);
      const width = MAP_WORLD_BOUNDS.maxX - MAP_WORLD_BOUNDS.minX;
      const height = MAP_WORLD_BOUNDS.maxY - MAP_WORLD_BOUNDS.minY;
      if (!width || !height) {
        return { left: 50, top: 50 };
      }
      const x = clampToRange(rawX, MAP_WORLD_BOUNDS.minX, MAP_WORLD_BOUNDS.maxX);
      const y = clampToRange(rawY, MAP_WORLD_BOUNDS.minY, MAP_WORLD_BOUNDS.maxY);
      return {
        left: ((x - MAP_WORLD_BOUNDS.minX) / width) * 100,
        top: ((MAP_WORLD_BOUNDS.maxY - y) / height) * 100
      };
    }
    function mapDescriptionLines(info) {
      if (!info) return [];
      if (kidMode && Array.isArray(info.kid) && info.kid.length) {
        return info.kid;
      }
      if (!kidMode && Array.isArray(info.grown) && info.grown.length) {
        return info.grown;
      }
      if (info.note) {
        return [info.note];
      }
      return [];
    }
    function openRouteMapModal(mapInfo = {}, fallbackUrl) {
      const coords = Array.isArray(mapInfo.coords) ? mapInfo.coords : null;
      if (!coords) {
        window.open(mapInfo.url || fallbackUrl || `${PALWORLD_BASE_URL}/map`, '_blank', 'noopener');
        return;
      }
      const { left, top } = worldCoordsToPercent(coords);
      modalBody.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'map-modal';
      const heading = document.createElement('h3');
      heading.textContent = mapInfo.title || 'Route location';
      wrap.appendChild(heading);
      const meta = document.createElement('p');
      meta.className = 'map-modal-note';
      const metaBits = [];
      if (mapInfo.region) metaBits.push(mapInfo.region);
      metaBits.push(`Coordinates: (${coords[0]}, ${coords[1]})`);
      meta.textContent = metaBits.join(' • ');
      wrap.appendChild(meta);
      const details = mapDescriptionLines(mapInfo);
      if (details.length) {
        const detailsWrap = document.createElement('div');
        detailsWrap.className = 'map-modal-details';
        details.forEach(line => {
          const p = document.createElement('p');
          p.textContent = line;
          detailsWrap.appendChild(p);
        });
        wrap.appendChild(detailsWrap);
      }
      const canvas = document.createElement('div');
      canvas.className = 'map-modal-canvas';
      const mapImage = document.createElement('img');
      mapImage.src = 'assets/images/palworld-full-map-2.webp';
      mapImage.alt = mapInfo.title ? `${mapInfo.title} location on the Palworld map` : 'Palworld map showing the selected route location';
      canvas.appendChild(mapImage);
      const marker = document.createElement('div');
      marker.className = 'map-marker';
      marker.style.left = `${left}%`;
      marker.style.top = `${top}%`;
      const markerLabel = mapInfo.label || mapInfo.title;
      if (markerLabel) {
        const label = document.createElement('span');
        label.className = 'map-marker-label';
        label.textContent = markerLabel;
        marker.appendChild(label);
      }
      canvas.appendChild(marker);
      wrap.appendChild(canvas);
      const actions = document.createElement('div');
      actions.className = 'badges';
      actions.style.marginTop = '4px';
      const openBtn = document.createElement('button');
      openBtn.type = 'button';
      openBtn.className = 'modal-action-btn';
      openBtn.textContent = 'Open interactive map';
      openBtn.addEventListener('click', () => {
        window.open(mapInfo.url || fallbackUrl || `${PALWORLD_BASE_URL}/map`, '_blank', 'noopener');
      });
      actions.appendChild(openBtn);
      wrap.appendChild(actions);
      modalBody.appendChild(wrap);
      openModal();
    }
    function openTowerMap(link) {
      if (!link) return;
      const info = link.map ? { ...link.map } : {};
      if (!info.url && link.url) {
        info.url = link.url;
      }
      if (!info.title) {
        info.title = niceName(link.id || 'Tower');
      }
      openRouteMapModal(info, link.url);
    }
    function slugifyForPalworld(text) {
      if (!text) return '';
      return text
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/&/g, ' and ')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
    }
    function humaniseItemKey(key) {
      if (!key) return '';
      return key
        .split('_')
        .filter(Boolean)
        .map(part => part.charAt(0).toUpperCase() + part.slice(1))
        .join(' ');
    }
    function openPalworldEmbed({ heading, url, fallbackUrl, note, summaryHtml }) {
      modalBody.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'external-embed';
      const actions = document.createElement('div');
      actions.className = 'embed-actions';
      const titleEl = document.createElement('h3');
      titleEl.textContent = heading;
      actions.appendChild(titleEl);
      if (url) {
        const link = document.createElement('a');
        link.href = url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.className = 'embed-link';
        link.textContent = 'Open in new tab';
        actions.appendChild(link);
      }
      wrap.appendChild(actions);
      const noteEl = document.createElement('p');
      noteEl.className = 'embed-note';
      noteEl.textContent = note || 'This view pulls live details from Palworld.gg while keeping your progress tracker close at hand.';
      wrap.appendChild(noteEl);
      if (summaryHtml) {
        const summary = document.createElement('div');
        summary.className = 'embed-summary';
        summary.innerHTML = summaryHtml;
        wrap.appendChild(summary);
      }
      if (url) {
        const frame = document.createElement('iframe');
        frame.src = url;
        frame.title = heading;
        frame.loading = 'lazy';
        frame.referrerPolicy = 'no-referrer-when-downgrade';
        frame.className = 'embed-frame';
        wrap.appendChild(frame);
      }
      const fallback = document.createElement('p');
      fallback.className = 'embed-fallback';
      const fallbackLink = document.createElement('a');
      fallbackLink.href = fallbackUrl || url || PALWORLD_BASE_URL;
      fallbackLink.target = '_blank';
      fallbackLink.rel = 'noopener';
      fallbackLink.textContent = 'Open on Palworld.gg';
      fallback.appendChild(document.createTextNode('If the page does not load, '));
      fallback.appendChild(fallbackLink);
      fallback.appendChild(document.createTextNode('.'));
      wrap.appendChild(fallback);
      modalBody.appendChild(wrap);
      openModal();
      return wrap;
    }
    async function loadDatasetSequentially() {
      const isFileProtocol = window.location.protocol === 'file:';
      if (isFileProtocol) {
        const embeddedPayload = await loadEmbeddedDataset();
        if (embeddedPayload) {
          return { payload: embeddedPayload, source: 'embedded fallback dataset' };
        }
        console.warn('File protocol detected but embedded dataset fallback was unavailable. Continuing with fetch attempts.');
      }
      const loadErrors = [];
      for (const source of DATA_SOURCES) {
        try {
          const response = await fetch(source);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const payload = await response.json();
          if (!payload || typeof payload !== 'object') {
            throw new Error('Invalid JSON payload');
          }
          if (!payload.pals || !payload.items || !payload.tech) {
            console.warn(`Dataset ${source} missing required keys. Skipping.`);
            continue;
          }
          return { payload, source };
        } catch (err) {
          loadErrors.push({ source, error: err });
          console.warn(`Failed to load dataset ${source}`, err);
        }
      }
      const embeddedFallback = await loadEmbeddedDataset();
      if (embeddedFallback) {
        return { payload: embeddedFallback, source: 'embedded fallback dataset' };
      }
      const errorSummary = loadErrors.length
        ? loadErrors.map(entry => {
            const reason = entry.error && entry.error.message ? entry.error.message : entry.error;
            return `${entry.source} (${reason})`;
          }).join('; ')
        : '';
      const summarySuffix = errorSummary ? ` ${errorSummary}` : '';
      throw new Error(`Unable to load any dataset from the data folder.${summarySuffix}`);
    }

    (async function initialisePalmate() {
      try {
        const { payload, source } = await loadDatasetSequentially();
        console.info(`Palmate data source: ${source}`);
        // Data is namespaced under pals, items and tech plus extra sections
        PALS = payload.pals || {};
        ITEMS = payload.items || {};
        TECH = payload.tech || [];
        rebuildTechLookup();
        SKILL_DETAILS = payload.skillsDetails || {};
        PASSIVE_DETAILS = payload.passiveDetails || {};
        ITEM_DETAILS = await loadItemDetails();
        // Build name‑to‑ID lookup map
        PAL_NAME_TO_ID = {};
        PAL_SLUG_TO_ID = {};
        Object.values(PALS).forEach(p => {
          PAL_NAME_TO_ID[p.name] = p.id;
          const slug = slugifyForPalworld(p.name);
          if(slug) PAL_SLUG_TO_ID[slug] = p.id;
        });
        // Build a global map of item drops for quick lookup
        DROPS_MAP = {};
        Object.values(PALS).forEach(pal => {
          (pal.drops || []).forEach(item => {
            if (!DROPS_MAP[item]) DROPS_MAP[item] = [];
            DROPS_MAP[item].push(pal.name);
          });
        });
        // Build pages
        buildPalPage();
        buildItemPage();
        buildTechPage();
        buildBreedingPage();
        buildHomePage();
        renderRouteGuide();
        // Synchronise skills and traits dictionaries with the loaded data.
        // Override the static dictionaries with entries from the JSON file.
        skillsDictionary = { ...defaultSkillsDictionary };
        if (SKILL_DETAILS && Object.keys(SKILL_DETAILS).length) {
          const normalizedSkills = {};
          Object.entries(SKILL_DETAILS).forEach(([key, info = {}]) => {
            const normalizedKey = key.toLowerCase().replace(/[\s-]+/g, '_');
            normalizedSkills[normalizedKey] = {
              name: (info.name || key).replace(/_/g, ' '),
              damage: info.power ? `Power ${info.power}` : (info.damage || 'Unknown'),
              type: info.element || info.type || 'Unknown',
              description: info.description || 'No description available.'
            };
          });
          skillsDictionary = { ...defaultSkillsDictionary, ...normalizedSkills };
        }
        traitsDictionary = { ...defaultTraitsDictionary };
        if (PASSIVE_DETAILS && Object.keys(PASSIVE_DETAILS).length) {
          traitsDictionary = { ...defaultTraitsDictionary, ...PASSIVE_DETAILS };
        }
        buildGlossaryPage();
        buildMapPage();
        buildProgressPage();
        updateProgressUI();
      } catch (err) {
        console.error(err);
        const reason = err && err.message ? ` (${err.message})` : '';
        const extraHelp = window.location.protocol === 'file:'
          ? ' Launching a local web server or regenerating data/palworld_complete_data_fallback.js usually resolves file:// restrictions.'
          : ' Please confirm that the data folder is deployed with the site.';
        document.body.insertAdjacentHTML('beforeend', `<p style="color:red">Failed to load data${reason}.${extraHelp}</p>`);
      }
    })();
    // Build pal page
    function buildPalPage() {
      const list = document.getElementById('palsList');
      const search = document.getElementById('palSearch');
      function render(filter = '') {
        list.innerHTML = '';
        const term = filter.toLowerCase();
        Object.values(PALS).forEach(pal => {
          if (!pal.name.toLowerCase().includes(term) && !pal.types.join(',').toLowerCase().includes(term)) return;
          const card = document.createElement('div');
          card.className = 'pal-card';
          // Build type icon HTML
          const typeIcons = pal.types.map(t => `<img src="${iconMap[t] || iconMap['Neutral']}" alt="${t} icon" style="width:20px;height:20px;margin-right:2px;">`).join('');
          // Render the pal card. Use the local image if available. If the image fails to load
          // (for example, if the pal image file is missing), fall back to the first element
          // icon so the card always has a visual cue. The onerror handler sets the source
          // to the appropriate icon based on the pal’s primary type.
          // Build rarity label and star icons.  Rarity names add readability and
          // stars provide a quick visual indicator.  We use Font Awesome stars
          // here to ensure consistent sizing and colour.
          const rarity = Math.max(1, Math.min(pal.rarity || 0, 6));
          let rarityLabel = rarityNames[rarity] || '';
          let starIcons = Array(rarity).fill('<i class="fa-solid fa-star"></i>').join('');
          // In kid mode we suppress rarity and stars to avoid
          // confusion and clutter.  Kids can still see the card
          // colour and image to gauge rarity implicitly.
          if (kidMode) {
            rarityLabel = '';
            starIcons = '';
          }
          card.innerHTML = `
            <img src="${pal.localImage || iconMap[pal.types[0]] || iconMap['Neutral']}" alt="${pal.name} image"
                 onerror="this.onerror=null; this.src='${'assets/icons/'}${pal.types[0].toLowerCase()}.png';">
            <div class="name">${pal.name}</div>
            <div class="badge">${typeIcons}</div>
            <div class="rarity"><span class="stars">${starIcons}</span> <span class="label">${rarityLabel}</span></div>
            <button class="catch-btn ${caught[pal.id] ? 'caught' : ''}">${caught[pal.id] ? 'Caught' : 'Catch'}</button>
          `;
          card.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() === 'button') return;
            showPalDetail(pal.id);
          });
          const btn = card.querySelector('button');
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            caught[pal.id] = !caught[pal.id];
            localStorage.setItem('caught', JSON.stringify(caught));
            btn.classList.toggle('caught', caught[pal.id]);
            btn.textContent = caught[pal.id] ? 'Caught' : 'Catch';
            updateProgressUI();
            playSound(clickSound);
          });
          list.appendChild(card);
        });
      }
      search.addEventListener('input', () => render(search.value));
      render();
    }
    function updateItemCollectionButtons(itemKey) {
      document.querySelectorAll(`.item-card button.collect-btn[data-item-key="${itemKey}"]`).forEach(btn => {
        const state = !!collected[itemKey];
        btn.classList.toggle('collected', state);
        btn.textContent = state ? 'Collected' : 'Collect';
      });
    }
    // Show pal details in a modal by embedding the Palworld.gg page
    // alongside quick progress hints and a shortcut back to the map.
    function showPalDetail(id) {
      const pal = PALS[id];
      if (!pal) return;
      const slug = PALWORLD_PAL_SLUG_OVERRIDES[pal.name] || slugifyForPalworld(pal.name);
      const palUrl = slug ? `${PALWORLD_BASE_URL}/pal/${slug}` : `${PALWORLD_BASE_URL}/pals`;
      const fallbackUrl = `${PALWORLD_BASE_URL}/pals?search=${encodeURIComponent(pal.name)}`;
      const habitats = pal.spawnAreas && pal.spawnAreas.length
        ? pal.spawnAreas.join(', ')
        : (environmentMap[pal.types && pal.types[0]] || 'Unknown');
      const sphere = raritySphere[pal.rarity] || 'Pal Sphere';
      const sphereInfo = sphereRates[sphere];
      const caughtStatus = caught[pal.id];
      const summaryLines = [];
      if (kidMode) {
        summaryLines.push(`<strong>Status:</strong> ${caughtStatus ? 'We caught this pal!' : 'Still looking for this pal.'}`);
        if (habitats && habitats !== 'Unknown') {
          summaryLines.push(`<strong>Where it lives:</strong> ${habitats}`);
        }
        summaryLines.push(`<strong>Catch tip:</strong> Try a ${sphere}.`);
      } else {
        summaryLines.push(`<strong>Tracking:</strong> ${caughtStatus ? 'Caught' : 'Not caught yet'}`);
        if (habitats) {
          summaryLines.push(`<strong>Habitats:</strong> ${habitats}`);
        }
        if (sphereInfo) {
          summaryLines.push(`<strong>Suggested Sphere:</strong> ${sphere} (${Math.round(sphereInfo.rate * 100)}% base) – ${sphereInfo.description}`);
        }
      }
      summaryLines.push(`<button type="button" class="open-map-button modal-action-btn">Open Map</button>`);
      const summaryHtml = summaryLines.map(line => `<p>${line}</p>`).join('');
      const note = kidMode
        ? 'We show the Palworld.gg page here so you can read about this pal without leaving your guide.'
        : 'Palworld.gg has the most complete breakdowns. Enjoy them in-place while Palmate keeps tracking your progress.';
      const wrap = openPalworldEmbed({
        heading: `${pal.name} – Palworld.gg`,
        url: palUrl,
        fallbackUrl,
        note,
        summaryHtml
      });
      const mapButton = wrap.querySelector('.open-map-button');
      if (mapButton) {
        mapButton.addEventListener('click', (event) => {
          event.preventDefault();
          closeModal();
          switchPage('map');
        });
      }
    }
    window.viewPal = function(identifier){
      if(identifier === undefined || identifier === null) return;
      if(typeof identifier === 'number'){
        showPalDetail(identifier);
        return;
      }
      const normalized = String(identifier).toLowerCase();
      const slugId = PAL_SLUG_TO_ID[normalized];
      if(slugId){
        showPalDetail(slugId);
        return;
      }
      const byName = PAL_NAME_TO_ID[capitalize(normalized)];
      if(byName){
        showPalDetail(byName);
        return;
      }
      focusSearch(identifier);
    };
    // Build items page
    function buildItemPage() {
      const list = document.getElementById('itemsList');
      const search = document.getElementById('itemSearch');
      // Compute which pals drop each item
      const dropsMap = {};
      Object.values(PALS).forEach(pal => {
        (pal.drops || []).forEach(item => {
          if (!dropsMap[item]) dropsMap[item] = [];
          dropsMap[item].push(pal.name);
        });
      });
      function render(filter = '') {
        list.innerHTML = '';
        const term = filter.toLowerCase();
        Object.keys(ITEMS).sort().forEach(item => {
          const human = item.replace(/_/g,' ');
          if (!human.toLowerCase().includes(term)) return;
          const card = document.createElement('div');
          card.className = 'item-card';
          card.dataset.itemKey = item;
          const category = ITEMS[item].category || 'Misc';
          card.innerHTML = `
            <div class="name">${human}</div>
            <div class="category">${category}</div>
            <div class="drops">Dropped by: ${(dropsMap[item] || []).join(', ') || 'None'}</div>
            <button class="collect-btn ${collected[item] ? 'collected' : ''}">${collected[item] ? 'Collected' : 'Collect'}</button>
          `;
          const btn = card.querySelector('button');
          btn.dataset.itemKey = item;
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            collected[item] = !collected[item];
            localStorage.setItem('collected', JSON.stringify(collected));
            btn.classList.toggle('collected', collected[item]);
            btn.textContent = collected[item] ? 'Collected' : 'Collect';
            updateProgressUI();
          });
          // Clicking the card opens the item details modal.  Exclude button clicks.
          card.addEventListener('click', (e) => {
            // Only trigger if the click target is not the button
            if (e.target.tagName.toLowerCase() === 'button') return;
            openItemDetail(item);
          });
          list.appendChild(card);
        });
      }
      search.addEventListener('input', () => render(search.value));
      render();
    }
    // Build technology tree page
    function buildTechPage() {
      const list = document.getElementById('techList');
      list.innerHTML = '';
      TECH.forEach(level => {
        const wrapper = document.createElement('div');
        wrapper.className = 'tech-level';
        wrapper.innerHTML = `<h3>Tech Level ${level.level}</h3>`;
        level.items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'tech-item';
          const techId = item.id || slugifyForPalworld(item.name);
          if(techId) div.id = `tech-${techId}`;
        const matList = item.materials ? Object.entries(item.materials).map(([k,v]) => `${k}: ${v}`).join(', ') : '';
        const matStr = matList ? `<span class="materials">Materials: ${matList}</span><br>` : '';
        const techPoints = item.techPoints ? `<span class="materials">Tech Points: ${item.techPoints}</span><br>` : '';
        div.innerHTML = `
            <strong>${item.name}</strong> (${item.category})<br>
            ${matStr}${techPoints}
            <span class="description">${item.description || ''}</span><br>
            <button class="unlock-btn ${unlocked[item.name] ? 'unlocked' : ''}">${unlocked[item.name] ? 'Unlocked' : 'Unlock'}</button>
          `;
          const btn = div.querySelector('button');
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            unlocked[item.name] = !unlocked[item.name];
            localStorage.setItem('unlocked', JSON.stringify(unlocked));
            btn.classList.toggle('unlocked', unlocked[item.name]);
            btn.textContent = unlocked[item.name] ? 'Unlocked' : 'Unlock';
            updateProgressUI();
          });
          wrapper.appendChild(div);
        });
        list.appendChild(wrapper);
      });
    }
    // Build breeding page
    function buildBreedingPage() {
      const parent1Grid = document.getElementById('parent1Grid');
      const parent2Grid = document.getElementById('parent2Grid');
      const babyGrid = document.getElementById('babyGrid');
      const result = document.getElementById('breedingResult');
      const combosContainer = document.getElementById('breedingCombos');
      const parent1Search = document.getElementById('parent1Search');
      const parent2Search = document.getElementById('parent2Search');
      const babySearch = document.getElementById('babySearch');
      const modeButtons = Array.from(document.querySelectorAll('.breeding-tab'));
      const modes = Array.from(document.querySelectorAll('.breeding-mode'));
      if (!parent1Grid || !parent2Grid || !babyGrid || !result || !combosContainer || !parent1Search || !parent2Search || !babySearch) {
        return;
      }
      const palsSorted = Object.values(PALS || {}).sort((a, b) => a.name.localeCompare(b.name));
      let parentState = {
        parent1: BREEDING_SELECTION.parent1Id ? PALS[BREEDING_SELECTION.parent1Id] : null,
        parent2: BREEDING_SELECTION.parent2Id ? PALS[BREEDING_SELECTION.parent2Id] : null
      };
      let selectedBaby = BREEDING_SELECTION.babyId ? PALS[BREEDING_SELECTION.babyId] : null;
      if (!parentState.parent1) parentState.parent1 = null;
      if (!parentState.parent2) parentState.parent2 = null;
      if (!selectedBaby) selectedBaby = null;

      function updateBreedingSelection() {
        BREEDING_SELECTION.parent1Id = parentState.parent1 ? parentState.parent1.id : null;
        BREEDING_SELECTION.parent2Id = parentState.parent2 ? parentState.parent2.id : null;
        BREEDING_SELECTION.babyId = selectedBaby ? selectedBaby.id : null;
      }

      function makeEmptyMessage(text) {
        const msg = document.createElement('p');
        msg.className = 'empty-state';
        msg.textContent = text;
        return msg;
      }

      function createPalCard(pal, options = {}) {
        const { compact = true, selectable = true, selected = false } = options;
        const card = document.createElement('div');
        card.classList.add('pal-card');
        if (compact) card.classList.add('compact');
        if (selectable) card.classList.add('selectable');
        else card.classList.add('static');
        if (selected) card.classList.add('selected');
        const primaryType = (pal.types && pal.types[0]) || 'Neutral';
        const img = document.createElement('img');
        img.src = pal.localImage || iconMap[primaryType] || iconMap['Neutral'];
        img.alt = `${pal.name} image`;
        img.onerror = () => {
          img.onerror = null;
          img.src = iconMap[primaryType] || iconMap['Neutral'];
        };
        card.appendChild(img);
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = pal.name;
        card.appendChild(name);
        const badge = document.createElement('div');
        badge.className = 'badge';
        if (Array.isArray(pal.types) && pal.types.length) {
          pal.types.forEach(type => {
            const icon = document.createElement('img');
            icon.src = iconMap[type] || iconMap['Neutral'];
            icon.alt = `${type} icon`;
            badge.appendChild(icon);
          });
        } else {
          const span = document.createElement('span');
          span.textContent = 'Unknown';
          badge.appendChild(span);
        }
        card.appendChild(badge);
        const rarityEl = document.createElement('div');
        rarityEl.className = 'rarity';
        const starSpan = document.createElement('span');
        starSpan.className = 'stars';
        const labelSpan = document.createElement('span');
        labelSpan.className = 'label';
        const rarity = Math.max(1, Math.min(pal.rarity || 0, 6));
        if (!kidMode) {
          starSpan.innerHTML = Array(rarity).fill('<i class="fa-solid fa-star"></i>').join('');
          labelSpan.textContent = rarityNames[rarity] || '';
        }
        rarityEl.appendChild(starSpan);
        rarityEl.appendChild(labelSpan);
        card.appendChild(rarityEl);
        return card;
      }

      function createComboCard(pal, fallbackName) {
        if (pal) {
          return createPalCard(pal, { compact: true, selectable: false });
        }
        const wrapper = document.createElement('div');
        wrapper.classList.add('pal-card', 'compact', 'static');
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = fallbackName;
        wrapper.appendChild(name);
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = kidMode ? 'Not in list yet' : 'Not in dataset yet';
        wrapper.appendChild(badge);
        const rarity = document.createElement('div');
        rarity.className = 'rarity';
        wrapper.appendChild(rarity);
        return wrapper;
      }

      function filterPals(term) {
        const normalized = (term || '').trim().toLowerCase();
        if (!normalized) return palsSorted.slice();
        return palsSorted.filter(pal => {
          const nameMatch = pal.name.toLowerCase().includes(normalized);
          const typeMatch = Array.isArray(pal.types) && pal.types.some(type => type && type.toLowerCase().includes(normalized));
          return nameMatch || typeMatch;
        });
      }

      function renderParentGrid(slot) {
        const grid = slot === 'parent1' ? parent1Grid : parent2Grid;
        const searchTerm = slot === 'parent1' ? parent1Search.value : parent2Search.value;
        grid.innerHTML = '';
        if (!palsSorted.length) {
          grid.appendChild(makeEmptyMessage(kidMode ? 'Loading pals…' : 'Breeding data is still loading.'));
          return;
        }
        const selected = slot === 'parent1' ? parentState.parent1 : parentState.parent2;
        let matches = filterPals(searchTerm);
        if (selected && !matches.some(p => p.id === selected.id)) {
          matches = [selected, ...matches];
        }
        if (!matches.length) {
          grid.appendChild(makeEmptyMessage(kidMode ? 'No pals match that search.' : 'No pals match your search yet.'));
          return;
        }
        matches.forEach(pal => {
          const isSelected = selected && selected.id === pal.id;
          const card = createPalCard(pal, {
            compact: true,
            selectable: true,
            selected: isSelected
          });
          card.addEventListener('click', () => {
            const alreadySelected = slot === 'parent1'
              ? parentState.parent1 && parentState.parent1.id === pal.id
              : parentState.parent2 && parentState.parent2.id === pal.id;
            if (slot === 'parent1') {
              parentState.parent1 = alreadySelected ? null : pal;
            } else {
              parentState.parent2 = alreadySelected ? null : pal;
            }
            updateBreedingSelection();
            updateParentGrids();
            updateResult();
          });
          grid.appendChild(card);
        });
      }

      function updateParentGrids() {
        renderParentGrid('parent1');
        renderParentGrid('parent2');
      }

      function renderBabyGrid() {
        babyGrid.innerHTML = '';
        if (!palsSorted.length) {
          babyGrid.appendChild(makeEmptyMessage(kidMode ? 'Loading pals…' : 'Breeding data is still loading.'));
          return;
        }
        let matches = filterPals(babySearch.value);
        if (selectedBaby && !matches.some(p => p.id === selectedBaby.id)) {
          matches = [selectedBaby, ...matches];
        }
        if (!matches.length) {
          babyGrid.appendChild(makeEmptyMessage(kidMode ? 'No pals match that search.' : 'Try a different pal search.'));
          return;
        }
        matches.forEach(pal => {
          const card = createPalCard(pal, {
            compact: true,
            selectable: true,
            selected: selectedBaby && selectedBaby.id === pal.id
          });
          card.addEventListener('click', () => {
            if (selectedBaby && selectedBaby.id === pal.id) {
              selectedBaby = null;
            } else {
              selectedBaby = pal;
            }
            updateBreedingSelection();
            renderBabyGrid();
            showCombos();
          });
          babyGrid.appendChild(card);
        });
      }

      function showCombos() {
        combosContainer.innerHTML = '';
        if (!selectedBaby) {
          combosContainer.appendChild(makeEmptyMessage(kidMode ? 'Pick a pal above to see recipes.' : 'Select a pal to see which parents can produce it.'));
          return;
        }
        const header = document.createElement('div');
        header.className = 'breeding-baby-header';
        const heading = document.createElement('h3');
        heading.textContent = kidMode ? `Make ${selectedBaby.name}` : `Parent combos for ${selectedBaby.name}`;
        header.appendChild(heading);
        header.appendChild(createPalCard(selectedBaby, { compact: true, selectable: false }));
        combosContainer.appendChild(header);
        const combos = Array.isArray(selectedBaby.breedingCombos) ? selectedBaby.breedingCombos : [];
        if (!combos.length) {
          combosContainer.appendChild(makeEmptyMessage(kidMode ? 'No combos known yet.' : 'We do not have recorded breeding pairs for this pal yet.'));
          return;
        }
        combos.forEach(pair => {
          if (!Array.isArray(pair) || pair.length < 2) return;
          const [leftName, rightName] = pair;
          const leftPalId = PAL_NAME_TO_ID[leftName];
          const rightPalId = PAL_NAME_TO_ID[rightName];
          const leftPal = leftPalId ? PALS[leftPalId] : null;
          const rightPal = rightPalId ? PALS[rightPalId] : null;
          const row = document.createElement('div');
          row.className = 'breeding-combo';
          row.appendChild(createComboCard(leftPal, leftName));
          const plus = document.createElement('div');
          plus.className = 'combo-arrow';
          plus.textContent = '+';
          row.appendChild(plus);
          row.appendChild(createComboCard(rightPal, rightName));
          const arrow = document.createElement('div');
          arrow.className = 'combo-arrow';
          arrow.textContent = '→';
          row.appendChild(arrow);
          row.appendChild(createPalCard(selectedBaby, { compact: true, selectable: false }));
          row.addEventListener('click', () => {
            if (leftPal) parentState.parent1 = leftPal;
            if (rightPal) parentState.parent2 = rightPal;
            updateBreedingSelection();
            updateParentGrids();
            updateResult();
            switchBreedingMode('breedingPredict');
            playSound(clickSound);
          });
          combosContainer.appendChild(row);
        });
      }

      function findPredictedBaby() {
        if (!parentState.parent1 || !parentState.parent2) return null;
        const power1 = parentState.parent1.breeding && typeof parentState.parent1.breeding.power === 'number'
          ? parentState.parent1.breeding.power
          : 0;
        const power2 = parentState.parent2.breeding && typeof parentState.parent2.breeding.power === 'number'
          ? parentState.parent2.breeding.power
          : 0;
        const avgPower = Math.floor((power1 + power2) / 2);
        let closest = null;
        let diff = Infinity;
        Object.values(PALS).forEach(p => {
          const power = p.breeding && typeof p.breeding.power === 'number' ? p.breeding.power : 0;
          const delta = Math.abs(power - avgPower);
          if (delta < diff) {
            diff = delta;
            closest = p;
          }
        });
        return { baby: closest, avgPower };
      }

      function updateResult() {
        result.innerHTML = '';
        if (!parentState.parent1 || !parentState.parent2) {
          result.appendChild(makeEmptyMessage(kidMode ? 'Pick two pals to guess the baby.' : 'Select two parents to see the likely offspring.'));
          return;
        }
        const prediction = findPredictedBaby();
        const baby = prediction ? prediction.baby : null;
        const avgPower = prediction ? prediction.avgPower : 0;
        const flow = document.createElement('div');
        flow.className = 'breeding-flow';
        flow.appendChild(createPalCard(parentState.parent1, { compact: true, selectable: false }));
        const plus = document.createElement('div');
        plus.className = 'combo-arrow';
        plus.textContent = '+';
        flow.appendChild(plus);
        flow.appendChild(createPalCard(parentState.parent2, { compact: true, selectable: false }));
        const arrow = document.createElement('div');
        arrow.className = 'combo-arrow';
        arrow.textContent = '→';
        flow.appendChild(arrow);
        if (baby) {
          flow.appendChild(createPalCard(baby, { compact: true, selectable: false }));
        } else {
          const placeholder = document.createElement('div');
          placeholder.classList.add('empty-state');
          placeholder.textContent = kidMode ? 'Unknown baby' : 'No matching baby yet';
          flow.appendChild(placeholder);
        }
        result.appendChild(flow);
        const tip = document.createElement('p');
        tip.className = 'breeding-tip';
        if (baby) {
          const babyPower = baby && baby.breeding && typeof baby.breeding.power === 'number' ? baby.breeding.power : 'Unknown';
          tip.innerHTML = kidMode
            ? `This pair is most likely to make <strong>${baby.name}</strong>. Pop a Cake into the box before you leave.`
            : `The parents average to breeding power ${avgPower}. That lines up closest with <strong>${baby.name}</strong> (Power ${babyPower}). Drop a Cake in the box to start incubation.`;
          result.appendChild(tip);
          const combosBtn = document.createElement('button');
          combosBtn.type = 'button';
          combosBtn.className = 'breeding-combo-link';
          combosBtn.textContent = kidMode ? 'Show how to make this pal' : 'See breeding combinations';
          combosBtn.addEventListener('click', () => {
            if (!baby) return;
            selectedBaby = baby;
            updateBreedingSelection();
            babySearch.value = '';
            renderBabyGrid();
            showCombos();
            switchBreedingMode('breedingDiscover');
            playSound(clickSound);
          });
          result.appendChild(combosBtn);
        } else {
          tip.textContent = kidMode ? 'We do not know the baby for this pair yet.' : 'We could not find a pal that matches this breeding power. Try another combination!';
          result.appendChild(tip);
        }
      }

      function switchBreedingMode(targetId) {
        modes.forEach(mode => {
          mode.classList.toggle('active', mode.id === targetId);
        });
        modeButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.target === targetId);
        });
        BREEDING_SELECTION.mode = targetId;
      }

      const savedMode = BREEDING_SELECTION.mode || 'breedingPredict';
      const availableModes = modes.map(mode => mode.id);
      const initialMode = availableModes.includes(savedMode) ? savedMode : 'breedingPredict';

      modeButtons.forEach(btn => {
        btn.onclick = () => {
          const target = btn.dataset.target;
          switchBreedingMode(target);
          playSound(clickSound);
        };
      });

      parent1Search.oninput = () => renderParentGrid('parent1');
      parent2Search.oninput = () => renderParentGrid('parent2');
      babySearch.oninput = () => renderBabyGrid();

      updateParentGrids();
      renderBabyGrid();
      showCombos();
      updateResult();
      switchBreedingMode(initialMode);
      updateBreedingSelection();
    }

    // Home page builder.  Displays large action cards and a rotating
    // suggested pal for tonight.  The cards encourage players to
    // catch a pal, fight a boss or build something new.  In grown‑up
    // mode the suggestions include more context like recommended
    // work types or where to find the boss.
    function buildHomePage() {
      const home = document.getElementById('homeCards');
      if (!home) return;
      home.innerHTML = '';
      // Define the three core actions.  Each entry can include an
      // icon (Font Awesome class), title and description.  Later we
      // could wire these cards to jump to the relevant page.
      const actions = [
        { icon: 'fa-paw', title: 'Catch a Pal', desc: 'Find a new pal to join your team', onClick: () => switchPage('pals') },
        { icon: 'fa-helmet-battle', title: 'Fight a Boss', desc: 'Prepare for your next tower battle', onClick: () => switchPage('route') },
        { icon: 'fa-hammer', title: 'Build Something', desc: 'Craft gear or structures to improve your base', onClick: () => switchPage('tech') }
      ];
      actions.forEach(act => {
        const card = document.createElement('div');
        card.className = 'pal-card';
        card.innerHTML = `<i class="fa-solid ${act.icon}" style="font-size:48px;margin-bottom:8px;color:var(--accent)"></i><div class="name">${act.title}</div><div style="font-size:0.9rem;color:var(--light);">${act.desc}</div>`;
        card.addEventListener('click', () => {
          act.onClick();
          playSound(clickSound);
        });
        home.appendChild(card);
      });
      // Add a rotating suggested pal card.  Choose a pal at random
      // whose rarity is low (≤3) to ensure early accessibility.  If
      // none exist, just pick a random pal.  The suggestion hints at
      // the pal’s best work or battle roles.
      const palsArray = Object.values(PALS);
      let candidates = palsArray.filter(p => p.rarity <= 3);
      if (!candidates.length) candidates = palsArray;
      const suggestion = candidates[Math.floor(Math.random() * candidates.length)];
      const sugCard = document.createElement('div');
      sugCard.className = 'pal-card';
      sugCard.innerHTML = `<img src="${suggestion.localImage || iconMap[suggestion.types[0]]}" alt="${suggestion.name}" style="width:100px;height:100px;"><div class="name">Try ${suggestion.name}!</div><div style="font-size:0.85rem;color:var(--light);">${kidMode ? 'Great pal for early game' : 'Rarity: ' + rarityNames[Math.max(1,Math.min(suggestion.rarity||0,6))]}</div>`;
      sugCard.addEventListener('click', () => {
        showPalDetail(suggestion.id);
        playSound(clickSound);
      });
      home.appendChild(sugCard);
    }

    const ROUTE_STORAGE_KEY = 'palmarathon:route:v1';
    let routeGuideData = null;
    let routeState = loadRouteState();
    let routeHideOptional = false;

    function rebuildTechLookup(){
      TECH_LOOKUP = {};
      (Array.isArray(TECH) ? TECH : []).forEach(level => {
        if(!level || !Array.isArray(level.items)) return;
        level.items.forEach(item => {
          if(!item) return;
          const identifiers = [];
          if(item.id) identifiers.push(item.id);
          if(item.name) identifiers.push(item.name);
          identifiers.forEach(identifier => {
            const slug = slugifyForPalworld(String(identifier));
            if(slug){
              TECH_LOOKUP[slug] = { item, level };
            }
          });
        });
      });
    }

    function ensureRouteGuide(){
      if(routeGuideData){
        return Promise.resolve(routeGuideData);
      }
      return fetch('data/route.chapters.json')
        .then(res => {
          if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
          return res.json();
        })
        .then(json => {
          routeGuideData = json;
          return routeGuideData;
        })
        .catch(err => {
          console.error('Failed to load route guide', err);
          routeGuideData = { chapters: [] };
          return routeGuideData;
        });
    }

    function renderRouteGuide(){
      ensureRouteGuide().then(guide => {
        const node = document.getElementById('routePage');
        if(!node) return;
        const chapters = Array.isArray(guide.chapters) ? guide.chapters : [];
        if(!chapters.length){
          node.innerHTML = '<section class="card"><h2>Boss Route & Progress</h2><p>Route data unavailable.</p></section>';
          return;
        }
        routeState = loadRouteState();
        node.innerHTML = `
          <section class="card">
            <h2>Boss Route & Progress</h2>
            <p>Work through each chapter. Check off steps as you do them. <em>Optional</em> steps don’t block completion.</p>
            <div class="badges" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <button class="btn" id="toggleOptional">${routeHideOptional ? 'Show Optional' : 'Hide Optional'}</button>
              <button class="btn" id="resetAll">Reset All</button>
            </div>
          </section>
          <div id="routeChapters"></div>
        `;
        const wrap = node.querySelector('#routeChapters');
        chapters.forEach((ch, idx) => {
          wrap.appendChild(renderChapterCard(ch, idx === 0));
        });

        wrap.addEventListener('change', handleRouteCheckboxChange);
        wrap.addEventListener('click', handleRouteClick);

        const toggleBtn = node.querySelector('#toggleOptional');
        if(toggleBtn){
          toggleBtn.onclick = () => {
            routeHideOptional = !routeHideOptional;
            toggleBtn.textContent = routeHideOptional ? 'Show Optional' : 'Hide Optional';
            chapters.forEach(ch => rerenderChapter(ch));
          };
        }
        const resetAll = node.querySelector('#resetAll');
        if(resetAll){
          resetAll.onclick = () => {
            if(confirm('Reset ALL progress?')){
              localStorage.removeItem(ROUTE_STORAGE_KEY);
              routeState = {};
              renderRouteGuide();
            }
          };
        }
      });
    }

    function renderChapterCard(chapter, openByDefault){
      const section = document.createElement('section');
      section.className = 'card';
      section.id = `chapter-${chapter.id}`;
      const progress = chapterProgress(chapter);
      section.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
          <div>
            <h3 style="margin:0">${escapeHTML(chapter.title)}</h3>
            <p style="margin:.25rem 0;color:var(--muted)">${escapeHTML(chapter.why)}</p>
          </div>
          <div style="min-width:220px">${renderProgress(progress)}</div>
        </div>
        <details ${openByDefault ? 'open' : ''}>
          <summary class="btn" style="margin-top:8px">Open steps</summary>
          ${renderSteps(chapter)}
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" data-action="markRequired" data-ch="${chapter.id}">Mark Required Complete</button>
            <button class="btn" data-action="resetChapter" data-ch="${chapter.id}">Reset Chapter</button>
            ${progress.requiredDone ? '<span style="margin-left:auto">✅ Chapter Complete</span>' : ''}
          </div>
        </details>
      `;
      return section;
    }

    function rerenderChapter(chapter){
      const node = document.querySelector(`#chapter-${chapter.id}`);
      if(!node) return;
      const wasOpen = node.querySelector('details')?.open;
      const progress = chapterProgress(chapter);
      node.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
          <div>
            <h3 style="margin:0">${escapeHTML(chapter.title)}</h3>
            <p style="margin:.25rem 0;color:var(--muted)">${escapeHTML(chapter.why)}</p>
          </div>
          <div style="min-width:220px">${renderProgress(progress)}</div>
        </div>
        <details ${wasOpen ? 'open' : ''}>
          <summary class="btn" style="margin-top:8px">Open steps</summary>
          ${renderSteps(chapter)}
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" data-action="markRequired" data-ch="${chapter.id}">Mark Required Complete</button>
            <button class="btn" data-action="resetChapter" data-ch="${chapter.id}">Reset Chapter</button>
            ${progress.requiredDone ? '<span style="margin-left:auto">✅ Chapter Complete</span>' : ''}
          </div>
        </details>
      `;
    }

    function handleRouteCheckboxChange(event){
      const target = event.target;
      if(!target.matches('input[type="checkbox"][data-step]')) return;
      const stepId = target.dataset.step;
      routeState[stepId] = target.checked;
      saveRouteState(routeState);
      const chapterNode = target.closest('section.card');
      if(!chapterNode) return;
      const chapterId = chapterNode.id.replace('chapter-','');
      const chapter = (routeGuideData?.chapters || []).find(ch => ch.id === chapterId);
      if(chapter){
        rerenderChapter(chapter);
      }
    }

    function handleRouteClick(event){
      const link = event.target.closest('[data-link]');
      if(link){
        const payload = JSON.parse(link.dataset.link);
        navigateLink(payload);
        event.preventDefault();
        return;
      }
      const btn = event.target.closest('button[data-action]');
      if(!btn) return;
      const chapterId = btn.dataset.ch;
      const chapter = (routeGuideData?.chapters || []).find(ch => ch.id === chapterId);
      if(!chapter) return;
      if(btn.dataset.action === 'markRequired'){
        chapter.steps.filter(step => !step.optional).forEach(step => {
          routeState[step.id] = true;
        });
        saveRouteState(routeState);
        rerenderChapter(chapter);
      } else if(btn.dataset.action === 'resetChapter'){
        chapter.steps.forEach(step => {
          delete routeState[step.id];
        });
        saveRouteState(routeState);
        rerenderChapter(chapter);
      }
    }

    function renderSteps(chapter){
      const groups = { Base: [], Gear: [], Tech: [], Catch: [], Prep: [], Explore: [], Boss: [] };
      (chapter.steps || []).forEach(step => {
        if(routeHideOptional && step.optional) return;
        const checked = !!routeState[step.id];
        if(!groups[step.category]){
          groups[step.category] = [];
        }
        groups[step.category].push(`
          <label class="step ${step.optional ? 'optional' : ''}">
            <input type="checkbox" data-step="${step.id}" ${checked ? 'checked' : ''} />
            <span class="step-text">${escapeHTML(step.text)} ${step.optional ? '<em>(Optional)</em>' : ''}</span>
            ${renderLinks(step.links || [])}
          </label>
        `);
      });
      return Object.entries(groups)
        .filter(([, items]) => items.length)
        .map(([category, items]) => `
          <div class="step-group">
            <h4>${category}</h4>
            ${items.join('')}
          </div>
        `)
        .join('');
    }

    function chapterProgress(chapter){
      const required = (chapter.steps || []).filter(step => !step.optional);
      const requiredChecked = required.filter(step => routeState[step.id]).length;
      return {
        requiredCount: required.length,
        requiredChecked,
        requiredDone: required.length > 0 && requiredChecked === required.length
      };
    }

    function renderProgress(progress){
      const pct = progress.requiredCount ? Math.round((progress.requiredChecked / progress.requiredCount) * 100) : 0;
      return `
        <div class="progress" aria-label="Chapter progress" style="display:grid;gap:6px">
          <div style="height:10px;border-radius:999px;background:#22314A;overflow:hidden">
            <div style="height:10px;width:${pct}%;background:var(--accent)"></div>
          </div>
          <div style="font-size:.9rem;color:var(--muted)">${progress.requiredChecked}/${progress.requiredCount} required done (${pct}%)</div>
        </div>
      `;
    }

    function renderLinks(links){
      if(!links || !links.length) return '';
      return `<span class="badges">${links.map(link => {
        const payload = JSON.stringify(link).replace(/"/g, '&quot;');
        return `<a href="#" class="chip link" data-link="${payload}" role="button">${escapeHTML(linkLabel(link))}</a>`;
      }).join('')}</span>`;
    }

    function linkLabel(link){
      if(link.type === 'pal') return capitalize(link.slug);
      if(link.type === 'passive') return capitalize(link.id);
      if(link.type === 'move') return niceName(link.id);
      if(link.type === 'tech') return niceName(link.id);
      if(link.type === 'glossary') return niceName(link.id);
      if(link.type === 'tower') return niceName(link.id);
      return 'Open';
    }

    function navigateLink(link){
      if(!link) return;
      if(link.type === 'pal'){
        if(window.viewPal){
          window.viewPal(link.slug || link.id);
        } else {
          focusSearch(link.slug || link.id);
        }
      } else if(link.type === 'tech'){
        showTechDetail(link.id);
      } else if(link.type === 'passive'){
        showTraitDetail(capitalize(link.id));
      } else if(link.type === 'move'){
        showSkillDetail(link.id);
      } else if(link.type === 'glossary'){
        showGlossaryDetail(link.id);
      } else if(link.type === 'tower'){
        openTowerMap(link);
      }
    }

    function showTechDetail(techId){
      if(!techId) return;
      const slug = slugifyForPalworld(String(techId));
      const entry = TECH_LOOKUP[slug];
      const displayName = entry?.item?.name || niceName(techId);
      const safeName = escapeHTML(displayName);
      const searchUrl = `${PALWORLD_BASE_URL}/items?search=${encodeURIComponent(displayName)}`;
      const summaryParts = [];
      if(kidMode){
        summaryParts.push(`<p>Let's get <strong>${safeName}</strong> ready!</p>`);
      } else {
        summaryParts.push(`<p><strong>${safeName}</strong> quick reference.</p>`);
      }
      if(entry?.level?.level){
        summaryParts.push(`<p><strong>Tech Level:</strong> ${escapeHTML(String(entry.level.level))}</p>`);
      }
      if(entry?.item?.techPoints){
        summaryParts.push(`<p><strong>Tech Points Cost:</strong> ${escapeHTML(String(entry.item.techPoints))}</p>`);
      }
      if(entry?.item?.materials && Object.keys(entry.item.materials).length){
        const materials = Object.entries(entry.item.materials)
          .map(([material, qty]) => `<li>${escapeHTML(`${qty} × ${material}`)}</li>`)
          .join('');
        if(materials){
          summaryParts.push(`<p>${kidMode ? 'You will need:' : 'Materials required:'}</p><ul>${materials}</ul>`);
        }
      }
      if(entry?.item?.description){
        summaryParts.push(`<p>${escapeHTML(entry.item.description)}</p>`);
      } else if(entry){
        summaryParts.push(`<p>${kidMode
          ? 'Check the Palworld.gg window for a picture and placement tips once you unlock it.'
          : 'Use the Palworld.gg panel for placement notes and unlock requirements.'}</p>`);
      } else {
        summaryParts.push(`<p>${kidMode
          ? 'Palmate will peek at Palworld.gg so you can see what it looks like without leaving this checklist.'
          : 'Palmate opens a Palworld.gg search so you can confirm crafting details without changing pages.'}</p>`);
      }
      const note = entry
        ? 'Palmate keeps this tech guide handy so you can stay on the route checklist.'
        : 'Palmate opens a Palworld.gg search while keeping your route progress on screen.';
      openPalworldEmbed({
        heading: `${displayName} – Palworld.gg`,
        url: searchUrl,
        fallbackUrl: searchUrl,
        note,
        summaryHtml: summaryParts.join('')
      });
    }

    function showGlossaryDetail(identifier){
      if(!identifier) return;
      const key = String(identifier).toLowerCase();
      const entry = ROUTE_GLOSSARY_SUMMARIES[key];
      const displayName = entry?.title || niceName(identifier);
      const url = entry?.url || `${PALWORLD_BASE_URL}/items?search=${encodeURIComponent(displayName)}`;
      const note = entry?.note || 'Palmate keeps this glossary entry in a modal so you never lose your place.';
      const lines = entry
        ? (kidMode ? entry.kid : entry.grown)
        : [kidMode
          ? `Let's learn about ${displayName}. Palworld.gg will open beside your checklist so you can keep exploring.`
          : `Palmate is opening a Palworld.gg search for ${displayName} so you can review it without leaving the route.`];
      const summaryHtml = lines.map(text => `<p>${escapeHTML(text)}</p>`).join('');
      openPalworldEmbed({
        heading: `${displayName} – Palworld.gg`,
        url,
        fallbackUrl: url,
        note,
        summaryHtml
      });
    }

    window.showTechDetail = showTechDetail;
    window.showGlossaryDetail = showGlossaryDetail;

    function pulse(el){
      el.classList.add('pulse');
      setTimeout(() => el.classList.remove('pulse'), 1500);
    }

    function focusSearch(term){
      const input = document.getElementById('palSearch') || document.getElementById('itemSearch');
      if(input){
        input.value = term;
        input.dispatchEvent(new Event('input', { bubbles: true }));
      }
    }

    function loadRouteState(){
      try {
        return JSON.parse(localStorage.getItem(ROUTE_STORAGE_KEY)) || {};
      } catch(err){
        console.warn('Failed to load route progress', err);
        return {};
      }
    }

    function saveRouteState(state){
      localStorage.setItem(ROUTE_STORAGE_KEY, JSON.stringify(state));
    }

    function escapeHTML(str){
      return (str || '').replace(/[&<>"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch] || ch));
    }

    function capitalize(value){
      return (value || '').replace(/(^|[-_])\w/g, m => m.toUpperCase()).replace(/[-_]/g, ' ');
    }

    function niceName(id){
      return capitalize(String(id).replace(/_/g, ' '));
    }
    // with their descriptions.  Elements and work suitabilities are
    // summarised in simple tables.  Clicking a passive or move
    // shows more detail in a modal using the existing functions.
    function buildGlossaryPage() {
      const container = document.getElementById('glossaryContent');
      if (!container) return;
      container.innerHTML = '';
      // Build passives list
      const passivesSection = document.createElement('div');
      passivesSection.className = 'card';
      passivesSection.innerHTML = '<h3>Passive Skills</h3>';
      const passiveWrap = document.createElement('div');
      passiveWrap.className = 'badges';
      Object.keys(traitsDictionary).sort().forEach(trait => {
        const id = slugifyForPalworld(trait);
        const btn = document.createElement('button');
        btn.className = 'chip passive';
        btn.dataset.trait = trait;
        btn.id = id ? `passive-${id}` : '';
        btn.title = traitsDictionary[trait];
        btn.textContent = trait;
        passiveWrap.appendChild(btn);
      });
      passivesSection.appendChild(passiveWrap);
      container.appendChild(passivesSection);
      // Build moves list (only first 30 for brevity)
      const movesSection = document.createElement('div');
      movesSection.className = 'card';
      movesSection.innerHTML = '<h3>Active Skills</h3>';
      const movesWrap = document.createElement('div');
      movesWrap.className = 'badges';
      const moveKeys = Object.keys(skillsDictionary);
      moveKeys.sort().slice(0, 30).forEach(key => {
        const info = skillsDictionary[key];
        const btn = document.createElement('button');
        btn.className = 'chip move';
        btn.dataset.skill = key;
        btn.id = `move-${slugifyForPalworld(key)}`;
        btn.textContent = info.name || key;
        movesWrap.appendChild(btn);
      });
      movesSection.appendChild(movesWrap);
      if (moveKeys.length > 30) {
        const more = document.createElement('p');
        more.innerHTML = `...and ${moveKeys.length - 30} more skills. Use search or view pals for full list.`;
        movesSection.appendChild(more);
      }
      container.appendChild(movesSection);
      // Elements table
      const elemSection = document.createElement('div');
      elemSection.innerHTML = '<h3>Elements & Type Chart</h3>';
      const elemTable = document.createElement('table');
      elemTable.style.width = '100%';
      elemTable.style.borderCollapse = 'collapse';
      const types = ['Neutral','Fire','Water','Grass','Electric','Ice','Ground','Dragon','Dark','Air'];
      elemTable.innerHTML = `<tr><th>Element</th><th>Strong Against</th><th>Weak Against</th></tr>`;
      const strengths = {
        Fire: 'Grass, Ice',
        Water: 'Fire, Ground',
        Grass: 'Water, Ground',
        Electric: 'Water, Air',
        Ice: 'Dragon, Grass',
        Ground: 'Electric, Fire',
        Dragon: 'Dark, Dragon',
        Dark: 'Neutral',
        Air: 'Grass, Ground',
        Neutral: 'None'
      };
      const weaknesses = {
        Fire: 'Water, Ground',
        Water: 'Electric, Grass',
        Grass: 'Fire, Ice, Air',
        Electric: 'Ground',
        Ice: 'Fire, Electric',
        Ground: 'Water, Grass',
        Dragon: 'Dragon, Ice',
        Dark: 'Dragon',
        Air: 'Electric, Ice',
        Neutral: 'None'
      };
      types.forEach(t => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${t}</td><td>${strengths[t] || 'Unknown'}</td><td>${weaknesses[t] || 'Unknown'}</td>`;
        elemTable.appendChild(row);
      });
      elemSection.appendChild(elemTable);
      container.appendChild(elemSection);
      // Work suitabilities legend
      const workSection = document.createElement('div');
      workSection.innerHTML = '<h3>Work Suitabilities</h3>';
      const suits = ['Kindling','Watering','Planting','Electricity','Handiwork','Gathering','Lumbering','Mining','Medicine','Cooling','Transporting','Farming'];
      const ul = document.createElement('ul');
      suits.forEach(s => {
        const li = document.createElement('li');
        li.textContent = `${s} – useful for base tasks like ${s.toLowerCase()}.`;
        ul.appendChild(li);
      });
      workSection.appendChild(ul);
      container.appendChild(workSection);
      // Click handlers for glossary links
      container.addEventListener('click', (e) => {
        const passiveBtn = e.target.closest('.chip.passive');
        if (passiveBtn) {
          e.preventDefault();
          const trait = passiveBtn.dataset.trait;
          showTraitDetail(trait);
          return;
        }
        const moveBtn = e.target.closest('.chip.move');
        if (moveBtn) {
          e.preventDefault();
          const key = moveBtn.dataset.skill;
          showSkillDetail(key);
        }
      });
    }

    // Map page builder.  Creates toggles for different layers and
    // instructions to open the external interactive map.  We do not
    // re‑host community map tiles; instead we encourage opening
    // palworld.gg with the appropriate filters.  A simple overlay is
    // available via environment highlights but hidden by default.
    function buildMapPage() {
      const layers = document.getElementById('mapLayers');
      if (!layers) return;
      layers.innerHTML = '';
      const categories = [
        { name: 'Pals', desc: 'See spawn locations on the external map', url: 'https://palworld.gg/map' },
        { name: 'Alpha Pals', desc: 'Locate strong alpha variants', url: 'https://palworld.gg/map' },
        { name: 'Towers', desc: 'Find tower bosses and fast travel points', url: 'https://palworld.gg/map' },
        { name: 'Dungeons', desc: 'Open map to see dungeon entrances', url: 'https://palworld.gg/map' },
        { name: 'Effigies', desc: 'Locate Lifmunk Effigies for free levels', url: 'https://palworld.gg/map' },
        { name: 'Skill Fruit Trees', desc: 'Find Skill Fruit trees to learn moves', url: 'https://palworld.gg/map' },
        { name: 'Fast Travel', desc: 'Discover fast travel statues', url: 'https://palworld.gg/map' }
      ];
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'collect-btn';
        btn.style.margin = '4px';
        btn.textContent = cat.name;
        btn.addEventListener('click', () => {
          window.open(cat.url, '_blank');
        });
        layers.appendChild(btn);
      });
    }
    function buildProgressPage() {
      const section = document.querySelector('#progressPage .progress-section');
      if (!section) return;
      let summary = document.getElementById('progressSummary');
      if (!summary) {
        summary = document.createElement('div');
        summary.id = 'progressSummary';
        summary.style.marginTop = '12px';
        summary.style.fontSize = '0.85rem';
        summary.innerHTML = `
          <div id="palsProgressText" class="progress-text"></div>
          <div id="itemsProgressText" class="progress-text"></div>
          <div id="techProgressText" class="progress-text"></div>
        `;
        section.appendChild(summary);
      }
    }
    // Update progress bars
    function updateProgressUI() {
      const totalPals = Object.keys(PALS).length;
      const caughtCount = Object.keys(caught).filter(k => caught[k]).length;
      const palsBar = document.getElementById('palsProgress');
      if (palsBar) palsBar.style.width = (totalPals ? (caughtCount / totalPals) * 100 : 0) + '%';
      const palsText = document.getElementById('palsProgressText');
      if (palsText) palsText.textContent = `${caughtCount} / ${totalPals} pals caught`;
      const totalItems = Object.keys(ITEMS).length;
      const collectedCount = Object.keys(collected).filter(k => collected[k]).length;
      const itemsBar = document.getElementById('itemsProgress');
      if (itemsBar) itemsBar.style.width = (totalItems ? (collectedCount / totalItems) * 100 : 0) + '%';
      const itemsText = document.getElementById('itemsProgressText');
      if (itemsText) itemsText.textContent = `${collectedCount} / ${totalItems} items logged`;
      // Count tech recipes
      let totalRecipes = 0;
      TECH.forEach(lvl => { totalRecipes += lvl.items.length; });
      const unlockedCount = Object.keys(unlocked).filter(k => unlocked[k]).length;
      const techBar = document.getElementById('techProgress');
      if (techBar) techBar.style.width = (totalRecipes ? (unlockedCount / totalRecipes) * 100 : 0) + '%';
      const techText = document.getElementById('techProgressText');
      if (techText) techText.textContent = `${unlockedCount} / ${totalRecipes} tech recipes unlocked`;
    }

    // Display detailed information about an item using a Palworld-inspired card.
    function openItemDetail(itemKey) {
      const item = ITEMS[itemKey];
      if (!item) return;
      const detail = ITEM_DETAILS[itemKey] || {};
      const human = detail.name || humaniseItemKey(itemKey);
      const slug = PALWORLD_ITEM_SLUG_OVERRIDES[itemKey] || slugifyForPalworld(human);
      const itemUrl = slug ? `${PALWORLD_BASE_URL}/item/${slug}` : `${PALWORLD_BASE_URL}/items`;
      const fallbackUrl = `${PALWORLD_BASE_URL}/items?search=${encodeURIComponent(human)}`;
      const drops = (DROPS_MAP[itemKey] || []).slice();
      const collectedStatus = !!collected[itemKey];
      const recipes = [];
      TECH.forEach(level => {
        level.items.forEach(it => {
          if (it.materials && it.materials[itemKey]) {
            recipes.push({ name: it.name, qty: it.materials[itemKey], level: level.level });
          }
        });
      });
      modalBody.innerHTML = '';
      const card = document.createElement('article');
      card.className = 'item-detail-card';

      const header = document.createElement('div');
      header.className = 'item-detail-header';
      const headingWrap = document.createElement('div');
      headingWrap.className = 'item-detail-heading';
      const art = document.createElement('div');
      art.className = 'item-detail-image';
      if (detail.image) {
        const img = document.createElement('img');
        img.src = detail.image;
        img.alt = human;
        img.loading = 'lazy';
        art.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'item-detail-placeholder';
        placeholder.innerHTML = '<i class="fa-solid fa-box"></i>';
        art.appendChild(placeholder);
      }
      const meta = document.createElement('div');
      meta.className = 'item-detail-meta';
      const titleEl = document.createElement('h3');
      titleEl.textContent = human;
      const typeEl = document.createElement('span');
      const typeLabel = detail.type || item.category || 'Item';
      typeEl.className = 'type-tag';
      typeEl.textContent = typeLabel;
      meta.appendChild(titleEl);
      meta.appendChild(typeEl);
      headingWrap.appendChild(art);
      headingWrap.appendChild(meta);
      header.appendChild(headingWrap);
      const collectBtn = document.createElement('button');
      collectBtn.className = `detail-collect-btn${collectedStatus ? ' collected' : ''}`;
      collectBtn.textContent = collectedStatus ? 'Collected' : 'Mark as collected';
      collectBtn.addEventListener('click', () => {
        collected[itemKey] = !collected[itemKey];
        localStorage.setItem('collected', JSON.stringify(collected));
        const state = !!collected[itemKey];
        collectBtn.classList.toggle('collected', state);
        collectBtn.textContent = state ? 'Collected' : 'Mark as collected';
        updateItemCollectionButtons(itemKey);
        updateProgressUI();
        playSound(clickSound);
      });
      header.appendChild(collectBtn);
      card.appendChild(header);

      const descriptionLines = Array.isArray(detail.description) && detail.description.length
        ? detail.description
        : [`${human} belongs to the ${item.category || typeLabel} family.`];
      const descWrapper = document.createElement('div');
      descWrapper.className = 'item-detail-description';
      const maxParagraphs = kidMode ? Math.min(2, descriptionLines.length) : descriptionLines.length;
      for (let idx = 0; idx < maxParagraphs; idx += 1) {
        const p = document.createElement('p');
        p.textContent = descriptionLines[idx];
        descWrapper.appendChild(p);
      }
      card.appendChild(descWrapper);

      const statsEntries = Object.entries(detail.stats || {});
      if (item.category && !statsEntries.some(entry => entry[0].toLowerCase() === 'category')) {
        statsEntries.push(['Category', item.category]);
      }
      if (statsEntries.length) {
        const statGrid = document.createElement('div');
        statGrid.className = 'item-detail-stats';
        statsEntries.forEach(([label, value]) => {
          const pill = document.createElement('div');
          pill.className = 'stat-pill';
          const labelSpan = document.createElement('span');
          labelSpan.className = 'label';
          labelSpan.textContent = label;
          const valueSpan = document.createElement('span');
          valueSpan.className = 'value';
          valueSpan.textContent = value;
          pill.appendChild(labelSpan);
          pill.appendChild(valueSpan);
          statGrid.appendChild(pill);
        });
        card.appendChild(statGrid);
      }

      const summarySection = document.createElement('section');
      summarySection.className = 'item-detail-section item-detail-summary';
      const summaryHeading = document.createElement('h4');
      summaryHeading.textContent = kidMode ? 'Quick Take' : 'Tracker Notes';
      summarySection.appendChild(summaryHeading);
      if (kidMode) {
        const dropPreview = drops.length ? drops.slice(0, 4).join(', ') + (drops.length > 4 ? '…' : '') : 'Not sure yet';
        const summaryLines = [
          `Status: ${collectedStatus ? 'We have this item!' : 'Let’s go find this!'}`,
          `Item type: ${typeLabel}`,
          `Find it from: ${dropPreview}`
        ];
        if (recipes.length) {
          summaryLines.push(`Used for: ${recipes.length} tech unlock${recipes.length === 1 ? '' : 's'}.`);
        }
        summaryLines.forEach(line => {
          const p = document.createElement('p');
          p.textContent = line;
          summarySection.appendChild(p);
        });
      } else {
        const summaryList = document.createElement('ul');
        const lines = [
          `Tracking status: ${collectedStatus ? 'Collected' : 'Not collected yet'}`,
          `Category: ${item.category || typeLabel}`,
          drops.length ? `Drops recorded: ${drops.length}` : 'Drops recorded: none yet',
          recipes.length ? `Tech unlocks: ${recipes.length} recipe${recipes.length === 1 ? '' : 's'} listed below.` : 'Tech unlocks: none recorded yet.'
        ];
        if (detail.fromPalworld === false) {
          lines.push('Data source: Palmate placeholder entry until Palworld.gg publishes more info.');
        } else {
          lines.push('Data source: Palworld.gg item compendium.');
        }
        lines.forEach(text => {
          const li = document.createElement('li');
          li.textContent = text;
          summaryList.appendChild(li);
        });
        summarySection.appendChild(summaryList);
      }
      card.appendChild(summarySection);

      const dropSection = document.createElement('section');
      dropSection.className = 'item-detail-section';
      const dropHeading = document.createElement('h4');
      dropHeading.textContent = 'Dropped by';
      dropSection.appendChild(dropHeading);
      if (drops.length) {
        const dropList = document.createElement('div');
        dropList.className = 'chip-list';
        const limit = kidMode ? Math.min(6, drops.length) : drops.length;
        drops.slice(0, limit).forEach((name, index) => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          if (index === 0) chip.classList.add('highlight');
          chip.textContent = name;
          dropList.appendChild(chip);
        });
        if (drops.length > limit) {
          const more = document.createElement('span');
          more.className = 'chip';
          more.textContent = `+${drops.length - limit} more`;
          dropList.appendChild(more);
        }
        dropSection.appendChild(dropList);
      } else {
        const none = document.createElement('p');
        none.textContent = 'No pals are confirmed to drop this item yet.';
        dropSection.appendChild(none);
      }
      card.appendChild(dropSection);

      if (Array.isArray(detail.recipe) && detail.recipe.length) {
        const recipeSection = document.createElement('section');
        recipeSection.className = 'item-detail-section';
        const recipeHeading = document.createElement('h4');
        recipeHeading.textContent = 'Crafting recipe';
        recipeSection.appendChild(recipeHeading);
        const ingredientGrid = document.createElement('div');
        ingredientGrid.className = 'ingredient-grid';
        detail.recipe.forEach(entry => {
          const ingredientCard = document.createElement('div');
          ingredientCard.className = 'ingredient-card';
          if (entry.icon) {
            const img = document.createElement('img');
            img.src = entry.icon;
            img.alt = entry.name;
            img.loading = 'lazy';
            ingredientCard.appendChild(img);
          }
          const textWrap = document.createElement('div');
          textWrap.className = 'ingredient-text';
          const nameEl = document.createElement('div');
          nameEl.className = 'name';
          nameEl.textContent = entry.name;
          textWrap.appendChild(nameEl);
          if (entry.quantity) {
            const qty = document.createElement('div');
            qty.textContent = `x${entry.quantity}`;
            textWrap.appendChild(qty);
          }
          ingredientCard.appendChild(textWrap);
          ingredientGrid.appendChild(ingredientCard);
        });
        recipeSection.appendChild(ingredientGrid);
        card.appendChild(recipeSection);
      }

      if (recipes.length) {
        const techSection = document.createElement('section');
        techSection.className = 'item-detail-section';
        const techHeading = document.createElement('h4');
        techHeading.textContent = 'Used in tech';
        techSection.appendChild(techHeading);
        const techList = document.createElement('ul');
        const maxEntries = kidMode ? Math.min(5, recipes.length) : recipes.length;
        recipes.slice(0, maxEntries).forEach(recipe => {
          const li = document.createElement('li');
          li.textContent = `Level ${recipe.level}: ${recipe.name} (x${recipe.qty})`;
          techList.appendChild(li);
        });
        if (recipes.length > maxEntries) {
          const li = document.createElement('li');
          li.textContent = `+${recipes.length - maxEntries} more unlock${recipes.length - maxEntries === 1 ? '' : 's'} in higher tiers.`;
          techList.appendChild(li);
        }
        techSection.appendChild(techList);
        card.appendChild(techSection);
      }

      const footer = document.createElement('div');
      footer.className = 'item-detail-footer';
      const link = document.createElement('a');
      link.href = slug ? itemUrl : fallbackUrl;
      link.target = '_blank';
      link.rel = 'noopener';
      link.textContent = detail.fromPalworld === false ? 'Search on Palworld.gg' : 'View on Palworld.gg';
      footer.appendChild(link);
      const note = document.createElement('p');
      note.className = 'item-detail-note';
      note.textContent = detail.fromPalworld === false
        ? 'Palworld.gg has not published a full entry for this item yet. Details shown use Palmate data.'
        : 'Stats, art, and rarities mirror the Palworld.gg item database.';
      footer.appendChild(note);
      card.appendChild(footer);

      modalBody.appendChild(card);
      openModal();
    }

    // Show details about an active skill.  Looks up the skill in the
    // dictionary; if it’s missing we display a generic placeholder.
    function showSkillDetail(key) {
      const normalisedKey = key.toLowerCase().replace(/[\s-]+/g, '_');
      const info = skillsDictionary[normalisedKey] || skillsDictionary[key] || { name: key.replace(/_/g,' '), damage: 'Unknown', type: 'Unknown', description: 'This skill\'s effects are a mystery! Try it out in battle.' };
      modalBody.innerHTML = '';
      const div = document.createElement('div');
      div.innerHTML = `<h3>${info.name}</h3><p><strong>Damage:</strong> ${info.damage}</p><p><strong>Type:</strong> ${info.type}</p><p>${info.description}</p>`;
      modalBody.appendChild(div);
      openModal();
    }

    // Show details about a passive trait.  Retrieves the description
    // from the trait dictionary.  Unknown traits yield a default
    // explanation encouraging exploration.
    function showTraitDetail(name) {
      const desc = traitsDictionary[name] || 'This trait has mysterious effects that aren\'t fully documented. See how it behaves in-game!';
      modalBody.innerHTML = '';
      const div = document.createElement('div');
      div.innerHTML = `<h3>${name}</h3><p>${desc}</p>`;
      modalBody.appendChild(div);
      openModal();
    }
  </script>
</body>
</html>
